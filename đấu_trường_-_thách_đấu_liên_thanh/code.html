<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>LevelUp Kids - ƒê·∫•u Tr∆∞·ªùng Anh H√πng</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../shared/css/global.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../shared/js/state.js"></script>
    <script src="../shared/js/components.js" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b",
                        "primary-dark": "#d48215",
                        "arena-blue": "#3b82f6",
                        "arena-orange": "#f97316"
                    }
                }
            }
        }
    </script>
    <style>
        .gladiator-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark .gladiator-card {
            background: rgba(44, 34, 21, 0.95);
        }

        .gladiator-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px -8px rgba(0, 0, 0, 0.15);
        }

        .vs-badge {
            background: linear-gradient(135deg, #f97316 0%, #ee9d2b 100%);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4);
            }

            70% {
                box-shadow: 0 0 0 12px rgba(249, 115, 22, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
            }
        }

        .btn-done-pulse {
            animation: pulse-ring 1.5s ease-out infinite;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-enter {
            animation: slideInUp 0.4s ease-out forwards;
        }

        /* Drama Reveal Styles */
        .reveal-overlay-active {
            background: radial-gradient(circle, #2a2a2a 0%, #000 100%);
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes shake-intense {

            0%,
            100% {
                transform: rotate(0deg) scale(1);
            }

            10% {
                transform: rotate(-8deg) scale(1.1);
            }

            20% {
                transform: rotate(8deg) scale(1.2);
            }

            30% {
                transform: rotate(-12deg) scale(1.3);
            }

            40% {
                transform: rotate(12deg) scale(1.4);
            }

            50% {
                transform: rotate(0deg) scale(1.5);
            }
        }

        .chest-drama {
            animation: shake-intense 0.5s infinite;
            filter: drop-shadow(0 0 30px rgba(234, 179, 8, 0.6));
        }

        /* Result pop */
        .result-pop {
            animation: resultPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes resultPop {
            0% {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
            }

            70% {
                transform: scale(1.1) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        /* Infinite Progress Bar */
        @keyframes progress-infinite {
            0% {
                left: -40%;
                width: 40%;
            }

            50% {
                left: 40%;
                width: 60%;
            }

            100% {
                left: 100%;
                width: 40%;
            }
        }

        .progress-line {
            position: relative;
            height: 6px;
            width: 100%;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-line:after {
            content: '';
            position: absolute;
            height: 100%;
            background: #ee9d2b;
            animation: progress-infinite 2s infinite linear;
        }

        .opponent-list-scroll {
            scrollbar-width: thin;
            scrollbar-color: #ee9d2b transparent;
        }

        .opponent-list-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .opponent-list-scroll::-webkit-scrollbar-thumb {
            background-color: #ee9d2b;
            border-radius: 10px;
        }

        /* Power Flow Animation */
        @keyframes power-flow {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .power-bar-fill {
            background-size: 200% 100% !important;
            animation: power-flow 3s linear infinite;
        }

        /* Dominant Aura Effects */
        .dominant-blue {
            filter: drop-shadow(0 0 25px rgba(59, 130, 246, 0.8)) !important;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6) !important;
            animation: dominant-pulse-blue 1.5s infinite alternate !important;
        }

        .dominant-red {
            filter: drop-shadow(0 0 25px rgba(244, 63, 94, 0.8)) !important;
            box-shadow: 0 0 30px rgba(244, 63, 94, 0.6) !important;
            animation: dominant-pulse-red 1.5s infinite alternate !important;
        }

        @keyframes dominant-pulse-blue {
            from {
                transform: scale(1);
                filter: brightness(1);
            }

            to {
                transform: scale(1.05);
                filter: brightness(1.3);
            }
        }

        @keyframes dominant-pulse-red {
            from {
                transform: scale(1);
                filter: brightness(1);
            }

            to {
                transform: scale(1.05);
                filter: brightness(1.3);
            }
        }

        /* Dominant Bar Section */
        .bar-dominant {
            height: 150% !important;
            top: -25% !important;
            z-index: 10;
            filter: brightness(1.2) drop-shadow(0 0 15px currentColor);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4) inset;
        }

        /* Enhanced Commentary Slide for Grade 1 */
        .commentary-slide {
            animation: commentary-slide 40s linear infinite;
            /* Slower for kids */
            text-shadow: none !important;
            /* Remove blurry shadow */
            color: #475569;
            /* Clear slate color */
        }

        .dark .commentary-slide {
            color: #cbd5e1;
        }

        @keyframes commentary-slide {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(-100%);
            }
        }

        /* Lightning Bolt Float */
        @keyframes lightning-float {

            0%,
            100% {
                transform: translate(-50%, -50%) translateY(0) scale(1.2);
                filter: drop-shadow(0 0 8px yellow);
            }

            50% {
                transform: translate(-50%, -50%) translateY(-3px) scale(1.5);
                filter: drop-shadow(0 0 15px white);
            }
        }

        .lightning-bolt-vfx {
            animation: lightning-float 0.3s infinite;
        }

        .struggle-container {
            position: relative;
        }

        /* Dominant Energy Surge */
        .bar-dominant {
            height: 180% !important;
            top: -40% !important;
            z-index: 20;
            filter: brightness(1.3) drop-shadow(0 0 20px currentColor);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.6) inset;
            border-radius: 999px;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Static & Moving Bolt */
        /* Central Bolt Struggle (Internal Movement Only) */
        @keyframes bolt-struggle {
            0% {
                transform: translate(-50%, -50%) translateX(-15px) scale(1.2);
            }

            50% {
                transform: translate(-50%, -50%) translateX(15px) scale(1.4);
            }

            100% {
                transform: translate(-50%, -50%) translateX(-15px) scale(1.2);
            }
        }

        .bolt-moving {
            animation: bolt-struggle 3s ease-in-out infinite, lightning-float 0.3s infinite;
        }

        /* Grade 1 Friendly Ticker */
        .commentary-slide {
            animation: commentary-slide 45s linear infinite;
            text-shadow: none !important;
            font-weight: 900 !important;
            letter-spacing: 0.05em;
            color: #1e293b;
        }

        .dark .commentary-slide {
            color: #f1f5f9;
        }

        /* Screen Shake for Intensity */
        @keyframes battlefield-shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, 1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, -1px);
            }
        }

        .intense-battle {
            animation: battlefield-shake 0.2s infinite;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-[#1a140c] font-['Montserrat'] text-slate-800 dark:text-slate-200 min-h-screen flex flex-col">

    <!-- Sound Effects -->
    <audio id="snd-chest" src="https://assets.mixkit.co/active_storage/sfx/2042/2042-preview.mp3"
        preload="auto"></audio>
    <audio id="snd-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
    <audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"
        preload="auto"></audio>

    <app-header title="ƒê·∫•u Tr∆∞·ªùng" type="child"></app-header>

    <main class="flex-grow w-full max-w-[1200px] mx-auto p-4 md:p-8">

        <!-- Title Row (Scientifically Balanced) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center mb-12">
            <!-- Left: Title & Persona -->
            <div class="lg:col-span-8">
                <div class="flex items-center gap-4 mb-2">
                    <div
                        class="w-12 h-12 bg-arena-orange/20 rounded-2xl flex items-center justify-center text-arena-orange">
                        <span class="material-symbols-outlined text-3xl"
                            style="font-variation-settings:'FILL' 1">swords</span>
                    </div>
                    <h2
                        class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-black text-slate-800 dark:text-white uppercase italic tracking-tighter whitespace-nowrap">
                        ƒê·∫§U TR∆Ø·ªúNG <span class="text-arena-orange">ANH H√ôNG</span>
                    </h2>
                </div>
                <p id="welcome-text" class="text-slate-500 font-bold ml-16 text-sm md:text-base">ƒêang t·∫£i th√¥ng tin
                    chi·∫øn th·∫ßn...</p>
            </div>

            <!-- Right: Warrior Dashboard -->
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div
                    class="bg-white dark:bg-[#2c2215] rounded-[2.5rem] border-2 border-slate-100 dark:border-slate-800 p-2 shadow-sm">
                    <div class="grid grid-cols-2 divide-x divide-slate-100 dark:divide-slate-800">
                        <!-- Attack (Active) -->
                        <div class="px-4 py-3 flex flex-col items-center justify-center">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="material-symbols-outlined text-sm text-arena-orange">sword_rose</span>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">T·∫•n
                                    c√¥ng</span>
                            </div>
                            <span id="active-counter"
                                class="text-2xl font-black text-arena-orange leading-none">3/3</span>
                            <p class="text-[8px] font-bold text-slate-300 mt-1 uppercase">L∆∞·ª£t b√© ƒëi th√°ch</p>
                        </div>
                        <!-- Defense (Passive) -->
                        <div class="px-4 py-3 flex flex-col items-center justify-center">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="material-symbols-outlined text-sm text-blue-500">shield</span>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Ph√≤ng
                                    th·ªß</span>
                            </div>
                            <span id="passive-counter" class="text-2xl font-black text-blue-500 leading-none">3/3</span>
                            <p class="text-[8px] font-bold text-slate-300 mt-1 uppercase">L∆∞·ª£t ƒë∆∞·ª£c th√°ch</p>
                        </div>
                    </div>
                </div>

                <button id="btn-open-modal" onclick="openChallengeModal()"
                    class="group w-full bg-gradient-to-r from-arena-orange to-primary text-white px-8 py-5 rounded-[2rem] font-black shadow-lg hover:shadow-arena-orange/30 transition-all flex items-center justify-center gap-3 active:scale-95 text-lg">
                    <span
                        class="material-symbols-outlined text-2xl group-hover:rotate-90 transition-transform">swords</span>
                    T·∫†O K√àO M·ªöI
                </button>
            </div>
        </div>

        <!-- ======= YOUR ACTIVE CHALLENGES ======= -->
        <section class="mb-14">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-arena-blue/10 dark:bg-arena-blue/20 p-2 rounded-xl text-arena-blue">
                    <span class="material-symbols-outlined text-xl"
                        style="font-variation-settings:'FILL' 1">swords</span>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wider text-slate-700 dark:text-white">K√®o ƒêang ƒê·∫•u</h3>
                <span id="active-count"
                    class="bg-arena-orange text-white text-xs font-black px-2.5 py-1 rounded-full hidden">0</span>
            </div>
            <div id="active-challenges-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Loader or empty state -->
            </div>
        </section>

        <!-- ======= YOUR HISTORY ======= -->
        <section id="completed-section" class="hidden mb-14">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-green-500/10 dark:bg-green-500/20 p-2 rounded-xl text-green-500">
                    <span class="material-symbols-outlined text-xl"
                        style="font-variation-settings:'FILL' 1">history</span>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wider text-slate-700 dark:text-white">Chi·∫øn T√≠ch C·ªßa
                    B·∫°n</h3>
            </div>
            <div id="completed-challenges-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
        </section>

        <!-- ======= ARENA WORLD NEWS ======= -->
        <section class="border-t border-slate-200 dark:border-slate-800 pt-10">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-purple-500/10 dark:bg-purple-500/20 p-2 rounded-xl text-purple-500">
                    <span class="material-symbols-outlined text-xl">language</span>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wider text-slate-500 dark:text-slate-400">Tin T·ª©c ƒê·∫•u
                    Tr∆∞·ªùng</h3>
            </div>
            <div id="arena-news-list" class="space-y-3 opacity-60">
                <!-- News from other players -->
            </div>
        </section>
    </main>

    <!-- ================ REPORT MODAL (NEW) ================ -->
    <div id="report-modal"
        class="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="report-modal-content"
            class="bg-white dark:bg-[#2c2215] w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl transform scale-90 transition-all duration-300 text-center">

            <div id="report-task-emoji" class="text-6xl mb-4">üåÖ</div>
            <h3 class="text-2xl font-black mb-1">K·∫æT QU·∫¢ TH·∫æ N√ÄO?</h3>
            <p class="text-slate-500 mb-8 font-medium">B√© h√£y trung th·ª±c ch·ªçn k·∫øt qu·∫£ th·ª±c t·∫ø c·ªßa m√¨nh nh√©!</p>

            <div class="space-y-3">
                <button onclick="confirmReport(true)"
                    class="w-full py-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black rounded-3xl shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3">
                    <span class="material-symbols-outlined">check_circle</span>
                    M√åNH ƒê√É HO√ÄN TH√ÄNH!
                </button>
                <button onclick="confirmReport(false)"
                    class="w-full py-4 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold rounded-3xl hover:bg-rose-50 hover:text-rose-500 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <span class="material-symbols-outlined">cancel</span>
                    M√åNH CH∆ØA XONG...
                </button>
            </div>

            <button onclick="closeReportModal()"
                class="mt-6 text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600">ƒê·ªÉ
                sau</button>
        </div>
    </div>

    <!-- ================ CREATE CHALLENGE MODAL (Unchanged but with sound) ================ -->
    <div id="challenge-modal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="challenge-modal-content"
            class="bg-white dark:bg-[#2c2215] w-full max-w-xl rounded-[2.5rem] p-7 shadow-2xl transform scale-90 transition-all duration-300 max-h-[90vh] overflow-y-auto relative text-slate-800 dark:text-white">
            <div id="limit-error"
                class="absolute inset-0 bg-white/95 dark:bg-[#2c2215]/95 z-20 flex flex-col items-center justify-center p-10 text-center rounded-[2.5rem] hidden">
                <span class="material-symbols-outlined text-6xl text-arena-orange mb-4">block</span>
                <h4 class="text-2xl font-black mb-2">H·∫øt l∆∞·ª£t r·ªìi!</h4>
                <p class="text-slate-500 mb-8 font-medium">B·∫°n ƒë√£ tham gia ƒë·ªß 3 k√®o ƒë·∫•u h√¥m nay. H√£y ngh·ªâ ng∆°i v√† quay
                    l·∫°i v√†o ng√†y mai nh√©!</p>
                <button onclick="closeChallengeModal()"
                    class="px-8 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl font-bold">ƒê√£ hi·ªÉu</button>
            </div>
            <div class="flex items-center justify-between mb-7">
                <h3 class="text-2xl font-black">‚öîÔ∏è Ch·ªçn Th√°ch ƒê·∫•u</h3>
                <button onclick="closeChallengeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <span class="material-symbols-outlined text-2xl">close</span>
                </button>
            </div>
            <div class="mb-7">
                <div class="flex items-center justify-between mb-3 px-1">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">1 ¬∑ CH·ªåN ƒê·ªêI TH·ª¶</p>
                    <span
                        class="text-[9px] font-bold text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-full">Vu·ªët
                        ngang ƒë·ªÉ xem th√™m</span>
                </div>
                <div id="opponent-list" class="flex gap-4 overflow-x-auto pb-4 pt-1 px-1 opponent-list-scroll snap-x">
                </div>
            </div>
            <div class="mb-8">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400 mb-3">2 ¬∑ CH·ªåN TH·ª¨ TH√ÅCH</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <button onclick="selectTask(this, 'D·∫≠y s·ªõm')"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left">
                        <span class="text-2xl">üåÖ</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block">D·∫≠y s·ªõm</span>
                            <span class="text-[10px] text-slate-400 leading-tight">Ho√†n th√†nh tr∆∞·ªõc 6:30 s√°ng</span>
                        </div>
                    </button>
                    <button onclick="selectTask(this, 'ƒÇn xong su·∫•t')"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left">
                        <span class="text-2xl">üçΩÔ∏è</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block">ƒÇn su·∫•t</span>
                            <span class="text-[10px] text-slate-400 leading-tight">Kh√¥ng b·ªè th·ª´a, d·ªçn khay s·∫°ch</span>
                        </div>
                    </button>
                    <button onclick="selectTask(this, 'T·ª± h·ªçc b√†i')"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left">
                        <span class="text-2xl">üìö</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block">H·ªçc b√†i</span>
                            <span class="text-[10px] text-slate-400 leading-tight">T·ª± gi√°c l√†m h·∫øt b√†i t·∫≠p v·ªÅ nh√†</span>
                        </div>
                    </button>
                    <button onclick="selectTask(this, 'L√†m vi·ªác nh√†')"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left">
                        <span class="text-2xl">üè†</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block">Vi·ªác nh√†</span>
                            <span class="text-[10px] text-slate-400 leading-tight">Qu√©t nh√† ho·∫∑c d·ªçn ph√≤ng g·ªçn
                                g√†ng</span>
                        </div>
                    </button>
                    <button onclick="selectTask(this, 'T·∫≠p th·ªÉ d·ª•c')"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left">
                        <span class="text-2xl">üèÉ</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block">T·∫≠p th·ªÉ d·ª•c</span>
                            <span class="text-[10px] text-slate-400 leading-tight">V·∫≠n ƒë·ªông 15-30p cho c∆° th·ªÉ
                                kh·ªèe</span>
                        </div>
                    </button>
                    <button onclick="selectTask(this, 'ƒê√°nh rƒÉng')"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left">
                        <span class="text-2xl">ü™•</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block">V·ªá sinh</span>
                            <span class="text-[10px] text-slate-400 leading-tight">R·ª≠a m·∫∑t, ƒë√°nh rƒÉng th·∫≠t s·∫°ch</span>
                        </div>
                    </button>

                    <!-- New Custom Challenge Button -->
                    <button onclick="showCustomTaskInput(this)"
                        class="task-btn p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 hover:border-arena-orange transition-all flex items-center gap-3 text-left bg-primary/5 border-dashed border-primary/40">
                        <span class="text-2xl">‚ú®</span>
                        <div class="min-w-0">
                            <span class="font-bold text-sm block text-primary">T·ª± t·∫°o th·ª≠ th√°ch</span>
                            <span class="text-[10px] text-slate-400 leading-tight">S√°ng t·∫°o k√®o ri√™ng c·ªßa b√©</span>
                        </div>
                    </button>
                </div>

                <!-- Task Setup Input Container (Always visible once task is selected) -->
                <div id="task-setup-container"
                    class="hidden mb-4 space-y-3 bg-slate-50 dark:bg-black/20 p-5 rounded-[2rem] border-2 border-primary/20 animate-in fade-in slide-in-from-top-4 duration-300">
                    <div>
                        <div class="flex items-center justify-between mb-1.5 px-2">
                            <label class="text-[9px] font-black text-primary uppercase tracking-widest">T√™n th·ª≠
                                th√°ch:</label>
                            <span id="task-source-tag"
                                class="text-[8px] font-bold text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-full uppercase">T√πy
                                ch·ªânh</span>
                        </div>
                        <input type="text" id="task-title-input" placeholder="V√≠ d·ª•: L√†m 3 vi·ªác t·ªët..."
                            oninput="updateSubmitBtn()"
                            class="w-full bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-2xl px-4 py-3 text-sm font-bold focus:border-primary outline-none transition-all">
                    </div>
                    <div>
                        <label
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-2 mb-1.5 block">M√¥
                            t·∫£ ƒëi·ªÅu ki·ªán th·∫Øng (B√© c√≥ th·ªÉ s·ª≠a):</label>
                        <textarea id="task-desc-input" placeholder="Ghi r√µ th·∫ø n√†o l√† th·∫Øng ƒë·ªÉ tr·ªçng t√†i d·ªÖ x·ª≠ nh√©!"
                            class="w-full bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-2xl px-4 py-3 text-xs font-medium focus:border-primary outline-none transition-all resize-none h-20"></textarea>
                    </div>

                    <!-- New Betting Section -->
                    <div class="pt-2 border-t border-slate-200 dark:border-slate-800">
                        <div class="flex items-center justify-between mb-2 px-2">
                            <label class="text-[9px] font-black text-arena-orange uppercase tracking-widest">üí∞ M·ª©c c∆∞·ª£c
                                (C∆∞·ª£c v·ªõi h·ªá th·ªëng):</label>
                            <span class="text-[9px] font-bold text-slate-400">S·ªë d∆∞: <span id="user-gold-balance"
                                    class="text-primary">0</span> V√†ng</span>
                        </div>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-primary">monetization_on</span>
                            <input type="number" id="bet-input" value="0" min="0" step="10" oninput="updateSubmitBtn()"
                                class="w-full bg-white dark:bg-slate-800 border-2 border-primary/30 rounded-2xl pl-12 pr-4 py-3 text-lg font-black text-primary hover:border-primary focus:border-primary outline-none transition-all">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 flex gap-1">
                                <button onclick="addToBet(10)"
                                    class="px-2 py-1 bg-primary/10 text-primary text-[10px] font-black rounded-lg hover:bg-primary/20 transition-all">+10</button>
                                <button onclick="addToBet(50)"
                                    class="px-2 py-1 bg-primary/10 text-primary text-[10px] font-black rounded-lg hover:bg-primary/20 transition-all">+50</button>
                                <button onclick="betAll()"
                                    class="px-2 py-1 bg-rose-500/10 text-rose-500 text-[10px] font-black rounded-lg hover:bg-rose-500/20 transition-all">T·∫•t
                                    tay</button>
                            </div>
                        </div>
                        <p id="bet-disclaimer" class="text-[8px] text-slate-400 mt-2 ml-2 leading-relaxed">
                            üí° N·∫øu th·∫Øng nh·∫≠n <span class="text-emerald-500 font-bold">x2</span> ti·ªÅn c∆∞·ª£c. N·∫øu H√≤a nh·∫≠n
                            l·∫°i v·ªën. N·∫øu thua m·∫•t tr·∫Øng.
                        </p>
                    </div>
                </div>

            </div>
            <div class="flex gap-3">
                <button onclick="closeChallengeModal()"
                    class="flex-1 py-4 bg-slate-100 dark:bg-slate-800 text-slate-500 font-bold rounded-2xl">B·ªè
                    qua</button>
                <button id="btn-submit-challenge" onclick="submitChallenge()" disabled
                    class="flex-[2] py-4 bg-arena-orange opacity-40 cursor-not-allowed text-white font-black rounded-2xl shadow-lg">TH√ÅCH
                    ƒê·∫§U!</button>
            </div>
        </div>
    </div>

    <!-- ================ REVEAL DRAMA MODAL (IMPROVED) ================ -->
    <div id="reveal-modal"
        class="fixed inset-0 z-[200] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-500">
        <div id="reveal-overlay" class="absolute inset-0 reveal-overlay-active"></div>
        <div id="reveal-content" class="w-full max-w-lg text-center text-white relative z-10">
            <div class="text-9xl mb-12 chest-drama" id="drama-chest">üéÅ</div>
            <h3 class="text-4xl font-black italic tracking-tighter mb-4">ƒêANG PH√ÅN QUY·∫æT...</h3>
            <div class="w-full bg-white/10 h-4 rounded-full overflow-hidden max-w-sm mx-auto p-1 border border-white/5">
                <div id="reveal-progress"
                    class="bg-gradient-to-r from-yellow-400 to-orange-500 h-full w-0 transition-all duration-[2500ms] ease-linear shadow-[0_0_20px_rgba(249,115,22,0.6)]">
                </div>
            </div>
            <p id="drama-text" class="text-yellow-400 font-black mt-6 uppercase tracking-widest text-sm animate-pulse">
                Tr·ªçng t√†i ƒëang xem bƒÉng ghi h√¨nh!</p>
        </div>
    </div>

    <!-- ================ RESULT MODAL ================ -->
    <div id="result-modal"
        class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="result-content"
            class="result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)] transform scale-75 transition-all duration-300 text-white overflow-hidden relative">
            <div class="absolute inset-0 opacity-10">
                <div class="absolute top-0 left-0 w-40 h-40 bg-white rounded-full -translate-x-1/2 -translate-y-1/2">
                </div>
                <div class="absolute bottom-0 right-0 w-60 h-60 bg-white rounded-full translate-x-1/2 translate-y-1/2">
                </div>
            </div>
            <div class="relative z-10">
                <div id="result-emoji" class="text-8xl mb-6 result-pop">üèÜ</div>
                <h3 id="result-title" class="text-4xl font-black mb-3 uppercase tracking-tighter italic">TH·∫ÆNG R·ªíI!</h3>
                <p id="result-desc" class="text-blue-100 font-bold mb-8">ƒêang t√≠nh to√°n k·∫øt qu·∫£...</p>

                <div class="grid grid-cols-3 gap-3 mb-10">
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <p id="res-stickers" class="text-3xl font-black text-yellow-300">+3</p>
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/60">Stickers</p>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <p id="res-gold" class="text-3xl font-black text-white">+50</p>
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/60">Gold</p>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <p id="res-xp" class="text-3xl font-black text-white">+25</p>
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/60">EXP</p>
                    </div>
                </div>

                <button onclick="closeResultModal()"
                    class="w-full py-5 bg-white text-slate-800 font-black rounded-3xl text-xl hover:bg-yellow-50 transition-all active:scale-95 shadow-xl">
                    ƒê√É HI·ªÇU! üéâ
                </button>
            </div>
        </div>
    </div>

    <!-- ================ WAITING MODAL ================ -->
    <div id="waiting-modal"
        class="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-xl opacity-0 pointer-events-none transition-all duration-300">
        <div id="waiting-modal-content" class="text-center text-white max-w-sm">
            <div class="relative w-32 h-32 mx-auto mb-8">
                <img id="waiting-opponent-avatar" src=""
                    class="w-full h-full rounded-full border-4 border-arena-orange shadow-2xl relative z-10">
                <div class="absolute -inset-4 border-2 border-white/20 rounded-full animate-ping"></div>
                <div class="absolute -inset-8 border-2 border-white/10 rounded-full animate-ping"
                    style="animation-delay: 0.5s"></div>
            </div>
            <h3 class="text-3xl font-black mb-4 uppercase italic">ƒêANG G·ª¨I L·ªúI M·ªúI...</h3>
            <p class="text-slate-300 font-medium mb-8">ƒêang li√™n l·∫°c v·ªõi <span id="waiting-opponent-name"
                    class="text-arena-orange font-black">ƒë·ªëi th·ªß</span> qua chi·∫øn h·∫°m, vui l√≤ng ch·ªù trong gi√¢y l√°t!</p>

            <div class="progress-line mb-6"></div>
            <div id="countdown-timer" class="text-5xl font-black text-arena-orange italic">10</div>
            <p class="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] mt-2">Gi√¢y</p>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <child-nav active="arena"></child-nav>

    <script>
        let selectedOpponentId = null;
        let selectedTaskType = null;
        let reportingChallengeId = null;
        const TASK_EMOJI = { 'D·∫≠y s·ªõm': 'üåÖ', 'ƒÇn xong su·∫•t': 'üçΩÔ∏è', 'T·ª± h·ªçc b√†i': 'üìö', 'L√†m vi·ªác nh√†': 'üè†', 'T·∫≠p th·ªÉ d·ª•c': 'üèÉ', 'ƒê√°nh rƒÉng': 'ü™•', 'V·ªá sinh': 'ü™•' };
        const TASK_CONDITIONS = {
            'D·∫≠y s·ªõm': 'B√© ph·∫£i th·ª©c d·∫≠y tr∆∞·ªõc 6:30 v√† ƒë√£ s·∫µn s√†ng v·ªá sinh c√° nh√¢n xong ƒë·ªÉ ƒë∆∞·ª£c t√≠nh l√† ho√†n th√†nh!',
            'ƒÇn xong su·∫•t': 'B√© c·∫ßn ƒÉn h·∫øt s·∫°ch c√°c m√≥n trong b√°t, kh√¥ng ƒë·ªÉ r∆°i v√£i v√† t·ª± mang b√°t ƒëi c·∫•t ƒë√∫ng n∆°i quy ƒë·ªãnh.',
            'T·ª± h·ªçc b√†i': 'B√© ho√†n th√†nh to√†n b·ªô b√†i t·∫≠p gi√°o vi√™n giao v√† c·∫£ b√†i t·∫≠p chu·∫©n b·ªã cho h√¥m sau m√† kh√¥ng c·∫ßn nh·∫Øc nh·ªü.',
            'L√†m vi·ªác nh√†': 'Khu v·ª±c b√© ƒë∆∞·ª£c giao (ph√≤ng ng·ªß ho·∫∑c ph√≤ng kh√°ch) ph·∫£i s·∫°ch s·∫Ω, ƒë·ªì ch∆°i ƒë∆∞·ª£c x·∫øp l·∫°i ngay ng·∫Øn v√†o th√πng.',
            'T·∫≠p th·ªÉ d·ª•c': 'B√© v·ªó tay theo nh·∫°c ho·∫∑c ch·∫°y b·ªô c·∫ßu thang, th·ª±c hi·ªán v·∫≠n ƒë·ªông li√™n t·ª•c trong √≠t nh·∫•t 15 ph√∫t.',
            'ƒê√°nh rƒÉng': 'B√© ƒë√°nh rƒÉng c·∫£ h√†m tr√™n v√† d∆∞·ªõi trong ƒë·ªß 2 ph√∫t, ƒë·∫£m b·∫£o h∆°i th·ªü th∆°m tho sau khi xong.'
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (window.AppState) {
                window.AppState.subscribe(data => renderArena(data));
                renderArena(window.AppState.data);
            }
        });

        function playSound(id) {
            const audio = document.getElementById(id);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play blocked"));
            }
        }

        function renderArena(data) {
            if (!data || !data.user) return;
            const currentUserId = String(data.user.id);

            const activeGrid = document.getElementById('active-challenges-grid');
            const completedGrid = document.getElementById('completed-challenges-grid');
            const newsGrid = document.getElementById('arena-news-list');
            const completedSection = document.getElementById('completed-section');
            const activeCount = document.getElementById('active-count');

            const challenges = data.challenges || [];

            // --- FILTERING ---
            const myActive = challenges.filter(c => c.status !== 'completed' && (c.challengerId === currentUserId || c.opponentId === currentUserId));
            // Limit history to LAST 6 for cleanliness
            const myCompleted = challenges.filter(c => c.status === 'completed' && (c.challengerId === currentUserId || c.opponentId === currentUserId)).reverse().slice(0, 6);
            const othersChallenges = challenges.filter(c => c.challengerId !== currentUserId && c.opponentId !== currentUserId).slice(0, 5);

            // Daily counter
            const activeToday = window.AppState.getDailyChallengeCount(currentUserId, 'active');
            const passiveToday = window.AppState.getDailyChallengeCount(currentUserId, 'passive');

            const activeRem = Math.max(0, 3 - activeToday);
            const passiveRem = Math.max(0, 3 - passiveToday);

            const activeEl = document.getElementById('active-counter');
            const passiveEl = document.getElementById('passive-counter');

            activeEl.textContent = `${activeRem}/3`;
            activeEl.className = activeRem === 0 ? "text-2xl font-black text-rose-500" : "text-2xl font-black text-arena-orange";

            passiveEl.textContent = `${passiveRem}/3`;
            passiveEl.className = passiveRem === 0 ? "text-2xl font-black text-rose-500" : "text-2xl font-black text-blue-500";

            // Active Grid
            if (myActive.length > 0) {
                activeCount.textContent = myActive.length;
                activeCount.classList.remove('hidden');
                activeGrid.innerHTML = myActive.map((c, i) => renderActiveCard(c, data, i)).join('');
            } else {
                activeCount.classList.add('hidden');
                activeGrid.innerHTML = `
                    <div class="col-span-full py-16 text-center bg-white/40 dark:bg-white/5 rounded-[2.5rem] border-2 border-dashed border-slate-200 dark:border-slate-800">
                        <span class="material-symbols-outlined text-5xl text-slate-300 mb-3 block">sports_kabaddi</span>
                        <p class="text-slate-400 font-bold">B·∫°n kh√¥ng c√≥ k√®o n√†o ƒëang ƒë·∫•u.</p>
                        <p class="text-slate-400 text-sm mt-1">H√£y th√°ch ƒë·∫•u ai ƒë√≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
                    </div>`;
            }

            // Completed History
            if (myCompleted.length > 0) {
                completedSection.classList.remove('hidden');
                completedGrid.innerHTML = myCompleted.map(c => renderCompletedCard(c, data)).join('');
            } else {
                completedSection.classList.add('hidden');
            }

            // Welcome Text Fix
            document.getElementById('welcome-text').textContent = `S·∫µn s√†ng ƒë·ªÉ tr·ªü th√†nh chi·∫øn th·∫ßn, ${data.user.name}?`;

            // World news
            newsGrid.innerHTML = othersChallenges.length > 0 ? othersChallenges.map(c => renderNewsCard(c, data)).join('') : `<p class="text-xs text-slate-400 text-center py-4">ƒêang c·∫≠p nh·∫≠t tin t·ª©c t·ª´ v∆∞∆°ng qu·ªëc...</p>`;

            // Update user stats
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - (now.getDay() + 6) % 7));
            startOfWeek.setHours(0, 0, 0, 0);

            const myMatches = (data.challenges || []).filter(c => c.status === 'completed' && (c.challengerId === currentUserId || c.opponentId === currentUserId) && new Date(c.date) >= startOfWeek);
            document.getElementById('user-wins').textContent = myMatches.filter(c => c.winnerId === currentUserId).length;
            document.getElementById('user-draws').textContent = myMatches.filter(c => c.winnerId === null).length;
            document.getElementById('user-losses').textContent = myMatches.length - myMatches.filter(c => c.winnerId === currentUserId).length - myMatches.filter(c => c.winnerId === null).length;

            renderOpponentList(data);
        }

        function renderActiveCard(c, data, index) {
            const challenger = data.leaderboard.find(p => p.id === c.challengerId);
            const opponent = data.leaderboard.find(p => p.id === c.opponentId);
            const currentUserId = data.user.id;
            const isMyConfirmed = c.challengerId === currentUserId ? c.challengerConfirmed : c.opponentConfirmed;

            const cleanTaskName = c.taskType.split('||BET:')[0].split(' | ')[0];
            const taskEmoji = TASK_EMOJI[cleanTaskName] || '‚öîÔ∏è';

            const isChallengerConfirmed = c.challengerConfirmed === true;
            const isOpponentConfirmed = c.opponentConfirmed === true;

            // Power Percentage calculation for Tug-of-war
            let powerPercentage = 50;
            let powerComment = "B·∫§T PH√ÇN TH·∫ÆNG B·∫†I";

            if (isChallengerConfirmed && !isOpponentConfirmed) {
                powerPercentage = 75;
                powerComment = `${challenger.name.toUpperCase()} ƒêANG D√ÄN QU√ÇN √ÅP ƒê·∫¢O!`;
            } else if (!isChallengerConfirmed && isOpponentConfirmed) {
                powerPercentage = 25;
                powerComment = `${opponent.name.split(' ')[0].toUpperCase()} ƒêANG CH·ªêNG TR·∫¢ QUY·∫æT LI·ªÜT!`;
            } else if (isChallengerConfirmed && isOpponentConfirmed) {
                // Internal momentum drift using simple natural waves
                const now = new Date();
                const time = now.getSeconds() + now.getMilliseconds() / 1000;
                // Subtle width fluctuation +/- 8% for internal realism
                const drift = (Math.sin(time / 2.5) * 6) + (Math.sin(time / 0.8) * 2);
                powerPercentage = 50 + drift;
                powerComment = "PH√ÅN QUY·∫æT ƒêANG ƒê∆Ø·ª¢C PHONG ·∫§N!";
            }

            const dominantSide = (isChallengerConfirmed && isOpponentConfirmed) ? 'none' : (powerPercentage > 60 ? 'challenger' : (powerPercentage < 40 ? 'opponent' : 'none'));

            // Reveal logic
            const now = new Date();
            const revealTime = new Date();
            revealTime.setHours(19, 0, 0, 0);
            const isDebug = window.location.search.includes('debug=true');
            const isLateEnough = (now >= revealTime) || isDebug;

            let actionArea = '';
            if (isMyConfirmed === null || isMyConfirmed === undefined) {
                actionArea = `
                    <button onclick="openReportModal('${c.id}', '${cleanTaskName}')"
                        class="group relative overflow-hidden btn-done-pulse px-10 py-5 bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-black rounded-3xl text-xl shadow-2xl active:scale-95 transition-all">
                        <span class="relative z-10 flex items-center gap-3">X√ÅC NH·∫¨N HO√ÄN TH√ÄNH! <span class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">emoji_events</span></span>
                    </button>`;
            } else if (!isLateEnough) {
                const statusColor = isMyConfirmed === true ? 'text-emerald-500 bg-emerald-500/10' : 'text-rose-500 bg-rose-500/10';
                const statusIcon = isMyConfirmed === true ? 'verified' : 'error';
                const statusText = isMyConfirmed === true ? 'ƒê√É B√ÅO C√ÅO XONG' : 'B√ÅO C√ÅO: CH∆ØA XONG';

                actionArea = `
                    <div class="flex flex-col items-center gap-3">
                        <div class="flex items-center gap-2 px-6 py-3 rounded-full ${statusColor} border border-current shadow-sm pulse-ring">
                            <span class="material-symbols-outlined">${statusIcon}</span>
                            <span class="font-black tracking-widest text-sm uppercase">${statusText}</span>
                        </div>
                        <p class="font-black text-rose-500 text-base animate-pulse tracking-tight italic">üî• 19:00 C√îNG B·ªê K·∫æT QU·∫¢</p>
                    </div>`;
            } else {
                actionArea = `
                    <button onclick="dramaReveal('${c.id}')"
                        class="btn-done-pulse px-12 py-6 bg-gradient-to-r from-yellow-400 via-orange-500 to-rose-500 text-white font-black rounded-3xl text-2xl shadow-[0_15px_40px_-10px_rgba(249,115,22,0.6)] flex items-center justify-center gap-4 active:scale-95 transition-all hover:rotate-1">
                        üéÅ M·ªû R∆Ø∆†NG K·∫æT QU·∫¢!
                    </button>`;
            }

            return `
                <div class="gladiator-card card-enter rounded-[3.5rem] bg-white dark:bg-[#1a140c] shadow-2xl overflow-hidden relative group border-4 border-white dark:border-slate-800 flex flex-col">
                    <!-- Background Split -->
                    <div class="absolute inset-0 flex pointer-events-none">
                        <div class="w-1/2 bg-blue-50/50 dark:bg-blue-900/5 transform -skew-x-12 -translate-x-12"></div>
                        <div class="w-1/2 bg-rose-50/50 dark:bg-rose-900/5 transform -skew-x-12 -translate-x-4"></div>
                    </div>

                    <!-- Header -->
                    <div class="relative z-10 py-4 px-6 sm:px-8 flex items-center justify-between border-b border-slate-100 dark:border-white/5 bg-white/60 dark:bg-black/40 backdrop-blur-md">
                        <div class="flex items-center gap-2">
                           <div class="w-2 h-2 rounded-full bg-rose-500 animate-ping"></div>
                           <span class="text-[9px] sm:text-[11px] font-black text-slate-800 dark:text-white tracking-[0.2em] uppercase">K√®o ƒë·∫•u c·ªßa b·∫°n</span>
                        </div>
                        <span class="text-[8px] sm:text-[10px] text-slate-400 font-black uppercase tracking-widest">${c.date}</span>
                    </div>

                    <!-- Content Area -->
                    <div class="relative z-10 p-6 sm:p-8 flex-grow">
                        <!-- VS Section -->
                        <div class="flex items-center justify-between gap-4 mb-4">
                            <!-- Challenger (You) -->
                            <div class="flex flex-col items-center gap-4 flex-1">
                                <div class="relative">
                                    <div class="absolute -inset-4 bg-blue-500/20 rounded-full blur-xl animate-pulse"></div>
                                    <img src="${challenger.avatar}" class="w-20 h-20 sm:w-28 sm:h-28 rounded-full border-4 border-white shadow-2xl relative z-20 ${isChallengerConfirmed ? 'aura-active-blue' : ''} ${dominantSide === 'challenger' ? 'dominant-blue' : ''} transition-all duration-500">
                                    <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-blue-500 rounded-full border-4 border-white dark:border-[#1a140c] flex items-center justify-center z-30">
                                        <span class="material-symbols-outlined text-white text-[10px] font-bold">face</span>
                                    </div>
                                </div>
                                <span class="text-[10px] sm:text-base font-black text-blue-600 dark:text-blue-400 uppercase tracking-tighter">${challenger.name}</span>
                            </div>

                            <!-- VS Badge -->
                            <div class="flex flex-col items-center gap-2 px-2 shrink-0">
                                <div class="bg-gradient-to-br from-slate-800 to-black text-white w-12 h-12 sm:w-16 sm:h-16 rounded-2xl flex items-center justify-center font-black text-lg italic shadow-2xl transform rotate-12 -translate-y-4 group-hover:rotate-[-12deg] transition-transform duration-500 border-4 border-white dark:border-slate-800">VS</div>
                            </div>

                            <!-- Opponent -->
                            <div class="flex flex-col items-center gap-4 flex-1">
                                <div class="relative">
                                    <div class="absolute -inset-4 bg-rose-500/20 rounded-full blur-xl animate-pulse"></div>
                                    <img src="${opponent.avatar}" class="w-20 h-20 sm:w-28 sm:h-28 rounded-full border-4 border-white shadow-2xl relative z-20 ${isOpponentConfirmed ? 'aura-active-red' : ''} ${dominantSide === 'opponent' ? 'dominant-red' : ''} transition-all duration-500">
                                    <div class="absolute -bottom-1 -left-1 w-8 h-8 bg-rose-500 rounded-full border-4 border-white dark:border-[#1a140c] flex items-center justify-center z-30">
                                        <span class="material-symbols-outlined text-white text-[10px] font-bold">face</span>
                                    </div>
                                </div>
                                <span class="text-[10px] sm:text-base font-black text-rose-600 dark:text-rose-400 uppercase tracking-tighter">${opponent.name.replace(' (Bot)', '')}</span>
                            </div>
                        </div>

                        <!-- Task Banner -->
                        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-4 sm:p-6 shadow-xl border border-slate-100 dark:border-white/5 mb-6 transform scale-100 group-hover:scale-[1.03] transition-transform flex items-center gap-4 sm:gap-6 justify-center overflow-hidden relative">
                            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_transparent_0%,_rgba(0,0,0,0.05)_100%)]"></div>
                            <span class="text-3xl sm:text-5xl drop-shadow-lg relative z-10">${taskEmoji}</span>
                            <div class="text-left relative z-10">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-[0.3em] mb-1">M·ª•c ti√™u th·ª≠ th√°ch</p>
                                <p class="font-black text-xl sm:text-3xl text-slate-800 dark:text-white uppercase italic tracking-tighter leading-none">${cleanTaskName}</p>
                            </div>
                        </div>

                        <!-- NEW: Dynamic Tug-of-War Logic -->
                        <div class="mb-10 px-4 relative">
                            <div class="flex items-center justify-between mb-3 px-2">
                                <span class="text-[10px] font-black ${isChallengerConfirmed ? 'text-blue-600' : 'text-slate-400'} uppercase tracking-widest flex items-center gap-1">
                                    ${isChallengerConfirmed ? '<span class="w-2 h-2 rounded-full bg-blue-500 animate-ping"></span> ƒê√É RA QU√ÇN' : 'ƒêANG CHU·∫®N B·ªä...'}
                                </span>
                                <span class="text-[10px] font-black ${isOpponentConfirmed ? 'text-rose-600' : 'text-slate-400'} uppercase tracking-widest flex items-center gap-1">
                                    ${isOpponentConfirmed ? 'ƒê√É RA QU√ÇN <span class="w-2 h-2 rounded-full bg-rose-500 animate-ping"></span>' : '...ƒêANG CHU·∫®N B·ªä'}
                                </span>
                            </div>
                            
                            <div class="h-5 bg-slate-300 dark:bg-black/60 rounded-full relative overflow-visible border-2 border-white dark:border-slate-800 shadow-inner struggle-container">
                                <!-- Mystery Overlay for both done -->
                                ${isChallengerConfirmed && isOpponentConfirmed ? `
                                    <div class="absolute -inset-1 bg-yellow-400/10 rounded-full animate-pulse z-40 border-2 border-yellow-400/30"></div>
                                ` : ''}

                                <!-- Power Fill (Blue) -->
                                <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-blue-600 via-blue-400 to-blue-500 power-bar-fill shadow-[0_0_20px_rgba(59,130,246,0.6)] transition-all duration-1000 rounded-l-full ${dominantSide === 'challenger' ? 'bar-dominant' : ''}" 
                                     style="width: ${powerPercentage}%">
                                     ${dominantSide === 'challenger' ? '<div class="absolute inset-0 bg-white/20 animate-pulse rounded-full"></div>' : ''}
                                </div>
                                <!-- Power Fill (Red) -->
                                <div class="absolute inset-y-0 right-0 bg-gradient-to-l from-rose-600 via-rose-400 to-rose-500 power-bar-fill shadow-[0_0_20px_rgba(244,63,94,0.6)] transition-all duration-1000 rounded-r-full ${dominantSide === 'opponent' ? 'bar-dominant' : ''}" 
                                     style="width: ${100 - powerPercentage}%">
                                     ${dominantSide === 'opponent' ? '<div class="absolute inset-0 bg-white/20 animate-pulse rounded-full"></div>' : ''}
                                </div>
                                
                                <!-- Central Bolt with Struggle -->
                                <div class="absolute top-1/2 left-[${powerPercentage}%] -translate-x-1/2 -translate-y-1/2 z-30 transition-all duration-1000 ${isChallengerConfirmed && isOpponentConfirmed ? 'bolt-moving' : 'lightning-bolt-vfx'}">
                                    <span class="material-symbols-outlined text-yellow-400 text-2xl filter drop-shadow-[0_0_8px_white]">bolt</span>
                                </div>
                            </div>
                            
                            <div class="mt-5 text-center">
                                <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-slate-100 dark:bg-white/5 rounded-full border border-slate-200 dark:border-white/10">
                                    <span class="w-2 h-2 rounded-full bg-arena-orange animate-ping"></span>
                                    <p class="text-[10px] font-black text-slate-500 dark:text-slate-300 uppercase tracking-[0.2em]">
                                        TH·∫æ TR·∫¨N: <span class="text-arena-orange dark:text-yellow-400 italic">${powerComment}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Area -->
                        <div class="flex justify-center min-h-[80px] items-center">
                            ${actionArea}
                        </div>
                    </div>

                    <!-- Bottom Commentary Ticker -->
                    <div class="relative z-10 bg-slate-900/5 dark:bg-black/40 py-2 overflow-hidden whitespace-nowrap border-t border-slate-100 dark:border-white/5">
                        <div class="inline-block commentary-slide text-[9px] font-bold text-slate-400 uppercase tracking-widest italic">
                            üöÄ TR·∫¨N ƒê·∫§U ƒêANG C·ª∞C K·ª≤ CƒÇNG TH·∫≤NG... ${challenger.name} ƒêANG G√ÇY √ÅP L·ª∞C L·ªöN! ... ƒê·∫æN 19:00 S·∫º BI·∫æT AI L√Ä CHI·∫æN TH·∫¶N ... H√ÄNH ƒê·ªòNG NGAY ƒê·ªÇ GI√ÄNH L·ª¢I TH·∫æ! ... ‚öîÔ∏è
                        </div>
                    </div>
                </div>`;
        }

        function renderCompletedCard(c, data) {
            const currentUserId = data.user.id;
            const challenger = data.leaderboard.find(p => p.id === c.challengerId);
            const opponent = data.leaderboard.find(p => p.id === c.opponentId);

            const iWon = c.winnerId === currentUserId;
            const cleanTaskName = c.taskType.split('||BET:')[0];
            const taskEmoji = TASK_EMOJI[cleanTaskName.split(' | ')[0]] || '‚öîÔ∏è';

            let resultClass = "border-white bg-white dark:bg-white/5 shadow-md";
            if (iWon) resultClass = "border-green-200 bg-green-50 shadow-[0_8px_20px_-6px_rgba(34,197,94,0.15)]";
            else if (c.winnerId) resultClass = "border-rose-200 bg-rose-50 shadow-[0_8px_20px_-6px_rgba(244,63,94,0.15)]";

            return `
                <div class="relative rounded-3xl border-2 ${resultClass} p-4 flex flex-col gap-3 overflow-visible hover:scale-[1.03] transition-all">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 min-w-0">
                            <span class="text-xl">${taskEmoji}</span>
                            <p class="font-black text-[11px] text-slate-700 dark:text-white uppercase truncate">${cleanTaskName}</p>
                        </div>
                        <span class="text-[9px] font-bold text-slate-400 shrink-0 bg-slate-100 dark:bg-white/10 px-2 py-0.5 rounded-full">${c.date}</span>
                    </div>

                    <div class="flex items-center justify-between gap-1 py-1.5">
                        <div class="flex items-center gap-2.5 flex-1 min-w-0">
                            <div class="relative">
                                <img src="${challenger.avatar}" class="w-10 h-10 rounded-full border-2 ${c.winnerId === c.challengerId ? 'border-yellow-400 shadow-md scale-110' : 'border-slate-200'}">
                                ${c.winnerId === c.challengerId ? '<span class="absolute -top-1.5 -right-1.5 text-xs animate-bounce">üëë</span>' : ''}
                            </div>
                            <span class="text-[11px] font-black truncate ${c.winnerId === c.challengerId ? 'text-slate-900 dark:text-white' : 'text-slate-400'}">${challenger.name}</span>
                        </div>

                        <div class="text-[9px] font-black text-slate-300 italic px-2">VS</div>

                        <div class="flex items-center flex-row-reverse gap-2.5 flex-1 min-w-0">
                            <div class="relative">
                                <img src="${opponent.avatar}" class="w-10 h-10 rounded-full border-2 ${c.winnerId === c.opponentId ? 'border-yellow-400 shadow-md scale-110' : 'border-slate-200'}">
                                ${c.winnerId === c.opponentId ? '<span class="absolute -top-1.5 -right-1.5 text-xs animate-bounce">üëë</span>' : ''}
                            </div>
                            <span class="text-[11px] font-black truncate ${c.winnerId === c.opponentId ? 'text-slate-900 dark:text-white text-right' : 'text-slate-400 text-right'}">${opponent.name.replace(' (Bot)', '')}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-center pt-2 border-t border-slate-100 dark:border-white/5">
                        ${iWon ? '<span class="text-[10px] font-black text-green-600 bg-green-500/15 px-3 py-1 rounded-full border border-green-200">üèÜ CHI·∫æN TH·∫ÆNG (+3 üéüÔ∏è)</span>' : (c.winnerId ? '<span class="text-[10px] font-black text-rose-600 bg-rose-500/15 px-3 py-1 rounded-full border border-rose-200">TI·∫æC QU√Å (-20 ü™ô)</span>' : '<span class="text-[10px] font-black text-slate-500 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">B·∫§T PH√ÇN TH·∫ÆNG B·∫†I</span>')}
                    </div>
                </div>`;
        }

        function renderNewsCard(c, data) {
            const challenger = data.leaderboard.find(p => p.id === c.challengerId);
            const opponent = data.leaderboard.find(p => p.id === c.opponentId);
            const cleanTaskName = c.taskType.split('||BET:')[0];
            const taskEmoji = TASK_EMOJI[cleanTaskName.split(' | ')[0]] || '‚öîÔ∏è';
            const statusText = c.status === 'completed' ? 'K·∫æT TH√öC' : 'LIVE';
            const statusClass = c.status === 'completed' ? 'bg-slate-100 text-slate-600' : 'bg-rose-500 text-white animate-pulse shadow-[0_0_10px_rgba(244,63,94,0.4)]';

            return `
                <div class="bg-white dark:bg-[#2c2215] border-2 border-white dark:border-slate-800 rounded-[1.5rem] p-4 flex items-center justify-between hover:border-arena-orange hover:shadow-lg transition-all shadow-md group">
                    <div class="flex items-center gap-4">
                        <div class="flex -space-x-4 group-hover:-space-x-2 transition-all">
                            <img src="${challenger.avatar}" class="w-10 h-10 rounded-full border-2 border-white dark:border-slate-800 shadow-md z-10">
                            <img src="${opponent.avatar}" class="w-10 h-10 rounded-full border-2 border-white dark:border-slate-800 shadow-md">
                        </div>
                        <div>
                            <p class="text-[11px] font-black text-slate-800 dark:text-white">
                                ${challenger.name} <span class="text-slate-400 font-medium italic mx-0.5">ƒë·∫•u v·ªõi</span> ${opponent.name.replace(' (Bot)', '')}
                            </p>
                            <p class="text-[10px] text-slate-500 font-bold flex items-center gap-1.5 mt-0.5">
                                <span class="bg-slate-100 dark:bg-black/20 px-2 py-0.5 rounded-md flex items-center gap-1">
                                    <span class="text-xs">${taskEmoji}</span> ${cleanTaskName}
                                </span>
                            </p>
                        </div>
                    </div>
                    <span class="px-3 py-1.5 rounded-xl text-[9px] font-black tracking-widest flex items-center gap-1 ${statusClass}">
                        ${c.status !== 'completed' ? '<span class="w-1.5 h-1.5 bg-white rounded-full animate-ping"></span>' : ''}
                        ${statusText}
                    </span>
                </div>`;
        }

        // --- NEW MODAL CONTROLS ---
        function openReportModal(challengeId, taskType) {
            playSound('snd-click');
            reportingChallengeId = challengeId;
            document.getElementById('report-task-emoji').textContent = TASK_EMOJI[taskType] || '‚öîÔ∏è';

            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-modal-content');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-90'), 10);
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-modal-content');
            content.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                reportingChallengeId = null;
            }, 200);
        }

        async function confirmReport(isSuccess) {
            if (!reportingChallengeId) return;
            playSound('snd-click');

            // Th·ª≠ l·∫•y n√∫t b·∫•m ƒëang ƒë∆∞·ª£c nh·∫•n
            const buttons = document.querySelectorAll('#report-modal-content button');
            const submitBtn = isSuccess ? buttons[0] : buttons[1];

            if (submitBtn) {
                submitBtn.disabled = true;
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-lg">sync</span> ƒêANG L∆ØU...';

                try {
                    await window.AppState.selfCompleteChallenge(reportingChallengeId, isSuccess);
                    // ƒê√≥ng modal sau khi ho√†n th√†nh c√¥ng vi·ªác
                    closeReportModal();
                } catch (err) {
                    console.error("L·ªói khi b√°o c√°o:", err);
                    if (window.showLevelUpAlert) {
                        window.showLevelUpAlert("L·ªói h·ªá th·ªëng", "Kh√¥ng th·ªÉ g·ª≠i b√°o c√°o l√∫c n√†y. B√© h√£y th·ª≠ l·∫°i sau nh√©!", "error");
                    }
                    // Kh√¥i ph·ª•c n√∫t n·∫øu l·ªói
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalContent;
                }
            }
        }

        async function dramaReveal(challengeId) {
            playSound('snd-click');
            const modal = document.getElementById('reveal-modal');
            const progress = document.getElementById('reveal-progress');

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                progress.style.width = '100%';
                playSound('snd-chest');
            }, 100);

            // Fetch the challenge to know our role BEFORE showing results
            const chall = window.AppState.data.challenges.find(c => c.id === challengeId);
            const myId = window.AppState.data.user.id;
            const amIChallenger = chall.challengerId === myId;

            setTimeout(async () => {
                const result = await window.AppState.revealChallenge(challengeId);
                modal.classList.add('opacity-0', 'pointer-events-none');
                progress.style.width = '0%';
                if (result) showResultModal(result, amIChallenger);
            }, 2700);
        }

        function showResultModal(result, amIChallenger) {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            const emoji = document.getElementById('result-emoji');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');
            const gText = document.getElementById('res-gold');
            const xText = document.getElementById('res-xp');
            const sText = document.getElementById('res-stickers');

            const myId = window.AppState.data.user.id;
            const iWon = result.winnerId === myId;
            const isDraw = result.draw;

            // L·∫•y ƒëi·ªÉm t∆∞∆°ng ·ª©ng v·ªõi vai tr√≤ c·ªßa m√¨nh
            const myG = amIChallenger ? result.pointsG_C : result.pointsG_O;
            const myXP = amIChallenger ? result.pointsXP_C : result.pointsXP_O;
            const myS = amIChallenger ? result.spins_C : result.spins_O;

            sText.textContent = (myS >= 0 ? '+' : '') + myS;
            gText.textContent = (myG >= 0 ? '+' : '') + myG;
            xText.textContent = (myXP >= 0 ? '+' : '') + myXP;

            // Reset lints
            gText.className = "text-3xl font-black text-white";
            xText.className = "text-3xl font-black text-white";

            if (iWon) {
                playSound('snd-win');
                emoji.textContent = 'üèÜ';
                title.textContent = 'TH·∫ÆNG R·ªíI!';
                desc.textContent = `Ch√∫c m·ª´ng ${window.AppState.data.user.name}! B·∫°n ƒë√£ chi·∫øn th·∫Øng k√®o ƒë·∫•u n√†y!`;
                content.className = "result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl text-white relative bg-gradient-to-br from-green-600 to-emerald-900";
            } else if (isDraw) {
                emoji.textContent = 'ü§ù';
                title.textContent = 'H√íA CU·ªòC!';
                desc.textContent = 'B·∫•t ph√¢n th·∫Øng b·∫°i! C·∫£ hai ƒë·ªÅu r·∫•t xu·∫•t s·∫Øc.';
                content.className = "result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl text-white relative bg-gradient-to-br from-blue-600 to-indigo-900";
            } else {
                emoji.textContent = 'ü¶æ';
                title.textContent = 'T·ªêT L·∫ÆM!';
                desc.textContent = `D√π k·∫øt qu·∫£ th·∫ø n√†o, n·ªó l·ª±c c·ªßa ${window.AppState.data.user.name} v·∫´n r·∫•t ƒë√°ng khen!`;
                content.className = "result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl text-white relative bg-gradient-to-br from-slate-700 to-slate-900";
                gText.className = "text-3xl font-black text-rose-300";
                xText.className = "text-3xl font-black text-rose-300";
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-75'), 10);
        }

        function closeResultModal() {
            const modal = document.getElementById('result-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('result-content').classList.add('scale-75');
        }

        function openChallengeModal() {
            playSound('snd-click');
            const data = window.AppState.data;
            if (!data || !data.user) return;

            const activeUsed = window.AppState.getDailyChallengeCount(data.user.id, 'active');

            const modal = document.getElementById('challenge-modal');
            const content = document.getElementById('challenge-modal-content');

            if (activeUsed >= 3) document.getElementById('limit-error').classList.remove('hidden');
            else document.getElementById('limit-error').classList.add('hidden');

            renderOpponentList(data); // ƒê·∫£m b·∫£o n·∫°p danh s√°ch m·ªói khi m·ªü

            // Reset bet input
            const betInput = document.getElementById('bet-input');
            if (betInput) {
                betInput.value = 0;
            }
            const goldBal = document.getElementById('user-gold-balance');
            if (goldBal) {
                goldBal.textContent = data.user.gold || 0;
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-90'), 10);
        }

        function closeChallengeModal() {
            const modal = document.getElementById('challenge-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('challenge-modal-content').classList.add('scale-90');
        }

        function selectOpponent(id, btn) {
            playSound('snd-click');
            selectedOpponentId = id;
            document.querySelectorAll('.opponent-btn').forEach(b => b.classList.remove('border-arena-blue', 'bg-arena-blue/5', 'scale-105', 'z-10'));
            btn.classList.add('border-arena-blue', 'bg-arena-blue/5', 'scale-105', 'z-10');
            updateSubmitBtn();
        }

        function selectTask(btn, type) {
            playSound('snd-click');
            selectedTaskType = type;
            document.querySelectorAll('.task-btn').forEach(b => b.classList.remove('border-arena-orange', 'bg-arena-orange/5'));
            btn.classList.add('border-arena-orange', 'bg-arena-orange/5');

            const setupContainer = document.getElementById('task-setup-container');
            const titleInput = document.getElementById('task-title-input');
            const descInput = document.getElementById('task-desc-input');
            const sourceTag = document.getElementById('task-source-tag');

            setupContainer.classList.remove('hidden');
            sourceTag.textContent = "C√≥ s·∫µn";
            sourceTag.className = "text-[8px] font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded-full uppercase";

            titleInput.value = type;
            descInput.value = TASK_CONDITIONS[type] || 'H√£y ho√†n th√†nh th·ª≠ th√°ch n√†y th·∫≠t t·ªët nh√©!';

            updateSubmitBtn();
        }

        function showCustomTaskInput(btn) {
            playSound('snd-click');
            selectedTaskType = 'CUSTOM';
            document.querySelectorAll('.task-btn').forEach(b => b.classList.remove('border-arena-orange', 'bg-arena-orange/5'));
            btn.classList.add('border-arena-orange', 'bg-arena-orange/5');

            const setupContainer = document.getElementById('task-setup-container');
            const titleInput = document.getElementById('task-title-input');
            const descInput = document.getElementById('task-desc-input');
            const sourceTag = document.getElementById('task-source-tag');

            setupContainer.classList.remove('hidden');
            sourceTag.textContent = "B√© t·ª± t·∫°o";
            sourceTag.className = "text-[8px] font-bold text-primary bg-primary/5 dark:bg-primary/900/20 px-2 py-0.5 rounded-full uppercase";

            titleInput.value = '';
            descInput.value = '';
            titleInput.focus();

            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('btn-submit-challenge');
            const titleInput = document.getElementById('task-title-input');
            const isTitleFilled = titleInput.value.trim().length > 0;
            const ready = selectedOpponentId && selectedTaskType && isTitleFilled;

            btn.disabled = !ready;
            btn.classList.toggle('opacity-40', !ready);
            btn.classList.toggle('cursor-not-allowed', !ready);
        }

        function addToBet(amount) {
            playSound('snd-click');
            const input = document.getElementById('bet-input');
            const gold = window.AppState.data.user.gold || 0;
            let current = parseInt(input.value) || 0;
            let newVal = current + amount;
            if (newVal > gold) newVal = gold;
            input.value = newVal;
            updateSubmitBtn();
        }

        function betAll() {
            playSound('snd-click');
            const input = document.getElementById('bet-input');
            const gold = window.AppState.data.user.gold || 0;
            input.value = gold;
            updateSubmitBtn();
        }

        async function submitChallenge() {
            if (!selectedOpponentId || !selectedTaskType) return;

            const betInput = document.getElementById('bet-input');
            const betAmount = parseInt(betInput.value) || 0;
            const gold = window.AppState.data.user.gold || 0;

            if (betAmount > gold) {
                window.showFamilyQuestAlert("H·∫øt v√†ng r·ªìi!", "B√© kh√¥ng ƒë·ªß v√†ng ƒë·ªÉ ƒë·∫∑t c∆∞·ª£c m·ª©c n√†y. H√£y t√≠ch l≈©y th√™m nh√©!", "error");
                return;
            }

            const titleInput = document.getElementById('task-title-input');
            const descInput = document.getElementById('task-desc-input');
            const titleValue = titleInput.value.trim();
            const descValue = descInput.value.trim();
            const finalTaskType = descValue ? `${titleValue} | M√¥ t·∫£: ${descValue}` : titleValue;

            const opponent = window.AppState.data.leaderboard.find(p => p.id === selectedOpponentId);
            const waitModal = document.getElementById('waiting-modal');
            const countdownEl = document.getElementById('countdown-timer');
            const avatarEl = document.getElementById('waiting-opponent-avatar');
            const nameEl = document.getElementById('waiting-opponent-name');

            avatarEl.src = opponent.avatar;
            nameEl.textContent = opponent.name.replace(' (Bot)', '');

            // 1. Close input modal
            closeChallengeModal();

            // 2. Show waiting modal
            waitModal.classList.remove('opacity-0', 'pointer-events-none');

            // 3. Start Visual Countdown (6-10s)
            const dramaticWaitTime = 6000 + Math.floor(Math.random() * 4000);
            let displayCount = Math.ceil(dramaticWaitTime / 1000);
            countdownEl.textContent = displayCount;

            const countdownPromise = new Promise(resolve => {
                const interval = setInterval(() => {
                    displayCount--;
                    countdownEl.textContent = Math.max(0, displayCount);
                    if (displayCount <= 0) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 1000);
            });

            // Wait for the countdown to finish FIRST
            await countdownPromise;

            // 4. Decide REJECTION (20% chance as requested)
            const isDeclined = Math.random() < 0.20;

            try {
                if (isDeclined) {
                    window.showFamilyQuestAlert("L·ªùi t·ª´ ch·ªëi!", `${opponent.name.replace(' (Bot)', '')} hi·ªán ƒëang b·∫≠n t·∫≠p luy·ªán v√† h·∫πn b√© th√°ch ƒë·∫•u d·ªãp kh√°c nh√©!`, "info");
                } else {
                    // 5. Only now we call the API to "officially" start
                    const result = await window.AppState.createChallenge(selectedOpponentId, finalTaskType, betAmount);

                    if (result && result.error) {
                        if (result.error === 'LIMIT_REACHED') {
                            window.showFamilyQuestAlert("H·∫øt l∆∞·ª£t r·ªìi!", "Con ƒë√£ h·∫øt 3 l∆∞·ª£t ch·ªß ƒë·ªông th√°ch ƒë·∫•u h√¥m nay r·ªìi.", "warning");
                        } else if (result.error === 'OPPONENT_LIMIT_REACHED') {
                            window.showFamilyQuestAlert("Chi·∫øn binh b·∫≠n!", "B·∫°n n√†y h√¥m nay ƒë√£ nh·∫≠n ƒë·ªß l·ªùi th√°ch ƒë·∫•u r·ªìi, h√£y ch·ªçn b·∫°n kh√°c nh√©!", "info");
                        }
                    } else {
                        // Success!
                        playSound('snd-click');
                    }
                }
            } catch (err) {
                console.error("L·ªói k·ªãch b·∫£n th√°ch ƒë·∫•u:", err);
            } finally {
                waitModal.classList.add('opacity-0', 'pointer-events-none');

                // Clear state
                titleInput.value = '';
                descInput.value = '';
                document.getElementById('task-setup-container').classList.add('hidden');
                selectedOpponentId = null;
                selectedTaskType = null;
            }
        }

        async function selfComplete(challengeId) {
            playSound('snd-click');
            await window.AppState.selfCompleteChallenge(challengeId);
        }

        async function renderOpponentList(inputData) {
            const list = document.getElementById('opponent-list');
            if (!list) return;

            // ∆Øu ti√™n AppState.data n·∫øu inputData c√≥ v·∫ª ƒëang b·ªã thi·∫øu (sync ch∆∞a xong)
            const data = (inputData && inputData.leaderboard && inputData.leaderboard.length > 1) ? inputData : window.AppState.data;

            try {
                const currentUserId = data.user && String(data.user.id);
                const leaderboard = data.leaderboard || [];

                // L·∫•y t·∫•t c·∫£ tr·ª´ ba m·∫π v√† ch√≠nh m√¨nh
                const others = leaderboard.filter(p => {
                    if (!p || !p.id) return false;
                    const pid = String(p.id);
                    // L·ªçc: Kh√¥ng ph·∫£i ch√≠nh m√¨nh v√† kh√¥ng ph·∫£i ph·ª• huynh
                    return pid !== currentUserId && p.role !== 'parent';
                });

                if (others.length === 0) {
                    // N·∫øu v·∫´n tr·ªëng, th·ª≠ y√™u c·∫ßu sync m·ªôt l·∫ßn n·ªØa (silent sync)
                    if (!this._lastSyncAttempt || Date.now() - this._lastSyncAttempt > 5000) {
                        this._lastSyncAttempt = Date.now();
                        window.AppState.syncFromDatabase().then(() => {
                            if (window.AppState.data.leaderboard && window.AppState.data.leaderboard.length > 1) {
                                renderOpponentList(window.AppState.data);
                            }
                        });
                    }

                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center w-full py-6 opacity-40 animate-pulse">
                            <span class="material-symbols-outlined text-4xl mb-2 text-primary">search</span>
                            <p class="text-[9px] font-black uppercase tracking-widest text-center">ƒêang n·∫°p danh s√°ch v√µ sƒ©...</p>
                        </div>
                    `;
                    return;
                }

                const now = new Date();
                const startOfWeek = new Date(now.setDate(now.getDate() - (now.getDay() + 6) % 7));
                startOfWeek.setHours(0, 0, 0, 0);

                const challenges = data.challenges || [];

                list.innerHTML = others.map(p => {
                    const pid = String(p.id);
                    const matches = challenges.filter(c =>
                        c.status === 'completed' &&
                        (String(c.challengerId) === pid || String(c.opponentId) === pid) &&
                        c.date && new Date(c.date) >= startOfWeek
                    );
                    const wins = matches.filter(c => c.winnerId && String(c.winnerId) === pid).length;
                    const draws = matches.filter(c => c.winnerId === null).length;
                    const losses = matches.length - wins - draws;

                    const name = (p.name || "V√µ sƒ©").replace(' (Bot)', '');
                    const avatar = p.avatar || "../shared/assets/generated_avatars/avatar_1.png";

                    return `
                    <button onclick="selectOpponent('${p.id}', this)" class="opponent-btn flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-slate-100 dark:border-slate-800 transition-all hover:border-arena-blue relative overflow-hidden group shrink-0 w-24 snap-center min-h-[100px] bg-white dark:bg-slate-900/50">
                        <img src="${avatar}" class="w-12 h-12 rounded-full border border-slate-200 shadow-sm transition-transform group-hover:scale-110">
                        <div class="flex flex-col items-center min-w-0 w-full">
                            <span class="text-[9px] font-black text-center truncate w-full text-slate-800 dark:text-white uppercase">${name}</span>
                            <div class="flex gap-1 mt-1">
                                <span class="text-[7px] font-black text-emerald-500">${wins}T</span>
                                <span class="text-[7px] font-black text-blue-500">${draws}H</span>
                                <span class="text-[7px] font-black text-rose-500">${losses}B</span>
                            </div>
                        </div>
                    </button>`;
                }).join('');

            } catch (err) {
                console.error("Render error:", err);
                list.innerHTML = `<div class="p-4 text-rose-500 text-[10px] font-bold">L·ªói n·∫°p d·ªØ li·ªáu: ${err.message}</div>`;
            }
        }
    </script>
</body>

</html>