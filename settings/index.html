<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Cấu hình hệ thống - LevelUp Kids</title>
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="../shared/css/global.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Shared Scripts -->
    <script src="../shared/js/state.js"></script>
    <script src="../shared/js/components.js?v=2.0.9" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ee9d2b", "primary-dark": "#d48215", "text-main": "#181511", "text-muted": "#897961" }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-[#221a10] text-text-main min-h-screen">
    <div class="flex">
        <!-- Sidebar Component -->
        <parent-sidebar active="settings"></parent-sidebar>

        <main class="flex-1 p-4 md:p-6 lg:p-10 h-screen overflow-y-auto">
            <header class="flex items-center justify-between mb-6 md:mb-10 gap-4">
                <div>
                    <h2 class="text-2xl md:text-4xl font-black text-slate-800 dark:text-white tracking-tighter">Cấu hình
                        hệ thống</h2>
                    <p class="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest font-black">Thiết
                        lập chung cho ứng dụng gia đình</p>
                </div>
                <button onclick="window.toggleParentSidebar(true)"
                    class="lg:hidden p-3 bg-primary text-white rounded-2xl shadow-lg shadow-primary/30 hover:scale-110 active:scale-95 transition-all outline-none">
                    <span class="material-symbols-outlined text-2xl">menu</span>
                </button>
            </header>

            <div class="max-w-4xl space-y-8">
                <!-- Security Settings -->
                <section
                    class="bg-white dark:bg-[#2c2215] p-5 md:p-8 rounded-2xl md:rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 transition-all hover:shadow-md">
                    <div class="flex items-center gap-3 mb-8">
                        <span class="material-symbols-outlined text-primary text-3xl">security</span>
                        <h3 class="text-xl font-bold dark:text-white">Bảo mật & Mã PIN</h3>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 px-1">Mã PIN
                                hiện tại</label>
                            <div class="relative">
                                <input type="password" id="current-pin" readonly
                                    class="w-full px-5 py-4 bg-slate-50 dark:bg-slate-800/50 border-2 border-slate-100 dark:border-slate-800 rounded-2xl outline-none font-bold text-slate-400"
                                    value="****">
                                <span
                                    class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-300">lock</span>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2 px-1 italic">Mặc định ban đầu là 1234. Đây là mã
                                để vào chế độ phụ huynh.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 px-1">Thiết
                                lập mã PIN mới</label>
                            <input type="text" id="new-pin" maxlength="4"
                                class="w-full px-5 py-4 bg-slate-100 dark:bg-slate-800 border-2 border-transparent focus:border-primary rounded-2xl outline-none font-bold text-lg dark:text-white transition-all shadow-inner placeholder:text-slate-400"
                                placeholder="Nhập 4 chữ số mới">
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button onclick="saveSettings()"
                            class="w-full md:w-auto px-12 py-4 bg-primary text-white font-black rounded-2xl shadow-lg shadow-primary/30 hover:scale-105 active:scale-95 transition-all text-sm uppercase tracking-widest">
                            Lưu thay đổi mã PIN
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        async function saveSettings() {
            const newPin = document.getElementById('new-pin').value;
            if (newPin && newPin.length !== 4) {
                window.showLevelUpAlert('Lỗi', 'Mã PIN phải có đúng 4 chữ số!', 'error');
                return;
            }

            if (window.AppState && newPin) {
                // Find parent user and update PIN
                const parent = window.AppState.data.leaderboard.find(u => u.role === 'parent');
                if (parent) {
                    const { error } = await window.AppState.client
                        .from('profiles')
                        .update({ pin_code: newPin })
                        .eq('id', parent.id);

                    if (error) {
                        window.showLevelUpAlert('Lỗi', 'Không thể cập nhật mã PIN: ' + error.message, 'error');
                    } else {
                        window.showLevelUpAlert('Thành công', 'Đã lưu cấu hình mới!', 'success');
                        document.getElementById('new-pin').value = '';
                    }
                }
            } else {
                window.showLevelUpAlert('Thành công', 'Đã lưu cấu hình (Giao diện mẫu)!', 'success');
            }
        }
    </script>
</body>

</html>