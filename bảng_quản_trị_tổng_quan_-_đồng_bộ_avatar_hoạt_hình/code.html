<!DOCTYPE html>

<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Bảng Quản Trị Tổng Quan</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />

    <script src="../shared/js/state.js"></script>
    <script src="../shared/js/components.js" defer></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b",
                        "background-light": "#f8f7f6",
                        "background-dark": "#221a10",
                    },
                    fontFamily: {
                        "display": ["Montserrat", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen font-['Montserrat']">
    <div class="flex h-screen overflow-hidden">
        <!-- Intelligent Sidebar Component -->
        <parent-sidebar active="dashboard"></parent-sidebar>
        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-y-auto bg-background-light dark:bg-background-dark">
            <!-- Header -->
            <header
                class="h-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-8 flex items-center justify-between sticky top-0 z-10">
                <h2 class="text-xl font-bold tracking-tight">Bảng Quản Trị Tổng Quan</h2>
                <div class="flex items-center gap-6">
                    <div
                        class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700">
                        <button
                            onclick="this.parentElement.querySelectorAll('button').forEach(b => { b.className = 'flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg' }); this.className = 'flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-medium text-slate-900';"
                            class="flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-medium text-slate-900">
                            <span
                                class="w-6 h-6 rounded-full bg-blue-200 flex items-center justify-center text-[10px] font-bold text-blue-700">BO</span>
                            <span>Tất cả con</span>
                        </button>
                        <button
                            onclick="this.parentElement.querySelectorAll('button').forEach(b => { b.className = 'flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg' }); this.className = 'flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-medium text-slate-900';"
                            class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg">
                            <span>Bé Bo</span>
                        </button>
                        <button
                            onclick="this.parentElement.querySelectorAll('button').forEach(b => { b.className = 'flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg' }); this.className = 'flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-medium text-slate-900';"
                            class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg">
                            <span>Tí Nị</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-3 border-l border-slate-200 dark:border-slate-800 pl-6">
                        <button onclick="openPinModal()" title="Đổi Mã PIN"
                            class="size-10 rounded-full flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors relative text-slate-500 hover:text-primary">
                            <span class="material-symbols-outlined">password</span>
                        </button>
                        <notification-bell></notification-bell>
                        <div class="size-10 rounded-full bg-cover bg-center border-2 border-primary/20"
                            data-alt="Portrait of a smiling mother"
                            style="background-image: url('https://ui-avatars.com/api/?name=Mom&background=f472b6&color=fff')">
                        </div>
                    </div>
                </div>
            </header>
            <div class="p-8 space-y-8">
                <!-- Quick Stats -->
                <section>
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold">Thống kê tiến độ con</h3>
                        <button onclick="window.location.href='../bảng_điều_khiển_báo_cáo_phụ_huynh/code.html'"
                            class="text-primary text-sm font-semibold hover:underline">Xem báo cáo chi tiết</button>
                    </div>
                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-10">

                        <!-- Left Column (Stats & Tasks) -->
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Progress Statistics -->
                            <section
                                class="bg-white dark:bg-slate-900 rounded-3xl p-8 border border-slate-100 dark:border-slate-800 shadow-sm">
                                <div class="flex items-center justify-between mb-8">
                                    <h3
                                        class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400 uppercase tracking-wider">
                                        Thống kê tiến độ con</h3>
                                    <button
                                        onclick="window.location.href='../bảng_điều_khiển_báo_cáo_phụ_huynh/code.html'"
                                        class="flex items-center gap-2 text-primary font-bold hover:gap-3 transition-all">
                                        <span class="text-sm">Xem chi tiết</span>
                                        <span class="material-symbols-outlined text-sm">arrow_forward</span>
                                    </button>
                                </div>
                                <div id="children-stats-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Dynamic content injected by JS -->
                                </div>
                            </section>

                            <!-- Pending Tasks List -->
                            <section class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h3
                                        class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400 uppercase tracking-wider">
                                        Nhiệm vụ chờ duyệt mới nhất</h3>
                                    <span
                                        class="text-xs font-black text-primary bg-primary/10 px-4 py-1.5 rounded-full uppercase tracking-wider">5
                                        nhiệm vụ</span>
                                </div>
                                <div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 overflow-hidden shadow-sm"
                                    id="pending-tasks-container">
                                    <!-- Dynamically replaced by JS -->
                                </div>
                                <button
                                    onclick="window.location.href='../phê_duyệt_nhiệm_vụ_-_đồng_bộ_avatar_hoạt_hình/code.html'"
                                    class="w-full py-5 text-sm font-black text-slate-400 hover:text-primary transition-all uppercase tracking-widest bg-slate-50 dark:bg-white/5 rounded-2xl border border-dashed border-slate-200 dark:border-slate-800">
                                    Xem tất cả nhiệm vụ chờ
                                </button>
                            </section>
                        </div>

                        <!-- Right Column (Activity Sidebar) -->
                        <div class="lg:col-span-1 space-y-8">
                            <section class="space-y-4 sticky top-8">
                                <h3
                                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400 uppercase tracking-wider">
                                    Hoạt động gần đây</h3>
                                <div id="recent-activities-container"
                                    class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 p-8 shadow-sm space-y-8">
                                    <div class="flex gap-4">
                                        <img class="size-5 rounded-full mt-1 shrink-0"
                                            src="../shared/assets/avatar-1.png"
                                            onerror="this.src='https://ui-avatars.com/api/?name=Bo&background=fbcfe8'" />
                                        <div>
                                            <p class="text-sm font-medium">Bé Bo đã đổi phần thưởng <span
                                                    class="text-primary">"Xem
                                                    phim"</span></p>
                                            <p class="text-[11px] text-slate-400 mt-1">2 giờ trước</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4">
                                        <img class="size-5 rounded-full mt-1 shrink-0"
                                            src="../shared/assets/avatar-2.png"
                                            onerror="this.src='https://ui-avatars.com/api/?name=Ni&background=bfdbfe'" />
                                        <div>
                                            <p class="text-sm font-medium">Tí Nị đã hoàn thành thử thách <span
                                                    class="text-primary">"Dậy sớm 7 ngày"</span></p>
                                            <p class="text-[11px] text-slate-400 mt-1">Sáng nay</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4">
                                        <img class="size-5 rounded-full mt-1 shrink-0"
                                            src="https://ui-avatars.com/api/?name=Mom&background=f472b6&color=fff" />
                                        <div>
                                            <p class="text-sm font-medium">Mẹ đã thêm 3 nhiệm vụ mới cho ngày mai</p>
                                            <p class="text-[11px] text-slate-400 mt-1">Hôm qua</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4">
                                        <div class="size-2 bg-primary rounded-full mt-1.5 shrink-0"></div>
                                        <div>
                                            <p class="text-sm font-medium">Gia đình đã đạt cột mốc <span
                                                    class="text-primary">500
                                                    điểm</span> thưởng</p>
                                            <p class="text-[11px] text-slate-400 mt-1">3 ngày trước</p>
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <div class="bg-primary/5 rounded-xl p-4 border border-primary/10">
                                            <p class="text-xs font-bold text-primary uppercase tracking-wide">Mẹo hôm
                                                nay</p>
                                            <p class="text-sm mt-1 text-slate-700 dark:text-slate-300">Khuyến khích Bé
                                                Bo làm
                                                bài tập sớm để nhận thêm điểm thưởng nhân đôi!</p>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <script>
                        const updateDashboardUI = () => {
                            if (!window.AppState) return;
                            const leaderboard = window.AppState.data.leaderboard || [];
                            const familyMembers = leaderboard.filter(u => u.role === 'child');

                            // 1. Update Header View Switcher
                            const switcher = document.querySelector('.flex.items-center.gap-2.bg-slate-100');
                            if (switcher) {
                                let switcherHtml = `
                                    <button onclick="filterByChild('all')" id="btn-all"
                                        class="flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-medium text-slate-900 transition-all">
                                        <span>Tất cả con</span>
                                    </button>
                                `;
                                familyMembers.forEach(m => {
                                    switcherHtml += `
                                        <button onclick="filterByChild('${m.id}')" id="btn-${m.id}"
                                            class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg">
                                            <span>${m.name}</span>
                                        </button>
                                    `;
                                });
                                switcher.innerHTML = switcherHtml;
                            }

                            // 2. Update Children Cards
                            const grid = document.getElementById('children-stats-grid');
                            let gridHtml = '';

                            familyMembers.forEach(member => {
                                const total = window.AppState.data.quests.length || 1;
                                const completed = window.AppState.data.quests.filter(q => q.completedBy && q.completedBy.includes(member.id)).length;
                                const percent = total > 0 ? Math.min(100, Math.floor((completed / total) * 100)) : 0;
                                const colorClass = percent >= 80 ? 'primary' : (percent >= 50 ? 'blue-400' : 'slate-400');

                                gridHtml += `
                                    <div class="child-stat-card bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex items-center gap-6" data-child-id="${member.id}">
                                        <div class="size-20 bg-primary/10 rounded-2xl flex items-center justify-center shrink-0">
                                            <img src="${member.avatar}" class="size-16 rounded-full object-cover border-2 border-white dark:border-slate-800 shadow-sm" />
                                        </div>
                                        <div class="flex-1 space-y-3">
                                            <div class="flex justify-between items-end">
                                                <div>
                                                    <h4 class="font-bold text-lg">${member.name}</h4>
                                                    <p class="text-xs text-slate-500 font-medium">${completed} nhiệm vụ hoàn thành</p>
                                                </div>
                                                <span class="text-2xl font-black text-${colorClass}">${percent}%</span>
                                            </div>
                                            <div class="w-full bg-slate-100 dark:bg-slate-800 h-2.5 rounded-full overflow-hidden">
                                                <div class="bg-${colorClass} h-full rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="flex gap-2 font-bold">
                                                <span class="text-[10px] bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 px-2.5 py-1 rounded-full shrink-0">Cấp: ${member.level}</span>
                                                <span class="text-[10px] bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400 px-2.5 py-1 rounded-full shrink-0">${member.gold} Vàng</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            grid.innerHTML = gridHtml;

                            // 3. Update Pending Tasks section dynamically
                            const pendingContainer = document.getElementById('pending-tasks-container');
                            const countLabel = document.querySelector('.text-xs.font-black.text-primary.bg-primary\\/10');
                            const pendingTasks = window.AppState.data.requests.filter(r => r.status === 'pending' && r.type === 'task');

                            if (countLabel) {
                                countLabel.innerText = `${pendingTasks.length} nhiệm vụ tổng cộng`;
                            }

                            if (pendingContainer) {
                                if (pendingTasks.length === 0) {
                                    pendingContainer.innerHTML = '<div class="p-12 text-center text-slate-400 font-bold dark:text-slate-500">Tuyệt vời! Không có nhiệm vụ nào đang chờ duyệt.</div>';
                                } else {
                                    const topTasks = pendingTasks.slice(0, 3);
                                    let listHtml = '<div class="divide-y divide-slate-100 dark:divide-slate-800">';
                                    topTasks.forEach(req => {
                                        let icon = 'task_alt';
                                        const t = (req.itemTitle || '').toLowerCase();
                                        if (t.includes('\u0111\u1ecdc')) icon = 'auto_stories';
                                        if (t.includes('d\u1ecdn')) icon = 'cleaning_services';
                                        if (t.includes('m\u00e8o') || t.includes('ch\u00f3')) icon = 'pets';

                                        const safeTitle = (req.itemTitle || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                        const safeUser = (req.user || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                                        const safeTime = req.time || '';
                                        const safeId = req.id || '';

                                        listHtml += `
                                            <div class="p-6 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                                <div class="flex items-center gap-5">
                                                    <div class="size-14 bg-background-light dark:bg-slate-800 rounded-xl flex items-center justify-center shrink-0 border border-slate-100 dark:border-slate-700 shadow-sm">
                                                        <span class="material-symbols-outlined text-primary text-2xl">${icon}</span>
                                                    </div>
                                                    <div>
                                                        <h5 class="font-bold text-slate-800 dark:text-white">${safeTitle}</h5>
                                                        <p class="text-xs text-slate-500 mt-1 font-medium">Người thực hiện: <span class="text-primary font-bold">${safeUser}</span> &bull; ${safeTime}</p>
                                                    </div>
                                                </div>
                                                <div class="flex gap-3">
                                                    <button class="px-5 py-2 text-xs font-black border border-slate-200 dark:border-slate-700 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-all uppercase tracking-wider" onclick="rejectTaskOverview('${safeId}')">Từ chối</button>
                                                    <button class="px-5 py-2 text-xs font-black bg-primary text-white rounded-xl shadow-lg shadow-primary/20 hover:scale-105 active:scale-95 transition-all uppercase tracking-wider" onclick="approveTaskOverview('${safeId}')">Phê duyệt</button>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    listHtml += '</div>';
                                    pendingContainer.innerHTML = listHtml;
                                }
                            }

                            // 4. Update Recent Activity dynamically
                            const activityContainer = document.getElementById('recent-activities-container');
                            if (activityContainer && window.AppState.data.requests) {
                                const recentActivity = window.AppState.data.requests.slice(0, 5);
                                let newActivityHtml = '';
                                recentActivity.forEach(r => {
                                    const user = familyMembers.find(u => u.id === r.profileId) || { avatar: '', name: r.user };
                                    const actionTitle = r.type === 'task' ? 'đã hoàn thành nhiệm vụ' : 'đã đổi phần thưởng';

                                    newActivityHtml += `
                                        <div class="flex gap-4 group">
                                            <div class="relative shrink-0">
                                                <img class="size-10 rounded-full bg-slate-100 ring-2 ring-white dark:ring-slate-800" src="${user.avatar}"
                                                    onerror="this.src='https://ui-avatars.com/api/?name=${r.user}&background=fbcfe8'" />
                                                <div class="absolute -bottom-1 -right-1 size-5 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center shadow-sm">
                                                    <span class="material-symbols-outlined text-[12px] text-primary">${r.type === 'task' ? 'task_alt' : 'redeem'}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <p class="text-sm font-bold text-slate-800 dark:text-slate-200 leading-tight">
                                                    ${r.user} <span class="font-medium text-slate-500 font-normal underline decoration-slate-200 dark:decoration-slate-800 underline-offset-4">${actionTitle}</span>
                                                </p>
                                                <p class="text-sm font-black text-primary mt-0.5">"${r.itemTitle}"</p>
                                                <p class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-wider">${r.time}</p>
                                            </div>
                                        </div>
                                    `;
                                });

                                // Mẹo hôm nay
                                newActivityHtml += `
                                    <div class="pt-4 border-t border-slate-100 dark:border-slate-800">
                                        <div class="bg-gradient-to-br from-primary/10 to-transparent rounded-2xl p-5 border border-primary/10 relative overflow-hidden group">
                                            <span class="material-symbols-outlined absolute -right-2 -bottom-2 text-6xl text-primary/5 group-hover:scale-110 transition-transform duration-500">lightbulb</span>
                                            <p class="text-xs font-black text-primary uppercase tracking-widest flex items-center gap-2 mb-2">
                                                <span class="material-symbols-outlined text-sm">auto_awesome</span>
                                                Mẹo hôm nay
                                            </p>
                                            <p class="text-sm text-slate-600 dark:text-slate-400 font-medium leading-relaxed">Rèn luyện tính tự lập cho con bằng cách cùng lập kế hoạch nhiệm vụ mỗi tối. Hãy tặng con sticker khi hoàn thành tốt!</p>
                                        </div>
                                    </div>
                                `;
                                activityContainer.innerHTML = newActivityHtml;
                            }
                        };

                        window.filterByChild = (childId) => {
                            const btns = document.querySelectorAll('.flex.items-center.gap-2.bg-slate-100 button');
                            btns.forEach(btn => {
                                if (btn.id === `btn-${childId}`) {
                                    btn.className = 'flex items-center gap-2 px-3 py-1.5 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-medium text-slate-900 transition-all';
                                } else {
                                    btn.className = 'flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-500 hover:text-slate-900 transition-colors rounded-lg';
                                }
                            });

                            const cards = document.querySelectorAll('.child-stat-card');
                            cards.forEach(card => {
                                if (childId === 'all' || card.dataset.childId === childId) {
                                    card.style.display = 'flex';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        };

                        window.approveTaskOverview = (reqId) => {
                            if (window.AppState) {
                                window.AppState.markRequestDelivered(reqId);
                                updateDashboardUI();
                            }
                        };

                        window.rejectTaskOverview = (reqId) => {
                            if (window.AppState) {
                                window.AppState.rejectRequest(reqId);
                                updateDashboardUI();
                            }
                        };

                        document.addEventListener('DOMContentLoaded', () => {
                            const waitForState = () => {
                                if (window.AppState) {
                                    window.AppState.subscribe(() => updateDashboardUI());
                                    updateDashboardUI();
                                } else {
                                    setTimeout(waitForState, 100);
                                }
                            };
                            waitForState();
                        });
                    </script>
                    <footer
                        class="mt-auto p-8 border-t border-slate-200 dark:border-slate-800 text-center text-slate-400 text-xs">
                        © 2024 Gia Đình Nguyễn • Bảng Điều Khiển Quản Trị Phụ Huynh
                    </footer>
        </main>
    </div>
    <!-- Change PIN Modal -->
    <div id="change-pin-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white dark:bg-[#1a140d] p-8 rounded-[2rem] shadow-2xl border-4 border-white/10 max-w-sm w-full mx-4 transform translate-y-10 opacity-0 transition-all duration-300 relative">
            <button onclick="closePinModal()"
                class="absolute top-4 right-4 text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 p-2 rounded-full transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="text-center mb-8 pt-4">
                <div
                    class="size-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-blue-200 dark:border-blue-800">
                    <span class="material-symbols-outlined text-3xl text-blue-500">lock_reset</span>
                </div>
                <h3 class="text-2xl font-black text-slate-800 dark:text-white mb-2">Đổi Mã PIN</h3>
                <p class="text-slate-500 text-sm font-medium">Nhập 4 số cho mã PIN mới của bạn</p>
            </div>

            <!-- PIN Display -->
            <div class="flex justify-center gap-3 mb-8 h-4">
                <div id="new-pin-1" class="w-4 h-4 rounded-full bg-slate-200 dark:bg-slate-700 transition-colors"></div>
                <div id="new-pin-2" class="w-4 h-4 rounded-full bg-slate-200 dark:bg-slate-700 transition-colors"></div>
                <div id="new-pin-3" class="w-4 h-4 rounded-full bg-slate-200 dark:bg-slate-700 transition-colors"></div>
                <div id="new-pin-4" class="w-4 h-4 rounded-full bg-slate-200 dark:bg-slate-700 transition-colors"></div>
            </div>

            <!-- Numpad -->
            <div class="grid grid-cols-3 gap-3">
                <button onclick="addNewPin(1)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">1</button>
                <button onclick="addNewPin(2)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">2</button>
                <button onclick="addNewPin(3)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">3</button>
                <button onclick="addNewPin(4)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">4</button>
                <button onclick="addNewPin(5)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">5</button>
                <button onclick="addNewPin(6)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">6</button>
                <button onclick="addNewPin(7)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">7</button>
                <button onclick="addNewPin(8)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">8</button>
                <button onclick="addNewPin(9)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">9</button>
                <button onclick="removeNewPin()"
                    class="h-14 rounded-xl bg-red-50 dark:bg-red-900/30 text-red-500 font-bold flex items-center justify-center hover:bg-red-100 transition-colors">
                    <span class="material-symbols-outlined">backspace</span>
                </button>
                <button onclick="addNewPin(0)"
                    class="h-14 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-800 dark:text-white text-2xl font-black hover:bg-slate-200 transition-colors">0</button>
                <button class="h-14 rounded-xl bg-transparent"></button>
            </div>

            <p id="new-pin-msg"
                class="text-green-500 text-sm font-bold text-center mt-4 h-5 opacity-0 transition-opacity">
                Đổi PIN thành công!</p>
        </div>
    </div>

    <script>
        let inputPin = "";

        function openPinModal() {
            const modal = document.getElementById('change-pin-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.children[0].classList.remove('translate-y-10', 'opacity-0');
            }, 10);
        }

        function closePinModal() {
            const modal = document.getElementById('change-pin-modal');
            modal.children[0].classList.add('translate-y-10', 'opacity-0');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);

            inputPin = "";
            renderPinDots();
            document.getElementById('new-pin-msg').classList.add('opacity-0');
        }

        function renderPinDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`new-pin-${i}`);
                if (i <= inputPin.length) {
                    dot.classList.remove('bg-slate-200', 'dark:bg-slate-700');
                    dot.classList.add('bg-blue-500');
                } else {
                    dot.classList.add('bg-slate-200', 'dark:bg-slate-700');
                    dot.classList.remove('bg-blue-500');
                }
            }
        }

        function addNewPin(num) {
            if (inputPin.length < 4) {
                inputPin += num;
                renderPinDots();

                if (inputPin.length === 4) {
                    savePinToDatabase();
                }
            }
        }

        function removeNewPin() {
            if (inputPin.length > 0) {
                inputPin = inputPin.slice(0, -1);
                renderPinDots();
                document.getElementById('new-pin-msg').classList.add('opacity-0');
            }
        }

        function savePinToDatabase() {
            if (window.AppState) {
                window.AppState.updatePin(inputPin).then(() => {
                    const msgText = document.getElementById('new-pin-msg');
                    msgText.classList.remove('opacity-0');
                    setTimeout(() => {
                        closePinModal();
                    }, 1500);
                });
            }
        }
    </script>
</body>

</html>