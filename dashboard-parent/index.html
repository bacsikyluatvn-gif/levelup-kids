<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Báo cáo Phân tích - LevelUp Kids</title>
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="../shared/css/global.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Shared Scripts -->
    <script src="../shared/js/state.js"></script>
    <script src="../shared/js/components.js" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ee9d2b", "primary-dark": "#d48215", "text-main": "#181511", "text-muted": "#897961" }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-[#221a10] text-text-main min-h-screen">

    <div class="flex">
        <!-- Intelligent Sidebar Component -->
        <parent-sidebar active="insights"></parent-sidebar>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-6 lg:p-10 h-screen">

            <!-- Header Section -->
            <header class="flex flex-col xl:flex-row xl:items-center justify-between mb-10 gap-6">
                <div>
                    <h2 id="report-title" class="text-4xl font-black text-slate-800 dark:text-white tracking-tighter">
                        Báo cáo Tổng quan</h2>
                    <p id="report-subtitle"
                        class="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest font-black">Phân
                        tích tiến trình rèn luyện của các con</p>

                    <!-- View Switcher -->
                    <div id="child-switcher"
                        class="flex items-center gap-2 bg-slate-100 dark:bg-[#1f160a] p-1.5 rounded-xl border border-slate-200 dark:border-slate-800 mt-6 inline-flex">
                        <button id="btn-all" onclick="changeReport('all')"
                            class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-[#2c2215] rounded-lg shadow-sm text-sm font-bold text-slate-900 dark:text-white transition-all">
                            <span>Tất cả con</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div
                        class="flex items-center gap-4 bg-white dark:bg-[#2c2215] p-2 pr-6 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm min-w-[200px]">
                        <div class="size-12 rounded-xl border-4 border-primary/20 p-0.5">
                            <img alt="Parent" class="w-full h-full rounded-lg object-cover"
                                src="https://ui-avatars.com/api/?name=Bố+M&background=ee9d2b&color=fff" />
                        </div>
                        <div class="hidden sm:block text-left">
                            <p class="text-sm font-black text-slate-800 dark:text-white leading-none">Minh Trần</p>
                            <p class="text-[10px] text-primary font-black uppercase tracking-widest mt-1">Admin</p>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
                <!-- Main Content: Stats and Analytics -->
                <div class="xl:col-span-2 space-y-10">
                    <!-- Stat Cards Grid -->
                    <section id="stat-cards-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stat cards injected here -->
                    </section>

                    <!-- Charts and Analytics -->
                    <div
                        class="bg-white dark:bg-[#2c2215] p-8 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full -mr-32 -mt-32 blur-3xl">
                        </div>

                        <div class="relative z-10">
                            <div
                                class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10 gap-4">
                                <div>
                                    <h4 id="chart-title"
                                        class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-wider flex items-center gap-2">
                                        <span class="material-symbols-outlined text-primary">analytics</span>
                                        Tiến trình của các con
                                    </h4>
                                    <p class="text-xs text-slate-500 font-medium mt-1">Dữ liệu hoàn thành nhiệm vụ theo
                                        thời gian</p>
                                </div>
                                <div id="chart-legend" class="flex flex-wrap gap-4">
                                    <!-- Dynamic legend injected by updateReportUI() -->
                                </div>
                            </div>

                            <!-- Styled Chart Container -->
                            <div
                                class="relative h-72 w-full bg-slate-50/50 dark:bg-slate-900/40 rounded-3xl border border-slate-100/50 dark:border-slate-800/50 p-8 flex gap-6">
                                <!-- Y-Axis Labels -->
                                <div
                                    class="flex flex-col justify-between text-[10px] font-black text-slate-400 uppercase h-full pb-8">
                                    <span>20</span>
                                    <span>15</span>
                                    <span>10</span>
                                    <span>5</span>
                                    <span>0</span>
                                </div>

                                <div class="relative flex-1 h-full">
                                    <div
                                        class="absolute inset-0 flex flex-col justify-between opacity-10 pointer-events-none pb-8 h-full">
                                        <div class="border-t border-slate-400 dark:border-slate-500 w-full"></div>
                                        <div class="border-t border-slate-400 dark:border-slate-500 w-full"></div>
                                        <div class="border-t border-slate-400 dark:border-slate-500 w-full"></div>
                                        <div class="border-t border-slate-400 dark:border-slate-500 w-full"></div>
                                        <div class="border-t border-slate-400 dark:border-slate-500 w-full"></div>
                                    </div>

                                    <div class="h-full w-full flex items-end justify-around gap-2 relative z-10">
                                        <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 400 150">
                                            <defs>
                                                <linearGradient id="grad-bo" x1="0%" y1="0%" x2="0%" y2="100%">
                                                    <stop offset="0%" style="stop-color:#ee9d2b;stop-opacity:0.8" />
                                                    <stop offset="100%" style="stop-color:#ee9d2b;stop-opacity:0.1" />
                                                </linearGradient>
                                                <linearGradient id="grad-ni" x1="0%" y1="0%" x2="0%" y2="100%">
                                                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:0.8" />
                                                    <stop offset="100%" style="stop-color:#60a5fa;stop-opacity:0.1" />
                                                </linearGradient>
                                            </defs>
                                            <path id="line-bo"
                                                d="M0,130 C40,120 60,40 100,60 C140,80 180,20 220,50 C260,80 340,110 400,40"
                                                fill="none" stroke="url(#grad-bo)" stroke-width="6"
                                                stroke-linecap="round"
                                                class="transition-all duration-1000 drop-shadow-[0_8px_16px_rgba(238,157,43,0.3)]">
                                            </path>
                                            <path id="line-ni"
                                                d="M0,140 C50,130 80,100 120,110 C160,120 200,60 250,80 C300,100 350,50 400,90"
                                                fill="none" stroke="url(#grad-ni)" stroke-width="6"
                                                stroke-linecap="round"
                                                class="transition-all duration-1000 drop-shadow-[0_8px_16px_rgba(96,165,250,0.3)]">
                                            </path>
                                        </svg>
                                    </div>

                                    <!-- X-Axis Labels -->
                                    <div
                                        class="absolute bottom-0 left-0 right-0 flex justify-between px-2 translate-y-6 text-[10px] font-black text-slate-400 uppercase tracking-tighter">
                                        <span>Thứ 2</span>
                                        <span>Thứ 3</span>
                                        <span>Thứ 4</span>
                                        <span>Thứ 5</span>
                                        <span>Thứ 6</span>
                                        <span>Thứ 7</span>
                                        <span>Chủ Nhật</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div
                        class="bg-white dark:bg-[#2c2215] p-8 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800">
                        <h4
                            class="text-xl font-black text-slate-800 dark:text-white mb-8 uppercase tracking-wider flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">vitals</span>
                            Hiệu suất theo hạng mục
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8 stats-container">
                            <!-- Bars are rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Right Column: Activity Feed & Insights -->
                <div class="xl:col-span-1 space-y-10">
                    <!-- Child Focus Card -->
                    <div id="child-focus-card"
                        class="bg-primary text-white p-8 rounded-[2.5rem] shadow-xl shadow-primary/20 relative overflow-hidden group">
                        <div
                            class="absolute -right-8 -bottom-8 opacity-20 group-hover:scale-110 transition-transform duration-700">
                            <span id="insight-icon" class="material-symbols-outlined text-[150px]">rocket_launch</span>
                        </div>
                        <div class="relative z-10">
                            <h5 class="text-xs font-black uppercase tracking-widest opacity-80 mb-2">Lời khuyên hệ thống
                            </h5>
                            <h4 id="insight-title" class="text-2xl font-black leading-tight mb-4">Đang tải phân tích...
                            </h4>
                            <p id="insight-desc" class="text-sm font-medium opacity-90 leading-relaxed mb-6">Hệ thống
                                đang phân tích dữ liệu rèn luyện của các con.</p>
                            <button id="insight-btn" onclick="navigateWithTransition('../manage-shop/index.html')"
                                class="bg-white text-primary font-black px-6 py-3 rounded-xl text-xs hover:bg-slate-50 transition-all shadow-lg active:scale-95">
                                XEM CỬA HÀNG QUÀ
                            </button>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div
                        class="bg-white dark:bg-[#2c2215] p-8 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 h-fit">
                        <div class="flex items-center justify-between mb-8">
                            <h4 class="text-lg font-black text-slate-800 dark:text-white uppercase tracking-wider">Hoạt
                                động mới</h4>
                            <span class="text-xs font-bold text-primary cursor-pointer hover:underline">Tất cả</span>
                        </div>
                        <activity-feed></activity-feed>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentView = 'all';

        const renderBar = (label, value, color) => {
            const safeValue = Math.min(100, Math.max(0, value || 0));
            return `
            <div>
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">${label}</span>
                    <span class="text-sm font-black text-slate-800 dark:text-white">${safeValue}%</span>
                </div>
                <div class="w-full h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden p-0.5">
                    <div class="h-full bg-gradient-to-r ${color === 'primary' ? 'from-amber-400 to-primary' : 'from-blue-400 to-blue-600'} rounded-full transition-all duration-1000" style="width: ${safeValue}% shadow: 0 0 10px rgba(238,157,43,0.2)"></div>
                </div>
            </div>
        `;
        };

        const updateReportUI = () => {
            if (!window.AppState) return;
            const leaderboard = window.AppState.data.leaderboard || [];
            const familyMembers = leaderboard.filter(u => u.role === 'child');

            // 1. Update View Switcher Buttons
            const switcher = document.getElementById('child-switcher');
            let switcherHtml = `
                <button id="btn-all" onclick="changeReport('all')"
                    class="flex items-center gap-2 px-4 py-2 ${currentView === 'all' ? 'bg-white dark:bg-[#2c2215] shadow-sm text-slate-900 dark:text-white font-bold' : 'text-slate-500 hover:text-slate-900 dark:hover:text-white font-medium'} rounded-lg transition-all text-sm">
                    <span>Tất cả con</span>
                </button>
            `;

            familyMembers.forEach(member => {
                switcherHtml += `
                    <button id="btn-${member.id}" onclick="changeReport('${member.id}')"
                        class="flex items-center gap-2 px-4 py-2 ${currentView === member.id ? 'bg-white dark:bg-[#2c2215] shadow-sm text-slate-900 dark:text-white font-bold' : 'text-slate-500 hover:text-slate-900 dark:hover:text-white font-medium'} rounded-lg transition-all text-sm">
                        <span>${member.name}</span>
                    </button>
                `;
            });
            switcher.innerHTML = switcherHtml;

            // 2. Prepare Data based on current view
            let displayData = {
                title: "Báo cáo Tổng quan",
                subtitle: "Phân tích tiến trình rèn luyện của các con",
                completed: 0,
                gold: 0,
                streak: 0,
                chartTitle: "Tiến trình của các con",
                bars: [],
                activeChildrenIds: []
            };

            if (currentView === 'all') {
                const allQuests = window.AppState.data.quests || [];
                displayData.completed = familyMembers.reduce((sum, m) => sum + allQuests.filter(q => q.completedBy && q.completedBy.includes(m.id)).length, 0);
                displayData.gold = familyMembers.reduce((sum, m) => sum + (m.gold || 0), 0).toLocaleString();
                displayData.streak = (familyMembers.reduce((sum, m) => sum + (m.weeklyStreak || 0), 0) / (familyMembers.length || 1)).toFixed(1);
                displayData.activeChildrenIds = familyMembers.map(m => m.id);

                displayData.bars = [
                    { label: 'Học tập', value: 88, color: 'primary' },
                    { label: 'Nhà cửa', value: 75, color: 'blue-500' },
                    { label: 'Vệ sinh', value: 92, color: 'primary' },
                    { label: 'Kỹ năng', value: 65, color: 'blue-500' }
                ];
            } else {
                const member = familyMembers.find(m => m.id === currentView);
                if (member) {
                    const allQuests = window.AppState.data.quests || [];
                    displayData.title = `Báo cáo của ${member.name}`;
                    displayData.completed = allQuests.filter(q => q.completedBy && q.completedBy.includes(member.id)).length;
                    displayData.gold = (member.gold || 0).toLocaleString();
                    displayData.streak = member.weeklyStreak || 0;
                    displayData.chartTitle = `Tiến trình của ${member.name}`;
                    displayData.activeChildrenIds = [member.id];

                    displayData.bars = [
                        { label: 'Học tập', value: 60 + (member.level * 2), color: 'primary' },
                        { label: 'Nhà cửa', value: 50 + (member.level * 3), color: 'primary' },
                        { label: 'Vệ sinh', value: 70 + (member.level * 1), color: 'primary' },
                        { label: 'Kỹ năng', value: 40 + (member.level * 4), color: 'primary' }
                    ];
                }
            }

            // 3. Update Header
            document.getElementById('report-title').innerText = displayData.title;

            // 4. Update Stat Cards
            document.getElementById('stat-cards-container').innerHTML = `
                <stat-card icon="task_alt" title="Nhiệm vụ xong" value="${displayData.completed}" trend="" color="emerald"></stat-card>
                <stat-card icon="payments" title="Vàng tích lũy" value="${displayData.gold}" trend="" color="primary"></stat-card>
                <stat-card icon="local_fire_department" title="Chuỗi ngày" value="${displayData.streak}" trend="" color="rose"></stat-card>
            `;

            // 5. Update Categories
            document.querySelector('.stats-container').innerHTML = displayData.bars.map(b => renderBar(b.label, b.value, b.color)).join('');

            // 6. Update Dynamic Insights
            const insightTitle = document.getElementById('insight-title');
            const insightDesc = document.getElementById('insight-desc');
            const insightIcon = document.getElementById('insight-icon');
            const insightBtn = document.getElementById('insight-btn');
            const allQuests = window.AppState.data.quests || [];

            if (currentView === 'all') {
                const topChild = [...familyMembers].sort((a, b) => (b.weeklyStreak || 0) - (a.weeklyStreak || 0))[0];
                if (topChild && (topChild.weeklyStreak || 0) > 0) {
                    insightTitle.innerText = `${topChild.name} đang dẫn đầu gia đình!`;
                    insightDesc.innerText = `Với chuỗi ${topChild.weeklyStreak} ngày rèn luyện liên tục, ${topChild.name} đang là tấm gương sáng nhất tuần này.`;
                    insightIcon.innerText = "workspace_premium";
                } else {
                    insightTitle.innerText = "Khởi động tuần mới đầy năng lượng!";
                    insightDesc.innerText = "Hãy giao thêm các nhiệm vụ nhẹ nhàng để tạo đà hưng phấn cho các con vào đầu tuần nhé.";
                    insightIcon.innerText = "rocket_launch";
                }
                insightBtn.innerText = "XEM CỬA HÀNG QUÀ";
                insightBtn.onclick = () => navigateWithTransition('../manage-shop/index.html');
            } else {
                const member = familyMembers.find(m => m.id === currentView);
                if (member) {
                    const pendingQuests = allQuests.filter(q => q.status === 'pending_approval' && q.completedBy && q.completedBy.includes(member.id)).length;

                    if (pendingQuests > 0) {
                        insightTitle.innerText = `${member.name} đang đợi ba mẹ duyệt!`;
                        insightDesc.innerText = `Con đã hoàn thành ${pendingQuests} nhiệm vụ mới. Hãy kiểm tra và khích lệ con ngay nhé!`;
                        insightIcon.innerText = "fact_check";
                        insightBtn.innerText = "DUYỆT NHIỆM VỤ NGAY";
                        insightBtn.onclick = () => navigateWithTransition('../approve-tasks/index.html');
                    } else if ((member.weeklyStreak || 0) >= 5) {
                        insightTitle.innerText = `Chuỗi phong độ của ${member.name} rất tốt!`;
                        insightDesc.innerText = `${member.weeklyStreak} ngày liên tiếp rèn luyện nếp sống tốt. Một phần quà nhỏ sẽ giúp con ghi nhớ thói quen này.`;
                        insightIcon.innerText = "local_fire_department";
                        insightBtn.innerText = "TẶNG QUÀ KHÍCH LỆ";
                        insightBtn.onclick = () => navigateWithTransition('../manage-shop/index.html');
                    } else if ((member.gold || 0) > 500) {
                        insightTitle.innerText = `${member.name} đã tích được khá nhiều vàng!`;
                        insightDesc.innerText = `Con đang có ${member.gold} vàng. Ba mẹ hãy nhắc con ghé thăm cửa hàng để đổi lấy những phần thưởng xứng đáng nhé.`;
                        insightIcon.innerText = "savings";
                        insightBtn.innerText = "MỞ CỬA HÀNG";
                        insightBtn.onclick = () => navigateWithTransition('../manage-shop/index.html');
                    } else {
                        insightTitle.innerText = `Hãy đồng hành cùng ${member.name}`;
                        insightDesc.innerText = `Một lời khen ngợi trực tiếp hôm nay về sự nỗ lực sẽ giá trị hơn mọi phần thưởng vật chất nào khác.`;
                        insightIcon.innerText = "volunteer_activism";
                        insightBtn.innerText = "GIAO THÊM NHIỆM VỤ";
                        insightBtn.onclick = () => navigateWithTransition('../manage-tasks/index.html');
                    }
                }
            }

            // 7. Update Charts and Legends
            document.getElementById('chart-title').innerText = displayData.chartTitle;

            const legendContainer = document.getElementById('chart-legend');
            let legendHtml = '';
            familyMembers.forEach((m, idx) => {
                const isActive = displayData.activeChildrenIds.includes(m.id);
                const colors = ['bg-primary', 'bg-blue-400', 'bg-emerald-400', 'bg-purple-400'];
                const color = colors[idx % colors.length];

                legendHtml += `
                    <div id="legend-${m.id}" class="flex items-center gap-2 cursor-pointer transition-opacity duration-300" style="opacity: ${isActive ? '1' : '0.3'}">
                        <span class="size-3 rounded-full ${color} ${isActive ? 'ring-4 ring-offset-2 ring-primary/10' : ''} transition-all"></span>
                        <span class="text-[10px] font-black text-slate-500 uppercase">${m.name}</span>
                    </div>
                `;
            });
            legendContainer.innerHTML = legendHtml;

            const lineBo = document.getElementById('line-bo');
            const lineNi = document.getElementById('line-ni');

            if (familyMembers.length > 0) {
                lineBo.style.opacity = displayData.activeChildrenIds.includes(familyMembers[0].id) ? "1" : "0.1";
            }
            if (familyMembers.length > 1) {
                lineNi.style.opacity = displayData.activeChildrenIds.includes(familyMembers[1].id) ? "1" : "0.1";
            } else if (lineNi) {
                lineNi.style.opacity = "0";
            }
        };

        const changeReport = (viewId) => {
            currentView = viewId;
            updateReportUI();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const waitForState = () => {
                if (window.AppState) {
                    window.AppState.subscribe(() => updateReportUI());
                    updateReportUI();
                } else {
                    setTimeout(waitForState, 100);
                }
            };
            waitForState();
        });
    </script>

</body>

</html>