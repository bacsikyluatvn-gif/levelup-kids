<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Bảng Điều Khiển Quản Trị - LevelUp Kids</title>
    <link rel="stylesheet" href="../shared/css/global.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="../shared/js/state.js"></script>
    <script src="../shared/js/components.js?v=2.0.9" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ee9d2b", "primary-dark": "#d48215", "text-main": "#181511", "text-muted": "#897961" }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e6e1db;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-[#1a140d] text-slate-800 dark:text-slate-200 min-h-screen custom-scrollbar">

    <div class="flex">
        <!-- Intelligent Sidebar Component -->
        <parent-sidebar active="dashboard"></parent-sidebar>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-10 h-screen custom-scrollbar">

            <!-- Header Section -->
            <header class="flex flex-col xl:flex-row xl:items-center justify-between mb-6 md:mb-10 gap-4 md:gap-6">
                <div>
                    <h2 class="text-2xl md:text-4xl font-black text-slate-800 dark:text-white tracking-tighter">Bảng
                        Điều Khiển</h2>
                    <p class="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-widest font-black">Tổng
                        quan hoạt động rèn luyện của gia đình</p>

                    <!-- View Switcher & Portal Link -->
                    <div class="flex flex-wrap items-center gap-4 mt-6">
                        <div id="child-switcher"
                            class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800/50 p-1.5 rounded-xl border border-slate-200 dark:border-slate-800 inline-flex">
                            <button id="btn-all" onclick="changeDashboardView('all')"
                                class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-700 rounded-lg shadow-sm text-sm font-bold text-slate-900 dark:text-white transition-all">
                                <span>Toàn gia đình</span>
                            </button>
                        </div>

                        <button onclick="navigateWithTransition('../portal/index.html')"
                            class="flex items-center gap-2 px-5 py-2.5 bg-slate-800 dark:bg-slate-700 text-white rounded-xl text-xs font-black shadow-lg hover:bg-slate-900 transition-all uppercase tracking-widest">
                            <span class="material-symbols-outlined text-lg text-primary">logout</span>
                            <span>Trở lại App Của Bé</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <notification-bell></notification-bell>
                    <div
                        class="flex items-center gap-4 bg-white dark:bg-slate-800 p-2 pr-6 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                        <div class="size-12 rounded-xl border-4 border-primary/20 p-0.5">
                            <img alt="Parent" class="w-full h-full rounded-lg object-cover"
                                src="https://ui-avatars.com/api/?name=Bố+M&background=ee9d2b&color=fff" />
                        </div>
                        <div class="hidden sm:block text-left">
                            <p class="text-sm font-black text-slate-800 dark:text-white leading-none">Minh Trần</p>
                            <p class="text-[10px] text-primary font-black uppercase tracking-widest mt-1">Admin Parent
                            </p>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 md:gap-8">
                <!-- Left Column (Main Stats) -->
                <div class="xl:col-span-2 space-y-8">

                    <!-- Stat Cards Grid -->
                    <section id="stat-cards-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stat cards injected here -->
                    </section>

                    <!-- Main Progress Chart -->
                    <section
                        class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 relative overflow-hidden">
                        <div
                            class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10 gap-4 relative z-10">
                            <div>
                                <h4 id="chart-title"
                                    class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-wider flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary">analytics</span>
                                    Tiến trình rèn luyện
                                </h4>
                                <p class="text-xs text-slate-500 font-medium mt-1">Nhiệm vụ hoàn thành trong 7 ngày qua
                                </p>
                            </div>
                            <div id="chart-legend"
                                class="flex flex-wrap gap-4 text-xs font-bold uppercase tracking-wider text-slate-400">
                                <!-- Legend here -->
                            </div>
                        </div>

                        <!-- Chart SVG (Simplified logic) -->
                        <div
                            class="relative h-64 w-full bg-slate-50/50 dark:bg-slate-800/30 rounded-3xl p-6 flex gap-4">
                            <div
                                class="flex flex-col justify-between text-[10px] font-black text-slate-400 uppercase h-full pb-6">
                                <span>20</span><span>15</span><span>10</span><span>5</span><span>0</span>
                            </div>
                            <div class="relative flex-1 h-full">
                                <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 400 150">
                                    <path id="path-all"
                                        d="M0,130 C50,110 100,20 150,50 C200,80 250,30 300,60 C350,90 400,20"
                                        fill="none" stroke="#ee9d2b" stroke-width="4" stroke-linecap="round"
                                        class="drop-shadow-lg opacity-80"></path>
                                </svg>
                                <div
                                    class="absolute bottom-0 left-0 right-0 flex justify-between px-2 translate-y-5 text-[9px] font-black text-slate-400 uppercase">
                                    <span>T2</span><span>T3</span><span>T4</span><span>T5</span><span>T6</span><span>T7</span><span>CN</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Children Cards Grid -->
                    <section>
                        <h4
                            class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-wider mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">diversity_1</span>
                            Thành tích các con
                        </h4>
                        <div id="children-stats-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Injected -->
                        </div>
                    </section>

                    <!-- Pending Tasks -->
                    <section class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h4
                                class="text-xl font-black text-slate-800 dark:text-white uppercase tracking-wider flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">fact_check</span>
                                Nhiệm vụ chờ duyệt
                            </h4>
                            <span id="pending-count-tag"
                                class="text-[10px] font-black text-primary bg-primary/10 px-4 py-1.5 rounded-full uppercase tracking-wider">0
                                nhiệm vụ</span>
                        </div>
                        <div class="bg-white dark:bg-slate-900 rounded-[2rem] border border-slate-100 dark:border-slate-800 overflow-hidden shadow-sm"
                            id="pending-tasks-container">
                            <!-- Injected -->
                        </div>
                        <button onclick="navigateWithTransition('../approve-tasks/index.html')"
                            class="w-full py-4 text-xs font-black text-slate-400 hover:text-primary transition-all uppercase tracking-widest bg-white dark:bg-slate-800/50 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-800">
                            Quản lý tất cả yêu cầu duyệt
                        </button>
                    </section>
                </div>

                <!-- Right Column (Analysis & Feed) -->
                <div class="xl:col-span-1 space-y-8">

                    <!-- Insight Card -->
                    <div id="insight-card"
                        class="bg-primary text-white p-8 rounded-[2.5rem] shadow-xl shadow-primary/20 relative overflow-hidden group">
                        <span id="insight-icon"
                            class="material-symbols-outlined text-[120px] absolute -right-4 -bottom-4 opacity-20 group-hover:scale-110 transition-transform duration-700">rocket_launch</span>
                        <div class="relative z-10">
                            <h5 class="text-[10px] font-black uppercase tracking-widest opacity-80 mb-2">Gợi ý từ hệ
                                thống</h5>
                            <h4 id="insight-title" class="text-2xl font-black leading-tight mb-4">Mọi thứ vẫn ổn!</h4>
                            <p id="insight-desc" class="text-sm font-medium opacity-90 leading-relaxed mb-6">Con đang
                                rèn luyện rất tích cực. Hãy tiếp tục khích lệ con nhé!</p>
                            <button id="insight-btn" onclick="navigateWithTransition('../manage-tasks/index.html')"
                                class="bg-white text-primary font-black px-6 py-3 rounded-xl text-[10px] hover:scale-105 transition-all shadow-lg">
                                THÊM NHIỆM VỤ MỚI
                            </button>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div
                        class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800">
                        <h4
                            class="text-lg font-black text-slate-800 dark:text-white mb-8 uppercase tracking-wider flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">vitals</span>
                            Hiệu suất hạng mục
                        </h4>
                        <div id="category-stats-container" class="space-y-6">
                            <!-- Bars -->
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div
                        class="bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-slate-800 h-fit">
                        <div class="flex items-center justify-between mb-8">
                            <h4 class="text-lg font-black text-slate-800 dark:text-white uppercase tracking-wider">Hoạt
                                động mới</h4>
                            <span
                                class="text-[10px] font-bold text-primary cursor-pointer hover:underline uppercase tracking-widest">Tất
                                cả</span>
                        </div>
                        <div id="activity-list" class="space-y-6">
                            <!-- Activity list -->
                        </div>
                    </div>
                </div>
            </div>

            <footer
                class="mt-20 py-8 border-t border-slate-200 dark:border-slate-800 text-center text-slate-400 text-[10px] font-bold uppercase tracking-widest">
                © 2024 LevelUp Kids • Nâng tầm rèn luyện gia đình
            </footer>
        </main>
    </div>

    <script>
        let currentView = 'all';

        const updateUI = () => {
            if (!window.AppState) return;
            const data = window.AppState.data;
            const members = data.leaderboard.filter(u => u.role === 'child');
            const requests = data.requests || [];
            const quests = data.quests || [];

            // 1. Switcher
            const switcher = document.getElementById('child-switcher');
            let switcherHtml = `
                <button onclick="changeDashboardView('all')" id="btn-all"
                    class="flex items-center gap-2 px-4 py-2 ${currentView === 'all' ? 'bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white font-bold' : 'text-slate-500 hover:text-slate-900 font-medium'} rounded-lg transition-all text-sm">
                    <span>Toàn gia đình</span>
                </button>
            `;
            members.forEach(m => {
                switcherHtml += `
                    <button onclick="changeDashboardView('${m.id}')" id="btn-${m.id}"
                        class="flex items-center gap-2 px-4 py-2 ${currentView === m.id ? 'bg-white dark:bg-slate-700 shadow-sm text-slate-900 dark:text-white font-bold' : 'text-slate-500 hover:text-slate-900 font-medium'} rounded-lg transition-all text-sm">
                        <span>${m.name}</span>
                    </button>
                `;
            });
            switcher.innerHTML = switcherHtml;

            // 2. Stat Cards
            let completedCount = 0;
            let totalGold = 0;
            let avgStreak = 0;

            if (currentView === 'all') {
                completedCount = requests.filter(r => r.status === 'delivered').length;
                totalGold = members.reduce((sum, m) => sum + (m.gold || 0), 0);
                avgStreak = (members.reduce((sum, m) => sum + (m.weeklyStreak || 0), 0) / (members.length || 1)).toFixed(1);
            } else {
                const m = members.find(u => u.id === currentView);
                completedCount = requests.filter(r => r.profileId === currentView && r.status === 'delivered').length;
                totalGold = m ? m.gold : 0;
                avgStreak = m ? m.weeklyStreak : 0;
            }

            document.getElementById('stat-cards-container').innerHTML = `
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div class="size-12 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-xl flex items-center justify-center mb-4"><span class="material-symbols-outlined">task_alt</span></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Nhiệm vụ xong</p>
                    <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-black text-slate-800 dark:text-white">${completedCount}</h3><span class="text-xs text-emerald-500 font-bold">+12%</span></div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div class="size-12 bg-amber-100 dark:bg-amber-900/30 text-amber-600 rounded-xl flex items-center justify-center mb-4"><span class="material-symbols-outlined">payments</span></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Vàng đang có</p>
                    <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-black text-slate-800 dark:text-white">${totalGold.toLocaleString()}</h3><span class="text-xs text-amber-500 font-bold">Gold</span></div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div class="size-12 bg-rose-100 dark:bg-rose-900/30 text-rose-600 rounded-xl flex items-center justify-center mb-4"><span class="material-symbols-outlined">local_fire_department</span></div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Chuỗi rèn luyện</p>
                    <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-black text-slate-800 dark:text-white">${avgStreak}</h3><span class="text-xs text-rose-500 font-bold">Ngày</span></div>
                </div>
            `;

            // 3. Children Progression
            let gridHtml = '';
            members.forEach(m => {
                if (currentView !== 'all' && m.id !== currentView) return;
                const total = data.quests.length || 1;
                const done = data.quests.filter(q => q.completedBy && q.completedBy.includes(m.id)).length;
                const percent = Math.min(100, Math.floor((done / total) * 100));

                gridHtml += `
                    <div class="group bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 hover:border-primary/50 transition-all duration-300">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="size-16 relative">
                                <img src="${m.avatar}" class="size-full rounded-2xl object-cover ring-4 ring-slate-50 dark:ring-slate-800 group-hover:ring-primary/20 transition-all" />
                                <div class="absolute -bottom-2 -right-2 size-7 bg-primary text-white text-[10px] font-black rounded-lg flex items-center justify-center shadow-lg">LV${m.level}</div>
                            </div>
                            <div>
                                <h5 class="font-black text-slate-800 dark:text-white uppercase tracking-tight">${m.name}</h5>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">${done} nhiệm vụ đã xong</p>
                            </div>
                            <div class="ml-auto text-right">
                                <span class="text-2xl font-black text-primary">${percent}%</span>
                            </div>
                        </div>
                        <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bg-primary rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('children-stats-grid').innerHTML = gridHtml;

            // 4. Pending Tasks
            const pending = requests.filter(r => r.status === 'pending' && r.type === 'task');
            document.getElementById('pending-count-tag').innerText = `${pending.length} nhiệm vụ`;

            const container = document.getElementById('pending-tasks-container');
            if (pending.length === 0) {
                container.innerHTML = '<div class="p-12 text-center text-slate-400 font-bold">Không có yêu cầu nào đang chờ.</div>';
            } else {
                let html = '<div class="divide-y divide-slate-50 dark:divide-slate-800">';
                pending.slice(0, 3).forEach(r => {
                    html += `
                        <div class="p-6 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="size-12 bg-primary/10 text-primary rounded-xl flex items-center justify-center"><span class="material-symbols-outlined">auto_awesome</span></div>
                                <div>
                                    <h6 class="font-bold text-slate-800 dark:text-white leading-tight">${r.itemTitle}</h6>
                                    <p class="text-xs text-slate-500 mt-0.5"><span class="font-bold text-primary">${r.user}</span> • ${r.time}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.AppState.rejectRequest('${r.id}')" class="px-4 py-2 text-[10px] font-black border border-slate-200 dark:border-slate-700 rounded-lg uppercase tracking-wider hover:bg-slate-50">Hủy</button>
                                <button onclick="window.AppState.markRequestDelivered('${r.id}')" class="px-4 py-2 text-[10px] font-black bg-primary text-white rounded-lg uppercase tracking-wider shadow-sm hover:scale-105 transition-all">Duyệt</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }

            // 5. Category Efficiency (Mocked logic from Reports)
            const categories = ['Học tập', 'Việc nhà', 'Kỹ năng', 'Sức khỏe'];
            const catContainer = document.getElementById('category-stats-container');
            catContainer.innerHTML = categories.map((cat, i) => {
                const val = 60 + (i * 10);
                const color = i % 2 === 0 ? 'bg-primary' : 'bg-blue-400';
                return `
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">${cat}</span>
                            <span class="text-xs font-black text-slate-800 dark:text-white">${val}%</span>
                        </div>
                        <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full ${color} rounded-full transition-all duration-1000" style="width: ${val}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // 6. Recent Activity
            const activityList = document.getElementById('activity-list');
            activityList.innerHTML = requests.slice(0, 5).map(r => {
                const icon = r.type === 'task' ? 'task_alt' : 'redeem';
                const avatar = members.find(m => m.id === r.profileId)?.avatar || `https://ui-avatars.com/api/?name=${r.user}`;
                return `
                    <div class="flex gap-4">
                        <img src="${avatar}" class="size-10 rounded-full border-2 border-white dark:border-slate-800 shadow-sm shrink-0" />
                        <div>
                            <p class="text-sm font-medium text-slate-700 dark:text-slate-300 leading-tight">
                                <span class="font-black text-slate-900 dark:text-white">${r.user}</span> ${r.type === 'task' ? 'đã xong' : 'đã đổi'} "${r.itemTitle}"
                            </p>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">${r.time}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // 7. Dynamic Insights
            const insightTitle = document.getElementById('insight-title');
            const insightDesc = document.getElementById('insight-desc');
            if (pending.length > 0) {
                insightTitle.innerText = "Có yêu cầu chờ duyệt!";
                insightDesc.innerText = `Các con đã hoàn thành ${pending.length} nhiệm vụ mới. Hãy xem qua và khích lệ con ngay nhé.`;
            } else if (members.some(m => m.gold > 500)) {
                insightTitle.innerText = "Con có nhiều vàng rồi!";
                insightDesc.innerText = "Ba mẹ hãy nhắc con vào cửa hàng để đổi những phần quà yêu thích nhé.";
            } else {
                insightTitle.innerText = "Khởi đầu rèn luyện tốt!";
                insightDesc.innerText = "Xây dựng thói quen nhỏ mỗi ngày sẽ tạo nên sự thay đổi lớn trong tương lai.";
            }
        };

        window.changeDashboardView = (id) => {
            currentView = id;
            updateUI();
        };

        document.addEventListener('DOMContentLoaded', () => {
            const wait = () => {
                if (window.AppState) {
                    window.AppState.subscribe(() => updateUI());
                    updateUI();
                } else { setTimeout(wait, 100); }
            };
            wait();
        });
    </script>
</body>

</html>