<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport" />
    <title>LevelUp Kids - ƒê·∫•u Tr∆∞·ªùng Anh H√πng</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../shared/css/global.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../shared/js/state.js"></script>
    <script src="../shared/js/components.js?v=1.0.8" defer></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee9d2b",
                        "primary-dark": "#d48215",
                        "arena-blue": "#3b82f6",
                        "arena-orange": "#f97316"
                    }
                }
            }
        }
    </script>
    <style>
        .gladiator-card {
            background: #ffffff;
            /* backdrop-filter: blur(10px); -> Removed for performance */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
            will-change: transform;
        }

        .dark .gladiator-card {
            background: #1a140c;
        }

        .gladiator-card:hover {
            transform: translateY(-4px) translateZ(0);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }

        .vs-badge {
            background: linear-gradient(135deg, #f97316 0%, #ee9d2b 100%);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.4);
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4);
            }

            70% {
                box-shadow: 0 0 0 12px rgba(249, 115, 22, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
            }
        }

        .btn-done-pulse {
            animation: pulse-ring 1.5s ease-out infinite;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-enter {
            animation: slideInUp 0.4s ease-out forwards;
        }

        /* Drama Reveal Styles */
        .reveal-overlay-active {
            background: radial-gradient(circle, #2a2a2a 0%, #000 100%);
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes shake-intense {

            0%,
            100% {
                transform: rotate(0deg) scale(1);
            }

            10% {
                transform: rotate(-8deg) scale(1.1);
            }

            20% {
                transform: rotate(8deg) scale(1.2);
            }

            30% {
                transform: rotate(-12deg) scale(1.3);
            }

            40% {
                transform: rotate(12deg) scale(1.4);
            }

            50% {
                transform: rotate(0deg) scale(1.5);
            }
        }

        .chest-drama {
            animation: shake-intense 0.5s infinite;
            filter: drop-shadow(0 0 30px rgba(234, 179, 8, 0.6));
        }

        /* Result pop */
        .result-pop {
            animation: resultPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes resultPop {
            0% {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
            }

            70% {
                transform: scale(1.1) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        /* Infinite Progress Bar */
        @keyframes progress-infinite {
            0% {
                left: -40%;
                width: 40%;
            }

            50% {
                left: 40%;
                width: 60%;
            }

            100% {
                left: 100%;
                width: 40%;
            }
        }

        .progress-line {
            position: relative;
            height: 6px;
            width: 100%;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-line:after {
            content: '';
            position: absolute;
            height: 100%;
            background: #ee9d2b;
            animation: progress-infinite 2s infinite linear;
        }

        .opponent-list-scroll {
            scrollbar-width: thin;
            scrollbar-color: #ee9d2b transparent;
        }

        .opponent-list-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .opponent-list-scroll::-webkit-scrollbar-thumb {
            background-color: #ee9d2b;
            border-radius: 10px;
        }

        /* Power Flow Animation */
        @keyframes power-flow {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .power-bar-fill {
            background-size: 200% 100% !important;
            animation: power-flow 3s linear infinite;
        }

        /* Dominant Aura Effects */
        .dominant-blue {
            filter: drop-shadow(0 0 25px rgba(59, 130, 246, 0.8)) !important;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6) !important;
            animation: dominant-pulse-blue 1.5s infinite alternate !important;
        }

        .dominant-red {
            filter: drop-shadow(0 0 25px rgba(244, 63, 94, 0.8)) !important;
            box-shadow: 0 0 30px rgba(244, 63, 94, 0.6) !important;
            animation: dominant-pulse-red 1.5s infinite alternate !important;
        }

        @keyframes dominant-pulse-blue {
            from {
                transform: scale(1);
                filter: brightness(1);
            }

            to {
                transform: scale(1.05);
                filter: brightness(1.3);
            }
        }

        @keyframes dominant-pulse-red {
            from {
                transform: scale(1);
                filter: brightness(1);
            }

            to {
                transform: scale(1.05);
                filter: brightness(1.3);
            }
        }

        /* Dominant Bar Section */
        .bar-dominant {
            height: 150% !important;
            top: -25% !important;
            z-index: 10;
            filter: brightness(1.2) drop-shadow(0 0 15px currentColor);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4) inset;
        }

        /* Enhanced Commentary Slide for Grade 1 */
        .commentary-slide {
            animation: commentary-slide 40s linear infinite;
            /* Slower for kids */
            text-shadow: none !important;
            /* Remove blurry shadow */
            color: #475569;
            /* Clear slate color */
        }

        .dark .commentary-slide {
            color: #cbd5e1;
        }

        @keyframes commentary-slide {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(-100%);
            }
        }

        /* Lightning Bolt Float */
        @keyframes lightning-float {

            0%,
            100% {
                transform: translate(-50%, -50%) translateY(0) scale(1.1);
            }

            50% {
                transform: translate(-50%, -50%) translateY(-3px) scale(1.3);
            }
        }

        .lightning-bolt-vfx {
            will-change: transform;
            animation: lightning-float 1.5s ease-in-out infinite;
        }

        /* Hardware Acceleration for bars */
        .power-bar-fill {
            will-change: width, background-position;
            transform: translateZ(0);
        }

        /* Optimize expensive shadows */
        .dominant-blue,
        .dominant-red {
            will-change: transform;
            transform: translateZ(0);
        }

        .aura-active-blue,
        .aura-active-red {
            will-change: transform;
            transform: translateZ(0);
        }

        .lightning-bolt-vfx {
            will-change: transform;
            animation: lightning-float 1.5s ease-in-out infinite;
        }

        .struggle-container {
            position: relative;
        }

        /* Dominant Energy Surge */
        .bar-dominant {
            height: 180% !important;
            top: -40% !important;
            z-index: 20;
            filter: brightness(1.3) drop-shadow(0 0 20px currentColor);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.6) inset;
            border-radius: 999px;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Static & Moving Bolt */
        /* Central Bolt Struggle (Internal Movement Only) */
        @keyframes bolt-struggle {
            0% {
                transform: translate(-50%, -50%) translateX(-15px) scale(1.2);
            }

            50% {
                transform: translate(-50%, -50%) translateX(15px) scale(1.4);
            }

            100% {
                transform: translate(-50%, -50%) translateX(-15px) scale(1.2);
            }
        }

        .bolt-moving {
            animation: bolt-struggle 3s ease-in-out infinite, lightning-float 0.3s infinite;
        }

        /* Grade 1 Friendly Ticker */
        .commentary-slide {
            animation: commentary-slide 45s linear infinite;
            text-shadow: none !important;
            font-weight: 900 !important;
            letter-spacing: 0.05em;
            color: #1e293b;
        }

        .dark .commentary-slide {
            color: #f1f5f9;
        }

        /* Screen Shake for Intensity */
        @keyframes battlefield-shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(1px, 1px);
            }

            50% {
                transform: translate(-1px, 1px);
            }

            75% {
                transform: translate(1px, -1px);
            }
        }

        /* Consolidated Aura Effects */
        .aura-active-blue {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            will-change: transform, box-shadow;
            transform: translateZ(0);
        }

        .aura-active-red {
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.4);
            will-change: transform, box-shadow;
            transform: translateZ(0);
        }

        .intense-battle {
            animation: battlefield-shake 1s infinite;
        }

        .vs-text-styled {
            font-weight: 900;
            font-style: italic;
            background: linear-gradient(to bottom, #fff 30%, #ffd700 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: vs-bounce 2s infinite ease-in-out;
        }

        .invitation-glass-card {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        @keyframes scanning {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .scanner-effect::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 20%;
            background: linear-gradient(to bottom, transparent, rgba(234, 179, 8, 0.2), transparent);
            animation: scanning 2s linear infinite;
        }

        .shimmer-btn {
            position: relative;
            overflow: hidden;
        }

        .shimmer-btn::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) rotate(45deg);
            }
        }

        .lightning-split {
            clip-path: polygon(0 0, 60% 0, 40% 100%, 0 100%);
        }

        .lightning-split-right {
            clip-path: polygon(60% 0, 100% 0, 100% 100%, 40% 100%);
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-black font-['Montserrat'] min-h-screen pb-32">
    <!-- Sound Effects -->
    <audio id="snd-chest" src="../shared/assets/mo hop qua.mp3" preload="auto"></audio>
    <audio id="snd-challenge" src="../shared/assets/khieu chien.mp3" preload="auto"></audio>
    <audio id="snd-win" src="../shared/assets/thang.mp3" preload="auto"></audio>
    <audio id="snd-lose" src="../shared/assets/thua.mp3" preload="auto"></audio>
    <audio id="snd-lose2" src="../shared/assets/thua2.mp3" preload="auto"></audio>
    <audio id="snd-draw" src="../shared/assets/hoa.mp3" preload="auto"></audio>

    <app-header title="ƒê·∫•u Tr∆∞·ªùng" type="child"></app-header>

    <main class="flex-grow w-full max-w-[1200px] mx-auto p-4 md:p-8 transition-all duration-500">

        <!-- Title Row (Scientifically Balanced) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center mb-12">
            <!-- Left: Title & Persona -->
            <div class="lg:col-span-8">
                <div class="flex items-center gap-4 mb-2">
                    <div
                        class="w-12 h-12 bg-arena-orange/20 rounded-2xl flex items-center justify-center text-arena-orange">
                        <span class="material-symbols-outlined text-3xl"
                            style="font-variation-settings:'FILL' 1">swords</span>
                    </div>
                    <h2
                        class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-black text-slate-800 dark:text-white uppercase italic tracking-tighter whitespace-nowrap">
                        ƒê·∫§U TR∆Ø·ªúNG <span class="text-arena-orange">ANH H√ôNG</span>
                    </h2>
                </div>
                <p id="welcome-text" class="text-slate-500 font-bold ml-16 text-sm md:text-base">ƒêang t·∫£i th√¥ng tin
                    chi·∫øn th·∫ßn...</p>
            </div>

            <!-- Right: Warrior Dashboard -->
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div
                    class="bg-white dark:bg-[#2c2215] rounded-[2.5rem] border-2 border-slate-100 dark:border-slate-800 p-2 shadow-sm">
                    <div class="grid grid-cols-2 divide-x divide-slate-100 dark:divide-slate-800">
                        <!-- Attack (Active) -->
                        <div class="px-4 py-3 flex flex-col items-center justify-center">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="material-symbols-outlined text-sm text-arena-orange">sword_rose</span>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">T·∫•n
                                    c√¥ng</span>
                            </div>
                            <span id="active-counter"
                                class="text-2xl font-black text-arena-orange leading-none">3/3</span>
                            <p class="text-[8px] font-bold text-slate-300 mt-1 uppercase">L∆∞·ª£t b√© ƒëi th√°ch</p>
                        </div>
                        <!-- Defense (Passive) -->
                        <div class="px-4 py-3 flex flex-col items-center justify-center">
                            <div class="flex items-center gap-1.5 mb-1">
                                <span class="material-symbols-outlined text-sm text-blue-500">shield</span>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Ph√≤ng
                                    th·ªß</span>
                            </div>
                            <span id="passive-counter" class="text-2xl font-black text-blue-500 leading-none">3/3</span>
                            <p class="text-[8px] font-bold text-slate-300 mt-1 uppercase">L∆∞·ª£t ƒë∆∞·ª£c th√°ch</p>
                        </div>
                    </div>

                    <!-- Battle Result Stats -->
                    <div
                        class="bg-white dark:bg-[#1a140c]/40 rounded-[2rem] p-4 border-2 border-slate-100 dark:border-slate-800 flex justify-between items-center shadow-sm">
                        <div class="text-center flex-1">
                            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Th·∫Øng</p>
                            <span id="user-wins" class="text-xl font-black text-emerald-500 leading-none">0</span>
                        </div>
                        <div class="text-center flex-1 border-x border-slate-100 dark:border-slate-800 px-2">
                            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">H√≤a</p>
                            <span id="user-draws" class="text-xl font-black text-blue-400 leading-none">0</span>
                        </div>
                        <div class="text-center flex-1">
                            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">B·∫°i</p>
                            <span id="user-losses" class="text-xl font-black text-rose-400 leading-none">0</span>
                        </div>
                    </div>


                    <button id="btn-open-modal" onclick="openChallengeModal()"
                        class="group w-full bg-gradient-to-r from-arena-orange to-primary text-white px-8 py-5 rounded-[2rem] font-black shadow-lg hover:shadow-arena-orange/30 transition-all flex items-center justify-center gap-3 active:scale-95 text-lg">
                        <span
                            class="material-symbols-outlined text-2xl group-hover:rotate-90 transition-transform">swords</span>
                        T·∫†O K√àO M·ªöI
                    </button>
                </div>
            </div>
        </div> <!-- K·∫æT TH√öC GRID TITLE ROW (D√≤ng 552) -->

        <!-- ======= YOUR ACTIVE CHALLENGES ======= -->
        <section class="mb-14 col-span-full">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-arena-blue/10 dark:bg-arena-blue/20 p-2 rounded-xl text-arena-blue">
                    <span class="material-symbols-outlined text-xl"
                        style="font-variation-settings:'FILL' 1">swords</span>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wider text-slate-700 dark:text-white">K√®o ƒêang ƒê·∫•u
                </h3>
                <span id="active-count"
                    class="bg-arena-orange text-white text-xs font-black px-2.5 py-1 rounded-full hidden">0</span>
            </div>
            <div id="active-challenges-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">
                <!-- Skeleton Loader -->
                <div class="skeleton-card rounded-[3.5rem] bg-slate-100 dark:bg-white/5 h-[400px] animate-pulse">
                </div>
                <div
                    class="skeleton-card rounded-[3.5rem] bg-slate-100 dark:bg-white/5 h-[400px] animate-pulse hidden md:block">
                </div>
            </div>
        </section>

        <!-- ======= YOUR HISTORY ======= -->
        <section id="completed-section" class="hidden mb-14">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-green-500/10 dark:bg-green-500/20 p-2 rounded-xl text-green-500">
                    <span class="material-symbols-outlined text-xl"
                        style="font-variation-settings:'FILL' 1">history</span>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wider text-slate-700 dark:text-white">Chi·∫øn T√≠ch
                    C·ªßa
                    B·∫°n</h3>
            </div>
            <div id="completed-challenges-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="h-32 bg-slate-100 dark:bg-white/5 rounded-3xl animate-pulse"></div>
                <div class="h-32 bg-slate-100 dark:bg-white/5 rounded-3xl animate-pulse"></div>
                <div class="h-32 bg-slate-100 dark:bg-white/5 rounded-3xl animate-pulse"></div>
            </div>
        </section>

        <!-- ======= ARENA WORLD NEWS ======= -->
        <section class="border-t border-slate-200 dark:border-slate-800 pt-10">
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-purple-500/10 dark:bg-purple-500/20 p-2 rounded-xl text-purple-500">
                    <span class="material-symbols-outlined text-xl">language</span>
                </div>
                <h3 class="text-xl font-black uppercase tracking-wider text-slate-500 dark:text-slate-400">Tin T·ª©c
                    ƒê·∫•u
                    Tr∆∞·ªùng</h3>
            </div>
            <div id="arena-news-list" class="space-y-3">
                <div class="h-20 bg-slate-100 dark:bg-white/5 rounded-2xl animate-pulse"></div>
                <div class="h-20 bg-slate-100 dark:bg-white/5 rounded-2xl animate-pulse"></div>
            </div>
        </section>
    </main>

    <!-- ================ REPORT MODAL (NEW) ================ -->
    <div id="report-modal"
        class="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="report-modal-content"
            class="bg-white dark:bg-[#2c2215] w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl transform scale-90 transition-all duration-300 text-center">

            <div id="report-task-emoji" class="text-6xl mb-4">üåÖ</div>
            <h3 class="text-2xl font-black mb-1 text-slate-800 dark:text-white">K·∫æT QU·∫¢ TH·∫æ N√ÄO?</h3>
            <p class="text-slate-500 mb-8 font-medium">B√© h√£y trung th·ª±c ch·ªçn k·∫øt qu·∫£ th·ª±c t·∫ø c·ªßa m√¨nh nh√©!</p>

            <div class="space-y-3">
                <button onclick="confirmReport(true)"
                    class="w-full py-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-black rounded-3xl shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-3">
                    <span class="material-symbols-outlined">check_circle</span>
                    M√åNH ƒê√É HO√ÄN TH√ÄNH!
                </button>
                <button onclick="confirmReport(false)"
                    class="w-full py-4 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 font-bold rounded-3xl hover:bg-rose-50 hover:text-rose-500 active:scale-95 transition-all flex items-center justify-center gap-3">
                    <span class="material-symbols-outlined">cancel</span>
                    M√åNH CH∆ØA XONG...
                </button>
            </div>

            <button onclick="closeReportModal()"
                class="mt-6 text-xs font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600">ƒê·ªÉ
                sau</button>
        </div>
    </div>

    <!-- ================ JOURNEY UPDATE MODAL (NEW) ================ -->
    <div id="journey-log-modal"
        class="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="journey-log-modal-content"
            class="bg-white dark:bg-[#1a1611] w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl transform scale-90 transition-all duration-300 border border-white/20">

            <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center text-primary mx-auto mb-6">
                <span class="material-symbols-outlined text-4xl">history_edu</span>
            </div>

            <h3 class="text-2xl font-black mb-2 text-center text-slate-800 dark:text-white uppercase italic">C·∫¨P NH·∫¨T
                H√ÄNH TR√åNH</h3>
            <p class="text-slate-400 text-[11px] font-bold text-center uppercase tracking-widest mb-6">Con ƒë√£ l√†m ƒë∆∞·ª£c
                g√¨ r·ªìi? Chia s·∫ª ngay n√†o!</p>

            <textarea id="journey-log-input"
                class="w-full h-32 p-4 bg-slate-50 dark:bg-black/40 border-2 border-slate-100 dark:border-white/5 rounded-2xl text-slate-700 dark:text-white font-bold text-sm focus:border-primary focus:outline-none transition-all placeholder:text-slate-300"
                placeholder="V√≠ d·ª•: Con ƒë√£ gi√∫p m·∫π qu√©t nh√† v√† t∆∞·ªõi c√¢y..."></textarea>

            <div class="grid grid-cols-2 gap-3 mt-6">
                <button onclick="closeJourneyLogModal()"
                    class="py-4 bg-slate-100 dark:bg-white/5 text-slate-400 font-black rounded-2xl hover:bg-slate-200 transition-all">
                    H·ª¶Y
                </button>
                <button id="btn-submit-journey" onclick="submitJourneyLog()"
                    class="py-4 bg-primary text-white font-black rounded-2xl shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-95 transition-all">
                    L∆ØU L·∫†I
                </button>
            </div>
        </div>
    </div>

    <!-- ================ CREATE CHALLENGE MODAL (REDESIGNED) ================ -->
    <div id="challenge-modal"
        class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-xl opacity-0 pointer-events-none transition-all duration-300">
        <div id="challenge-modal-content"
            class="bg-white dark:bg-[#1a1611] w-full max-w-4xl rounded-[3rem] shadow-2xl transform scale-95 transition-all duration-300 max-h-[90vh] flex flex-col overflow-hidden border border-white/20 dark:border-white/5">

            <!-- Header -->
            <div
                class="px-8 py-6 flex items-center justify-between border-b border-slate-100 dark:border-white/5 flex-shrink-0 bg-white/50 dark:bg-black/20 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-arena-orange rounded-xl flex items-center justify-center text-white shadow-lg shadow-arena-orange/20">
                        <span class="material-symbols-outlined font-black">swords</span>
                    </div>
                    <div>
                        <h3
                            class="text-2xl font-black text-slate-800 dark:text-white uppercase italic tracking-tighter">
                            THI·∫æT L·∫¨P K√àO ƒê·∫§U</h3>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Ch·ªçn ƒë·ªëi th·ªß v√† nhi·ªám
                            v·ª• c·ªßa b√©</p>
                    </div>
                </div>
                <button onclick="closeChallengeModal()"
                    class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-slate-100 dark:hover:bg-white/10 transition-colors">
                    <span class="material-symbols-outlined text-slate-400">close</span>
                </button>
            </div>

            <div class="flex-grow overflow-y-auto p-8">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

                    <!-- LEFT COLUMN: SELECTION -->
                    <div class="lg:col-span-7 space-y-10">
                        <!-- 1. Opponent Selection -->
                        <div>
                            <div class="flex items-center justify-between mb-4 px-2">
                                <label
                                    class="text-[11px] font-black text-primary uppercase tracking-[0.2em] flex items-center gap-2">
                                    <span
                                        class="w-5 h-5 bg-primary/10 rounded-md flex items-center justify-center text-[10px]">1</span>
                                    CH·ªåN ƒê·ªêI TH·ª¶ X·ª®NG T·∫¶M
                                </label>
                                <span class="text-[9px] font-bold text-slate-400 italic">Vu·ªët ƒë·ªÉ t√¨m ƒë·ªëi th·ªß</span>
                            </div>
                            <div id="opponent-list"
                                class="flex gap-4 overflow-x-auto pb-4 pt-1 px-1 opponent-list-scroll snap-x">
                                <!-- Opponents will be rendered here -->
                            </div>
                        </div>

                        <!-- 2. Task Selection -->
                        <div>
                            <label
                                class="text-[11px] font-black text-primary uppercase tracking-[0.2em] mb-4 px-2 flex items-center gap-2">
                                <span
                                    class="w-5 h-5 bg-primary/10 rounded-md flex items-center justify-center text-[10px]">2</span>
                                CH·ªåN TH·ª¨ TH√ÅCH ANH H√ôNG
                            </label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="selectTask(this, 'Vi·∫øt th∆∞ y√™u th∆∞∆°ng')"
                                    class="task-btn p-4 rounded-2xl border-2 border-slate-100 dark:border-white/5 hover:border-primary transition-all flex items-center gap-4 text-left group">
                                    <span class="text-3xl group-hover:scale-110 transition-transform">‚úâÔ∏è</span>
                                    <div class="min-w-0">
                                        <span class="font-black text-xs block text-slate-700 dark:text-white">Th∆∞ y√™u
                                            th∆∞∆°ng</span>
                                        <span class="text-[9px] text-slate-400 leading-tight">G·ª≠i clip c·∫£m ∆°n</span>
                                    </div>
                                </button>
                                <button onclick="selectTask(this, 'Ba vi·ªác t·ªët')"
                                    class="task-btn p-4 rounded-2xl border-2 border-slate-100 dark:border-white/5 hover:border-primary transition-all flex items-center gap-4 text-left group">
                                    <span class="text-3xl group-hover:scale-110 transition-transform">ü§ù</span>
                                    <div class="min-w-0">
                                        <span class="font-black text-xs block text-slate-700 dark:text-white">Ba vi·ªác
                                            t·ªët</span>
                                        <span class="text-[9px] text-slate-400 leading-tight">Gi√∫p ƒë·ª° m·ªçi ng∆∞·ªùi</span>
                                    </div>
                                </button>
                                <button onclick="selectTask(this, 'S·ª© gi·∫£ m√¥i tr∆∞·ªùng')"
                                    class="task-btn p-4 rounded-2xl border-2 border-slate-100 dark:border-white/5 hover:border-primary transition-all flex items-center gap-4 text-left group">
                                    <span class="text-3xl group-hover:scale-110 transition-transform">üå±</span>
                                    <div class="min-w-0">
                                        <span class="font-black text-xs block text-slate-700 dark:text-white">M√¥i
                                            tr∆∞·ªùng</span>
                                        <span class="text-[9px] text-slate-400 leading-tight">B·∫£o v·ªá tr√°i ƒë·∫•t</span>
                                    </div>
                                </button>
                                <button onclick="selectTask(this, 'Reviewer t√†i nƒÉng')"
                                    class="task-btn p-4 rounded-2xl border-2 border-slate-100 dark:border-white/5 hover:border-primary transition-all flex items-center gap-4 text-left group">
                                    <span class="text-3xl group-hover:scale-110 transition-transform">üé¨</span>
                                    <div class="min-w-0">
                                        <span class="font-black text-xs block text-slate-700 dark:text-white">Reviewer
                                            nh√≠</span>
                                        <span class="text-[9px] text-slate-400 leading-tight">K·ªÉ v·ªÅ ƒë·ªì y√™u th√≠ch</span>
                                    </div>
                                </button>
                                <button onclick="selectTask(this, 'H·ªça sƒ© t·∫∑ng qu√†')"
                                    class="task-btn p-4 rounded-2xl border-2 border-slate-100 dark:border-white/5 hover:border-primary transition-all flex items-center gap-4 text-left group">
                                    <span class="text-3xl group-hover:scale-110 transition-transform">üé®</span>
                                    <div class="min-w-0">
                                        <span class="font-black text-xs block text-slate-700 dark:text-white">H·ªça sƒ©
                                            nh√≠</span>
                                        <span class="text-[9px] text-slate-400 leading-tight">V·∫Ω tranh t·∫∑ng qu√†</span>
                                    </div>
                                </button>
                                <button onclick="showCustomTaskInput(this)"
                                    class="task-btn p-4 rounded-2xl border-2 border-dashed border-primary/40 bg-primary/5 hover:bg-primary/10 transition-all flex items-center gap-4 text-left group">
                                    <span class="text-3xl group-hover:rotate-12 transition-transform">‚ú®</span>
                                    <div class="min-w-0">
                                        <span class="font-black text-xs block text-primary">T·ª± t·∫°o k√®o</span>
                                        <span class="text-[9px] text-slate-400 leading-tight">S√°ng t·∫°o ri√™ng b√©</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: SETUP & PREVIEW -->
                    <div class="lg:col-span-5 flex flex-col">
                        <div class="flex-grow space-y-6">
                            <label
                                class="text-[11px] font-black text-primary uppercase tracking-[0.2em] px-2 flex items-center gap-2">
                                <span
                                    class="w-5 h-5 bg-primary/10 rounded-md flex items-center justify-center text-[10px]">3</span>
                                CHI TI·∫æT TR·∫¨N ƒê·∫§U
                            </label>

                            <div id="task-setup-placeholder"
                                class="h-full flex flex-col items-center justify-center text-center p-10 border-2 border-dashed border-slate-100 dark:border-white/5 rounded-[3rem] bg-slate-50/50 dark:bg-black/10">
                                <span class="material-symbols-outlined text-5xl text-slate-300 mb-4">edit_note</span>
                                <p class="text-slate-400 font-bold text-sm">Vui l√≤ng ch·ªçn ƒë·ªëi th·ªß v√† nhi·ªám v·ª• ƒë·ªÉ ti·∫øp
                                    t·ª•c</p>
                            </div>

                            <!-- Real Setup Form (Visible when selections made) -->
                            <div id="task-setup-container"
                                class="hidden space-y-6 animate-in fade-in slide-in-from-right-4 duration-500">
                                <!-- Inputs -->
                                <div
                                    class="bg-slate-50 dark:bg-black/20 p-6 rounded-[2.5rem] border border-slate-100 dark:border-white/5 space-y-5">
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <span
                                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest pl-2">T√™n
                                                k√®o ƒë·∫•u</span>
                                            <span id="task-source-tag"
                                                class="text-[8px] font-black bg-primary/10 text-primary px-2 py-0.5 rounded-full uppercase">M·∫∑c
                                                ƒë·ªãnh</span>
                                        </div>
                                        <input type="text" id="task-title-input" oninput="updateSubmitBtn()"
                                            class="w-full bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-white/5 rounded-2xl px-5 py-4 text-sm font-black focus:border-primary outline-none transition-all shadow-sm"
                                            placeholder="Vi·∫øt t√™n k√®o...">
                                    </div>
                                    <div>
                                        <span
                                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest pl-2 block mb-2">ƒêi·ªÅu
                                            ki·ªán th·∫Øng</span>
                                        <textarea id="task-desc-input"
                                            class="w-full bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-white/5 rounded-2xl px-5 py-4 text-xs font-medium focus:border-primary outline-none transition-all resize-none h-24 shadow-sm"
                                            placeholder="M√¥ t·∫£ c√°ch ƒë·ªÉ th·∫Øng..."></textarea>
                                    </div>
                                </div>

                                <!-- Betting -->
                                <div
                                    class="bg-gradient-to-br from-arena-orange/5 to-primary/5 p-6 rounded-[2.5rem] border border-arena-orange/20">
                                    <div class="flex items-center justify-between mb-3 px-2">
                                        <label
                                            class="text-[10px] font-black text-arena-orange uppercase tracking-widest">üí∞
                                            M·ª®C ƒê·∫∂T C∆Ø·ª¢C</label>
                                        <span class="text-[9px] font-bold text-slate-400">S·ªë d∆∞: <span
                                                id="user-gold-balance" class="text-primary font-black">0</span></span>
                                    </div>
                                    <div class="relative">
                                        <span
                                            class="material-symbols-outlined absolute left-5 top-1/2 -translate-y-1/2 text-primary">monetization_on</span>
                                        <input type="number" id="bet-input" value="10" min="0" step="10"
                                            oninput="updateSubmitBtn()"
                                            class="w-full bg-white dark:bg-slate-800 border-2 border-primary/30 rounded-2xl pl-14 pr-4 py-4 text-xl font-black text-primary focus:border-primary outline-none transition-all shadow-sm">
                                        <div class="absolute right-3 top-1/2 -translate-y-1/2 flex gap-1">
                                            <button onclick="addToBet(10)"
                                                class="px-3 py-1.5 bg-primary/10 text-primary text-[10px] font-black rounded-lg hover:bg-primary/20 transition-all">+10</button>
                                            <button onclick="betAll()"
                                                class="px-3 py-1.5 bg-rose-500/10 text-rose-500 text-[10px] font-black rounded-lg hover:bg-rose-500/20 transition-all">T·∫•t</button>
                                        </div>
                                    </div>
                                    <p class="text-[8px] text-slate-400 mt-3 text-center italic">Th·∫Øng nh·∫≠n <span
                                            class="text-emerald-500 font-bold">G·∫§P ƒê√îI</span>, Thua m·∫•t s·∫°ch!</p>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="mt-10 pt-6 border-t border-slate-100 dark:border-white/5 flex gap-4">
                            <button onclick="closeChallengeModal()"
                                class="flex-1 py-5 bg-slate-100 dark:bg-white/5 text-slate-500 dark:text-slate-400 font-black rounded-2xl hover:bg-slate-200 transition-all text-sm uppercase tracking-widest">H·ª¶Y</button>
                            <button id="btn-submit-challenge" onclick="submitChallenge()" disabled
                                class="flex-[2] py-5 bg-gradient-to-r from-arena-orange to-primary opacity-40 cursor-not-allowed text-white font-black rounded-2xl shadow-xl shadow-arena-orange/20 text-lg uppercase italic tracking-tighter">B·∫ÆT
                                ƒê·∫¶U CHI·∫æN! ‚öîÔ∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================ REVEAL DRAMA MODAL (IMPROVED) ================ -->
    <div id="reveal-modal"
        class="fixed inset-0 z-[200] flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-500">
        <div id="reveal-overlay" class="absolute inset-0 reveal-overlay-active"></div>
        <div id="reveal-content" class="w-full max-w-lg text-center text-white relative z-10">
            <div class="text-9xl mb-12 chest-drama" id="drama-chest">üéÅ</div>
            <h3 class="text-4xl font-black italic tracking-tighter mb-4">ƒêANG PH√ÅN QUY·∫æT...</h3>
            <div class="w-full bg-white/10 h-4 rounded-full overflow-hidden max-w-sm mx-auto p-1 border border-white/5">
                <div id="reveal-progress"
                    class="bg-gradient-to-r from-yellow-400 to-orange-500 h-full w-0 transition-all duration-[2500ms] ease-linear shadow-[0_0_20px_rgba(249,115,22,0.6)]">
                </div>
            </div>
            <p id="drama-text" class="text-yellow-400 font-black mt-6 uppercase tracking-widest text-sm animate-pulse">
                Tr·ªçng t√†i ƒëang xem bƒÉng ghi h√¨nh!</p>
        </div>
    </div>

    <!-- ================ RESULT MODAL ================ -->
    <div id="result-modal"
        class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="result-content"
            class="result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)] transform scale-75 transition-all duration-300 text-white overflow-hidden relative">
            <div class="absolute inset-0 opacity-10">
                <div class="absolute top-0 left-0 w-40 h-40 bg-white rounded-full -translate-x-1/2 -translate-y-1/2">
                </div>
                <div class="absolute bottom-0 right-0 w-60 h-60 bg-white rounded-full translate-x-1/2 translate-y-1/2">
                </div>
            </div>
            <div class="relative z-10">
                <div id="result-emoji" class="text-8xl mb-6 result-pop">üèÜ</div>
                <h3 id="result-title" class="text-4xl font-black mb-3 uppercase tracking-tighter italic">TH·∫ÆNG R·ªíI!</h3>
                <p id="result-desc" class="text-blue-100 font-bold mb-8">ƒêang t√≠nh to√°n k·∫øt qu·∫£...</p>

                <div class="grid grid-cols-3 gap-3 mb-10">
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <p id="res-stickers" class="text-3xl font-black text-yellow-300">+3</p>
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/60">Stickers</p>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <p id="res-gold" class="text-3xl font-black text-white">+50</p>
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/60">Gold</p>
                    </div>
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <p id="res-xp" class="text-3xl font-black text-white">+25</p>
                        <p class="text-[8px] font-black uppercase tracking-widest text-white/60">EXP</p>
                    </div>
                </div>

                <button onclick="closeResultModal()"
                    class="w-full py-5 bg-white text-slate-800 font-black rounded-3xl text-xl hover:bg-yellow-50 transition-all active:scale-95 shadow-xl">
                    ƒê√É HI·ªÇU! üéâ
                </button>
            </div>
        </div>
    </div>

    <!-- ================ WAITING MODAL ================ -->
    <div id="waiting-modal"
        class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-xl opacity-0 pointer-events-none transition-all duration-300">
        <div id="waiting-modal-content" class="text-center text-white max-w-sm">
            <div class="relative w-32 h-32 mx-auto mb-8">
                <img id="waiting-opponent-avatar" src=""
                    class="w-full h-full rounded-full border-4 border-arena-orange shadow-2xl relative z-10">
                <div class="absolute -inset-4 border-2 border-white/20 rounded-full animate-ping"></div>
                <div class="absolute -inset-8 border-2 border-white/10 rounded-full animate-ping"
                    style="animation-delay: 0.5s"></div>
            </div>
            <h3 class="text-3xl font-black mb-4 uppercase italic">ƒêANG G·ª¨I L·ªúI M·ªúI...</h3>
            <p class="text-slate-300 font-medium mb-8">ƒêang li√™n l·∫°c v·ªõi <span id="waiting-opponent-name"
                    class="text-arena-orange font-black">ƒë·ªëi th·ªß</span> qua chi·∫øn h·∫°m, vui l√≤ng ch·ªù trong gi√¢y l√°t!</p>

            <div class="progress-line mb-6"></div>
            <div id="countdown-timer" class="text-5xl font-black text-arena-orange italic">10</div>
            <p class="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] mt-2">Gi√¢y</p>
        </div>
    </div>

    <!-- ================ BOT INVITATION MODAL (NEW) ================ -->
    <div id="bot-invitation-modal"
        class="fixed inset-0 z-[250] flex items-center justify-center p-0 bg-black backdrop-blur-3xl opacity-0 pointer-events-none transition-all duration-700">

        <!-- Background VFX -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div
                class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(234,179,8,0.1)_0%,transparent_70%)] animate-pulse">
            </div>
            <div class="lightning-overlay absolute inset-0 bg-white/20"></div>
        </div>

        <div id="bot-invitation-content"
            class="w-full h-full transform scale-90 transition-all duration-700 overflow-hidden relative bg-[#0f172a] flex flex-col justify-center">

            <!-- Animated Split Background -->
            <div class="absolute inset-0 flex pointer-events-none z-0">
                <div class="w-full h-full absolute inset-0 flex">
                    <div class="w-1/2 bg-gradient-to-br from-rose-600 via-rose-800 to-black lightning-split opacity-80">
                    </div>
                    <div
                        class="w-1/2 bg-gradient-to-br from-blue-600 via-blue-800 to-black lightning-split-right opacity-80 ms-[-20%]">
                    </div>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-transparent opacity-90">
                </div>
            </div>

            <div class="relative z-10 p-10 sm:p-14 text-center">
                <!-- Battle Header -->
                <div class="mb-12">
                    <div
                        class="inline-flex items-center gap-2 px-6 py-2 rounded-full bg-white/10 border border-white/20 backdrop-blur-md mb-8">
                        <span class="material-symbols-outlined text-yellow-400 text-sm animate-spin">stars</span>
                        <span class="text-[10px] font-black text-white uppercase tracking-[0.3em]">L·ªúI TH√ÅCH ƒê·∫§U T·ª™
                            HUY·ªÄN THO·∫†I</span>
                    </div>

                    <div class="flex items-center justify-center gap-4 sm:gap-10">
                        <!-- Bot Side -->
                        <div class="flex flex-col items-center gap-6 group">
                            <div class="relative">
                                <div class="absolute -inset-4 bg-rose-500/30 rounded-full blur-2xl animate-pulse"></div>
                                <img id="invitation-bot-avatar" src=""
                                    class="w-28 h-28 sm:w-40 sm:h-40 rounded-full border-4 border-white shadow-[0_0_40px_rgba(244,63,94,0.6)] relative z-10 aura-active-red">
                                <div
                                    class="absolute -bottom-3 -right-3 bg-red-600 text-white text-[10px] font-black px-4 py-2 rounded-2xl shadow-2xl z-20 uppercase tracking-tighter border-2 border-white/20">
                                    ATTACKER</div>
                            </div>
                            <h3 class="text-2xl font-black text-white uppercase italic tracking-widest drop-shadow-lg"
                                id="invitation-bot-name">Hi·ªáp sƒ©</h3>
                            <div id="invitation-bot-rank"
                                class="mt-2 inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-rose-500/20 border border-rose-500/30 text-rose-300 font-black text-xs uppercase tracking-[0.2em] backdrop-blur-md">
                                <span class="material-symbols-outlined text-[14px]">military_tech</span>
                                H·∫†NG <span id="invitation-bot-rank-num">-</span>
                            </div>
                        </div>

                        <!-- VS Center -->
                        <div class="relative py-10">
                            <div
                                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-yellow-500/20 blur-3xl rounded-full animate-pulse">
                            </div>
                            <span
                                class="vs-text-styled text-7xl sm:text-8xl drop-shadow-[0_0_30px_rgba(255,255,255,0.5)]">VS</span>
                        </div>

                        <!-- Your Side -->
                        <div class="flex flex-col items-center gap-6">
                            <div class="relative">
                                <div class="absolute -inset-4 bg-blue-500/20 rounded-full blur-2xl"></div>
                                <img id="invitation-your-avatar" src=""
                                    class="w-28 h-28 sm:w-40 sm:h-40 rounded-full border-4 border-white/40 shadow-2xl relative z-10 grayscale-[0.5] opacity-80 aura-active-blue">
                                <div
                                    class="absolute -bottom-3 -left-3 bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-2xl shadow-2xl z-20 uppercase tracking-tighter border-2 border-white/20">
                                    DEFENDER</div>
                            </div>
                            <h3 class="text-2xl font-black text-white uppercase italic tracking-widest drop-shadow-lg"
                                id="invitation-your-name">B·∫†N</h3>
                            <div id="invitation-your-rank"
                                class="mt-2 inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-blue-500/20 border border-blue-500/30 text-blue-300 font-black text-xs uppercase tracking-[0.2em] backdrop-blur-md">
                                <span class="material-symbols-outlined text-[14px]">stars</span>
                                H·∫†NG <span id="invitation-your-rank-num">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Card Enhnaced -->
                <div
                    class="invitation-glass-card rounded-[3.5rem] p-8 mb-12 border-2 border-white/10 relative overflow-hidden scanner-effect group hover:border-yellow-500/50 transition-colors">
                    <div class="absolute top-0 right-0 p-6 opacity-5 group-hover:opacity-20 transition-opacity">
                        <span class="material-symbols-outlined text-8xl text-white">swords</span>
                    </div>

                    <p class="text-[11px] font-black text-yellow-500 uppercase tracking-[0.4em] mb-6">NHI·ªÜM V·ª§ CHI·∫æN ƒê·∫§U
                    </p>

                    <div class="flex items-center justify-center gap-8 relative z-10">
                        <div
                            class="w-24 h-24 sm:w-32 sm:h-32 bg-white/5 rounded-[2.5rem] flex items-center justify-center border border-white/10 shadow-inner group-hover:scale-110 transition-transform">
                            <span id="invitation-task-emoji"
                                class="text-6xl sm:text-8xl filter drop-shadow-[0_10px_15px_rgba(0,0,0,0.5)]">‚öîÔ∏è</span>
                        </div>
                        <div class="text-left flex-1">
                            <span id="invitation-task-name"
                                class="text-3xl sm:text-5xl font-black text-white uppercase italic leading-none block mb-4 tracking-tighter drop-shadow-md">Nhi·ªám
                                v·ª•</span>
                            <div class="h-[2px] w-20 bg-gradient-to-r from-yellow-500 to-transparent mb-4"></div>
                            <p id="invitation-task-desc"
                                class="text-sm sm:text-lg text-slate-300 font-medium leading-snug italic opacity-80">
                                "B√© c√≥ d√°m nh·∫≠n l·ªùi th√°ch ƒë·∫•u n√†y kh√¥ng?"</p>
                        </div>
                    </div>
                </div>

                <!-- Action Central -->
                <div class="flex flex-col sm:flex-row gap-5 relative z-10">
                    <button id="btn-accept-bot" onclick="acceptBotChallenge()"
                        class="flex-[2] group py-8 bg-gradient-to-r from-yellow-400 via-orange-500 to-rose-600 text-white font-black rounded-[2.5rem] text-3xl shadow-[0_20px_60px_rgba(249,115,22,0.5)] hover:scale-[1.03] active:scale-95 transition-all flex items-center justify-center gap-4 shimmer-btn border-t-4 border-white/30">
                        <span class="material-symbols-outlined text-4xl animate-bounce">rocket_launch</span>
                        B·∫ÆT ƒê·∫¶U CHI·∫æN!
                    </button>
                    <button onclick="closeBotInvitation()"
                        class="flex-1 py-8 px-10 bg-white/5 hover:bg-white/10 text-white/50 hover:text-white font-black rounded-[2.5rem] text-xl backdrop-blur-3xl transition-all border border-white/10 hover:border-white/30">
                        ƒê·ªÇ SAU...
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- ================ DECLINE MODAL (NEW) ================ -->
    <div id="decline-modal"
        class="fixed inset-0 z-[170] flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-2xl opacity-0 pointer-events-none transition-all duration-300">
        <div id="decline-modal-content"
            class="text-center text-white max-w-sm transform scale-90 transition-all duration-300">
            <div class="relative w-32 h-32 mx-auto mb-8">
                <img id="decline-opponent-avatar" src=""
                    class="w-full h-full rounded-full border-4 border-rose-500 shadow-[0_0_30px_rgba(244,63,94,0.5)] grayscale relative z-10">
                <div class="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full p-1 shadow-lg z-20">
                    <span class="material-symbols-outlined text-sm font-black">block</span>
                </div>
            </div>
            <h3 class="text-3xl font-black mb-4 uppercase italic text-rose-500">L·ªúI T·ª™ CH·ªêI!</h3>
            <p class="text-slate-300 font-medium mb-8"><span id="decline-opponent-name"
                    class="text-white font-black">ƒë·ªëi th·ªß</span> hi·ªán ƒëang b·∫≠n r√®n luy·ªán v√† ch∆∞a th·ªÉ nh·∫≠n l·ªùi th√°ch ƒë·∫•u
                c·ªßa b√© l√∫c n√†y.</p>

            <button onclick="closeDeclineModal()"
                class="w-full py-4 bg-white text-slate-900 font-black rounded-3xl text-lg hover:scale-105 transition-all active:scale-95 shadow-xl">
                T√åM ƒê·ªêI TH·ª¶ KH√ÅC!
            </button>
            <p class="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] mt-6">R√∫t qu√¢n v·ªÅ doanh tr·∫°i!</p>
        </div>
    </div>

    <!-- ================ CHALLENGE DETAILS MODAL (NEW) ================ -->
    <div id="challenge-details-modal"
        class="fixed inset-0 z-[260] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md opacity-0 pointer-events-none transition-all duration-300">
        <div id="challenge-details-content"
            class="bg-white dark:bg-[#1a1611] w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl transform scale-95 transition-all duration-300 relative overflow-hidden">
            <button onclick="closeChallengeDetails()"
                class="absolute top-6 right-6 text-slate-400 hover:text-slate-600">
                <span class="material-symbols-outlined font-black">close</span>
            </button>

            <div class="text-center mb-8">
                <div id="details-task-emoji" class="text-7xl mb-4 animate-bounce">‚öîÔ∏è</div>
                <h3 id="details-task-name"
                    class="text-2xl font-black text-slate-800 dark:text-white uppercase leading-tight px-4">T√™n nhi·ªám v·ª•
                </h3>
                <div
                    class="inline-block px-4 py-1 bg-arena-orange/10 text-arena-orange text-[10px] font-black rounded-full mt-2 uppercase tracking-widest">
                    Chi ti·∫øt th·ª≠ th√°ch</div>
            </div>

            <div
                class="bg-slate-50 dark:bg-black/40 rounded-[2rem] p-6 mb-8 border-2 border-slate-100 dark:border-white/5">
                <p id="details-task-desc"
                    class="text-sm text-slate-600 dark:text-slate-300 font-medium leading-relaxed italic text-center">
                    "M√¥ t·∫£ chi ti·∫øt nhi·ªám v·ª• con c·∫ßn l√†m ƒë·ªÉ gi√†nh chi·∫øn th·∫Øng s·∫Ω hi·ªán ·ªü ƒë√¢y."
                </p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-2">
                <div class="flex items-center gap-3 bg-slate-100 dark:bg-white/5 p-4 rounded-3xl">
                    <span class="material-symbols-outlined text-arena-orange">person</span>
                    <div class="min-w-0">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">ƒê·ªëi th·ªß</p>
                        <p id="details-opponent" class="text-xs font-black truncate">ƒê·ªëi th·ªß</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-slate-100 dark:bg-white/5 p-4 rounded-3xl">
                    <span class="material-symbols-outlined text-yellow-500">monetization_on</span>
                    <div class="min-w-0">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Ti·ªÅn c∆∞·ª£c</p>
                        <p id="details-bet" class="text-xs font-black">0 V√†ng</p>
                    </div>
                </div>
            </div>

            <!-- Journey Logs (NEW) -->
            <div class="mt-8 pt-6 border-t border-slate-100 dark:border-white/5 overflow-hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm text-slate-400 animate-pulse">timeline</span>
                        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">H√†nh tr√¨nh</span>
                    </div>
                    <span class="text-[10px] font-black text-primary px-2 py-0.5 bg-primary/10 rounded-full">L·ªäCH
                        S·ª¨</span>
                </div>

                <div id="details-logs-list" class="space-y-3 max-h-40 overflow-y-auto pr-2 mb-4">
                    <!-- Logs list -->
                </div>

                <div class="flex gap-2">
                    <input id="details-log-input" type="text" placeholder="Con ƒë√£ l√†m ƒë∆∞·ª£c g√¨ r·ªìi?"
                        class="flex-1 bg-slate-50 dark:bg-black/40 border border-slate-200 dark:border-white/10 rounded-2xl px-4 py-2 text-xs font-bold outline-none focus:ring-2 focus:ring-primary/30 transition-all dark:text-white">
                    <button id="btn-add-log"
                        class="bg-primary text-white w-10 h-10 rounded-2xl flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                        <span class="material-symbols-outlined text-sm font-black">send</span>
                    </button>
                </div>
            </div>

            <p
                class="text-[10px] text-center text-slate-400 font-bold mt-6 uppercase tracking-widest italic animate-pulse">
                C·ªë g·∫Øng l√™n, con l√†m ƒë∆∞·ª£c m√†! üöÄ</p>
        </div>
    </div>
    <child-nav active="arena"></child-nav>

    <script>
        let selectedOpponentId = null;
        let selectedTaskType = null;
        let reportingChallengeId = null;

        // BotEngine logic is now handled globally by shared/js/arena-engine.js
        document.addEventListener('DOMContentLoaded', () => {
            if (window.AppState) {
                window.AppState.subscribe(data => renderArena(data));
                renderArena(window.AppState.data);
            }
        });

        // Delegate to global engine if needed by existing onclicks in HTML
        function openBotInvitation(bot, task) { window.ArenaEngine && window.ArenaEngine.openInvitation(bot, task); }
        function closeBotInvitation() { window.ArenaEngine && window.ArenaEngine.closeInvitation(); }
        function acceptBotChallenge() { window.ArenaEngine && window.ArenaEngine.acceptChallenge(); }

        function getRelativeTime(dateInput) {
            const now = new Date();
            const past = new Date(dateInput);
            const diffMs = now - past;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHrs = Math.floor(diffMin / 60);

            if (diffSec < 30) return 'V·ª´a xong';
            if (diffSec < 60) return `${diffSec} gi√¢y tr∆∞·ªõc`;
            if (diffMin < 60) return `${diffMin} ph√∫t tr∆∞·ªõc`;
            if (diffHrs < 24) return `${diffHrs} gi·ªù tr∆∞·ªõc`;
            return past.toLocaleDateString('vi-VN', { day: 'numeric', month: 'numeric' });
        }

        function playSound(id) {
            const audio = document.getElementById(id);
            if (audio) {
                // Th√™m try-catch ƒë·ªÉ tr√°nh l·ªói n·∫øu user ch∆∞a t∆∞∆°ng t√°c v·ªõi trang
                try {
                    audio.currentTime = 0;
                    audio.play().catch(e => { });
                } catch (e) { }
            }
        }

        let lastGridHash = "";
        let lastStatsHash = "";

        function renderArena(data) {
            if (!data || !data.user) return;

            const currentUserId = String(data.user.id);
            if (!currentUserId) return;

            const challenges = data.challenges || [];
            const logsHash = challenges.reduce((acc, c) => acc + (c.logs?.length || 0), 0);
            const confirmedHash = challenges.reduce((acc, c) => acc + (c.challengerConfirmed ? 1 : 0) + (c.opponentConfirmed ? 1 : 0), 0);

            // Local "started" states
            let startedHash = 0;
            challenges.forEach(c => {
                if (localStorage.getItem(`started_challenge_${c.id}`) === 'true') startedHash++;
            });

            // NEW: Split hashes to avoid unnecessary re-renders of the whole grid
            const gridHash = `${challenges.length}-${logsHash}-${confirmedHash}-${startedHash}`;
            const statsHash = `${data.user.gold}-${data.user.xp}-${data.user.level}`;

            // 1. Always update basic stats (cheap)
            requestAnimationFrame(() => {
                const activeToday = window.AppState.getDailyChallengeCount(currentUserId, 'active');
                const passiveToday = window.AppState.getDailyChallengeCount(currentUserId, 'passive');
                const activeRem = Math.max(0, 3 - activeToday);
                const passiveRem = Math.max(0, 3 - passiveToday);

                const activeEl = document.getElementById('active-counter');
                const passiveEl = document.getElementById('passive-counter');
                if (activeEl) {
                    activeEl.textContent = `${activeRem}/3`;
                    activeEl.className = activeRem === 0 ? "text-2xl font-black text-rose-500" : "text-2xl font-black text-arena-orange";
                }
                if (passiveEl) {
                    passiveEl.textContent = `${passiveRem}/3`;
                    passiveEl.className = passiveRem === 0 ? "text-2xl font-black text-rose-500" : "text-2xl font-black text-blue-500";
                }
                document.getElementById('welcome-text').textContent = `S·∫µn s√†ng ƒë·ªÉ tr·ªü th√†nh chi·∫øn th·∫ßn, ${data.user.name}?`;
            });

            // 2. Only re-render grids if data changed (expensive)
            if (gridHash === lastGridHash) return;
            lastGridHash = gridHash;

            const activeGrid = document.getElementById('active-challenges-grid');
            const completedGrid = document.getElementById('completed-challenges-grid');
            const newsGrid = document.getElementById('arena-news-list');
            const completedSection = document.getElementById('completed-section');
            const activeCount = document.getElementById('active-count');

            requestAnimationFrame(() => {
                // 2. Active Challenges (Grid)
                const myActive = (data.challenges || []).filter(c => c.status !== 'completed' && (c.challengerId === currentUserId || c.opponentId === currentUserId));
                if (myActive.length > 0) {
                    activeCount.textContent = myActive.length;
                    activeCount.classList.remove('hidden');
                    activeGrid.innerHTML = myActive.map((c, i) => renderActiveCard(c, data, i)).join('');
                    activeGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-8 pb-20 w-full"; // Explicitly ensure grid
                } else {
                    activeCount.classList.add('hidden');
                    activeGrid.innerHTML = `
                        <div class="col-span-full py-16 text-center bg-white/40 dark:bg-white/5 rounded-[2.5rem] border-2 border-dashed border-slate-200 dark:border-slate-800 w-full">
                            <span class="material-symbols-outlined text-5xl text-slate-300 mb-3 block">sports_kabaddi</span>
                            <p class="text-slate-400 font-bold">B·∫°n kh√¥ng c√≥ k√®o n√†o ƒëang ƒë·∫•u.</p>
                            <p class="text-slate-400 text-sm mt-1">H√£y th√°ch ƒë·∫•u ai ƒë√≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
                        </div>`;
                }

                // 3. User Stats (Lifetime)
                const myCompleted = (data.challenges || []).filter(c => c.status === 'completed' && (c.challengerId === currentUserId || c.opponentId === currentUserId));
                const winsEl = document.getElementById('user-wins');
                const drawsEl = document.getElementById('user-draws');
                const lossesEl = document.getElementById('user-losses');
                if (winsEl) winsEl.textContent = myCompleted.filter(c => c.winnerId === currentUserId).length;
                if (drawsEl) drawsEl.textContent = myCompleted.filter(c => c.winnerId === null).length;
                if (lossesEl) lossesEl.textContent = myCompleted.length - (myCompleted.filter(c => c.winnerId === currentUserId).length) - (myCompleted.filter(c => c.winnerId === null).length);

                // 4. Completed Section (History)
                const recentCompleted = [...myCompleted].reverse().slice(0, 6);
                if (recentCompleted.length > 0) {
                    completedSection.classList.remove('hidden');
                    completedGrid.innerHTML = recentCompleted.map(c => renderCompletedCard(c, data)).join('');
                } else {
                    completedSection.classList.add('hidden');
                }

                // 5. News & Opponents
                const othersChallenges = (data.challenges || [])
                    .filter(c => c.challengerId !== currentUserId && c.opponentId !== currentUserId)
                    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
                    .slice(0, 6);
                newsGrid.innerHTML = othersChallenges.length > 0 ? othersChallenges.map(c => renderNewsCard(c, data)).join('') : `<p class="text-xs text-slate-400 text-center py-4">ƒêang c·∫≠p nh·∫≠t tin t·ª©c t·ª´ v∆∞∆°ng qu·ªëc...</p>`;

                renderOpponentList(data);
            });
        }

        function renderActiveCard(c, data, index) {
            const leaderboard = data.leaderboard || [];
            const challenger = leaderboard.find(p => p.id === c.challengerId);
            const opponent = leaderboard.find(p => p.id === c.opponentId);

            if (!challenger || !opponent) return '';

            const currentUserId = data.user ? data.user.id : null;
            if (!currentUserId) return '';
            const isMyConfirmed = c.challengerId === currentUserId ? c.challengerConfirmed : c.opponentConfirmed;

            const cleanTaskName = c.taskType.split('||BET:')[0].split(' | ')[0];
            const taskEmoji = TASK_EMOJI[cleanTaskName] || '‚öîÔ∏è';

            const isChallengerConfirmed = c.challengerConfirmed === true;
            const isOpponentConfirmed = c.opponentConfirmed === true;

            const logs = c.logs || [];
            const chalLogs = logs.filter(l => l.authorId === c.challengerId).length;
            const oppLogs = logs.filter(l => l.authorId === c.opponentId).length;

            // Power Percentage calculation for Tug-of-war (Logs + Confirmation)
            let basePower = 50;
            const logWeight = 8; // Each log shifts the bar by 8%
            const statusWeight = 15; // Confirmation shifts by 15%

            let powerPercentage = basePower + (chalLogs - oppLogs) * logWeight;
            if (isChallengerConfirmed && !isOpponentConfirmed) powerPercentage += statusWeight;
            if (!isChallengerConfirmed && isOpponentConfirmed) powerPercentage -= statusWeight;

            // Clamp
            powerPercentage = Math.max(10, Math.min(90, powerPercentage));

            let powerComment = "B·∫§T PH√ÇN TH·∫ÆNG B·∫†I";
            if (powerPercentage > 65) powerComment = `${challenger.name.replace(' (Bot)', '').toUpperCase()} ƒêANG D√ÄN QU√ÇN √ÅP ƒê·∫¢O!`;
            else if (powerPercentage < 35) powerComment = `${opponent.name.replace(' (Bot)', '').toUpperCase()} ƒêANG CH·ªêNG TR·∫¢ QUY·∫æT LI·ªÜT!`;
            else if (chalLogs > 0 || oppLogs > 0) powerComment = "CHI·∫æN TR∆Ø·ªúNG ƒêANG C·ª∞C K·ª≤ CƒÇNG TH·∫≤NG!";

            const dominantSide = (powerPercentage > 60) ? 'challenger' : (powerPercentage < 40 ? 'opponent' : 'none');

            // Reveal logic
            // Reveal logic: If challenge was created after 19:00, reveal time is tomorrow at 19:00.
            // Otherwise, it's today at 19:00.
            const now = new Date();
            const created = c.createdAt ? new Date(c.createdAt) : new Date();

            const revealTime = new Date(created);
            revealTime.setHours(19, 0, 0, 0);

            // If the challenge was created AFTER that day's 19:00, 
            // the reveal is the NEXT day's 19:00.
            if (created >= revealTime) {
                revealTime.setDate(revealTime.getDate() + 1);
            }

            const isDebug = window.location.search.includes('debug=true');
            const isLateEnough = (now >= revealTime) || isDebug;

            const isStarted = localStorage.getItem(`started_challenge_${c.id}`) === 'true';
            let actionArea = '';
            if (isMyConfirmed === null || isMyConfirmed === undefined) {
                if (!isStarted) {
                    actionArea = `
                        <button onclick="startChallenge('${c.id}')"
                            class="group relative overflow-hidden btn-done-pulse px-10 py-5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-black rounded-3xl text-xl shadow-2xl active:scale-95 transition-all">
                            <span class="relative z-10 flex items-center gap-3">B·∫ÆT ƒê·∫¶U CHI·∫æN! <span class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">bolt</span></span>
                            <div class="absolute inset-0 bg-white/20 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                        </button>`;
                } else {
                    actionArea = `
                        <button onclick="openReportModal('${c.id}', '${cleanTaskName}')"
                            class="group relative overflow-hidden btn-done-pulse px-10 py-5 bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-black rounded-3xl text-xl shadow-2xl active:scale-95 transition-all">
                            <span class="relative z-10 flex items-center gap-3">X√ÅC NH·∫¨N HO√ÄN TH√ÄNH! <span class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">emoji_events</span></span>
                        </button>`;
                }
            } else if (!isLateEnough) {
                const statusColor = isMyConfirmed === true ? 'text-emerald-500 bg-emerald-500/10' : 'text-rose-500 bg-rose-500/10';
                const statusIcon = isMyConfirmed === true ? 'verified' : 'error';
                const statusText = isMyConfirmed === true ? 'ƒê√É B√ÅO C√ÅO XONG' : 'B√ÅO C√ÅO: CH∆ØA XONG';

                actionArea = `
                    <div class="flex flex-col items-center gap-3">
                        <div class="flex items-center gap-2 px-6 py-3 rounded-full ${statusColor} border border-current shadow-sm pulse-ring">
                            <span class="material-symbols-outlined">${statusIcon}</span>
                            <span class="font-black tracking-widest text-sm uppercase">${statusText}</span>
                        </div>
                        <p class="font-black text-rose-500 text-base animate-pulse tracking-tight italic">üî• 19:00 C√îNG B·ªê K·∫æT QU·∫¢</p>
                    </div>`;
            } else {
                actionArea = `
                    <button onclick="dramaReveal('${c.id}')"
                        class="btn-done-pulse px-12 py-6 bg-gradient-to-r from-yellow-400 via-orange-500 to-rose-500 text-white font-black rounded-3xl text-2xl shadow-[0_15px_40px_-10px_rgba(249,115,22,0.6)] flex items-center justify-center gap-4 active:scale-95 transition-all hover:rotate-1">
                        üéÅ M·ªû R∆Ø∆†NG K·∫æT QU·∫¢!
                    </button>`;
            }

            return `
                <div class="gladiator-card rounded-[3.5rem] bg-white dark:bg-[#1a140c] shadow-xl overflow-hidden relative group border-2 border-slate-100 dark:border-slate-800 flex flex-col cursor-pointer active:scale-95 transition-all w-full shrink-0 min-h-[500px]" onclick="openChallengeDetails('${c.id}')">
                    <!-- Background Split -->
                    <div class="absolute inset-0 flex pointer-events-none">
                        <div class="w-1/2 bg-blue-50/50 dark:bg-blue-900/5 transform -skew-x-12 -translate-x-12"></div>
                        <div class="w-1/2 bg-rose-50/50 dark:bg-rose-900/5 transform -skew-x-12 -translate-x-4"></div>
                    </div>

                    <!-- Header -->
                    <div class="relative z-10 py-4 px-6 sm:px-8 flex items-center justify-between border-b border-slate-100 dark:border-white/5 bg-white/60 dark:bg-black/40 backdrop-blur-md">
                        <div class="flex items-center gap-2">
                           <div class="w-2 h-2 rounded-full bg-rose-500 animate-ping"></div>
                           <span class="text-[9px] sm:text-[11px] font-black text-slate-800 dark:text-white tracking-[0.2em] uppercase">K√®o ƒë·∫•u c·ªßa b·∫°n</span>
                        </div>
                        <span class="text-[8px] sm:text-[10px] text-slate-400 font-black uppercase tracking-widest">${c.date}</span>
                    </div>

                    <!-- Content Area -->
                    <div class="relative z-10 p-6 sm:p-8 flex-grow">
                        <!-- VS Section -->
                        <div class="flex items-center justify-between gap-4 mb-4">
                            <!-- Challenger (You) -->
                            <div class="flex flex-col items-center gap-4 flex-1">
                                <div class="relative">
                                    <div class="absolute -inset-2 bg-blue-500/10 rounded-full"></div>
                                    <img src="${challenger ? challenger.avatar : ''}" 
                                        onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Me'"
                                        class="w-20 h-20 sm:w-28 sm:h-28 rounded-full border-4 border-white shadow-xl relative z-20 ${isChallengerConfirmed ? 'aura-active-blue' : ''} ${dominantSide === 'challenger' ? 'dominant-blue' : ''} transition-all duration-300">
                                    <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-blue-500 rounded-full border-4 border-white dark:border-[#1a140c] flex items-center justify-center z-30">
                                        <span class="material-symbols-outlined text-white text-[10px] font-bold">face</span>
                                    </div>
                                </div>
                                <span class="text-[10px] sm:text-base font-black text-blue-600 dark:text-blue-400 uppercase tracking-tighter">${challenger ? (challenger.id === currentUserId ? 'B·∫°n' : challenger.name.replace(' (Bot)', '')) : 'B·∫°n'}</span>
                            </div>

                            <!-- VS Badge -->
                            <div class="flex flex-col items-center gap-2 px-2 shrink-0">
                                <div class="bg-gradient-to-br from-slate-800 to-black text-white w-12 h-12 sm:w-16 sm:h-16 rounded-2xl flex items-center justify-center font-black text-lg italic shadow-xl transform rotate-12 -translate-y-4 group-hover:rotate-0 transition-transform duration-300 border-2 border-white dark:border-slate-800">VS</div>
                            </div>

                            <!-- Opponent -->
                            <div class="flex flex-col items-center gap-4 flex-1">
                                <div class="relative">
                                    <div class="absolute -inset-2 bg-rose-500/10 rounded-full"></div>
                                    <img src="${opponent ? opponent.avatar : ''}" 
                                        onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Enemy'"
                                        class="w-20 h-20 sm:w-28 sm:h-28 rounded-full border-4 border-white shadow-xl relative z-20 ${isOpponentConfirmed ? 'aura-active-red' : ''} ${dominantSide === 'opponent' ? 'dominant-red' : ''} transition-all duration-300">
                                    <div class="absolute -bottom-1 -left-1 w-8 h-8 bg-rose-500 rounded-full border-4 border-white dark:border-[#1a140c] flex items-center justify-center z-30">
                                        <span class="material-symbols-outlined text-white text-[10px] font-bold">face</span>
                                    </div>
                                </div>
                                <span class="text-[10px] sm:text-base font-black text-rose-600 dark:text-rose-400 uppercase tracking-tighter">${opponent ? opponent.name.replace(' (Bot)', '') : 'ƒê·ªëi th·ªß'}</span>
                            </div>
                        </div>

                        <!-- Task Banner -->
                        <div class="bg-white dark:bg-slate-800 rounded-[2.5rem] p-4 sm:p-6 shadow-xl border border-slate-100 dark:border-white/5 mb-6 transform scale-100 group-hover:scale-[1.03] transition-transform flex items-center gap-4 sm:gap-6 justify-center overflow-hidden relative">
                            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_transparent_0%,_rgba(0,0,0,0.05)_100%)]"></div>
                            <span class="text-3xl sm:text-5xl drop-shadow-lg relative z-10">${taskEmoji}</span>
                            <div class="text-left relative z-10">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-[0.3em] mb-1">M·ª•c ti√™u th·ª≠ th√°ch</p>
                                <p class="font-black text-xl sm:text-3xl text-slate-800 dark:text-white uppercase italic tracking-tighter leading-none">${cleanTaskName}</p>
                            </div>
                        </div>

                        <!-- NEW: Dynamic Tug-of-War Logic -->
                        <div class="mb-10 px-4 relative">
                            <div class="flex items-center justify-between mb-3 px-2">
                                <span class="text-[10px] font-black ${isChallengerConfirmed ? 'text-blue-600' : 'text-slate-400'} uppercase tracking-widest flex items-center gap-1">
                                    ${isChallengerConfirmed ? '<span class="w-2 h-2 rounded-full bg-blue-500 animate-ping"></span> ƒê√É RA QU√ÇN' : 'ƒêANG CHU·∫®N B·ªä...'}
                                </span>
                                <span class="text-[10px] font-black ${isOpponentConfirmed ? 'text-rose-600' : 'text-slate-400'} uppercase tracking-widest flex items-center gap-1">
                                    ${isOpponentConfirmed ? 'ƒê√É RA QU√ÇN <span class="w-2 h-2 rounded-full bg-rose-500 animate-ping"></span>' : '...ƒêANG CHU·∫®N B·ªä'}
                                </span>
                            </div>
                            
                            <div class="h-5 bg-slate-300 dark:bg-black/60 rounded-full relative overflow-visible border-2 border-white dark:border-slate-800 shadow-inner struggle-container">
                                <!-- Mystery Overlay for both done -->
                                ${isChallengerConfirmed && isOpponentConfirmed ? `
                                    <div class="absolute -inset-1 bg-yellow-400/10 rounded-full animate-pulse z-40 border-2 border-yellow-400/30"></div>
                                ` : ''}

                                <!-- Power Fill (Blue) -->
                                <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-blue-600 via-blue-400 to-blue-500 power-bar-fill shadow-[0_0_20px_rgba(59,130,246,0.6)] transition-all duration-1000 rounded-l-full ${dominantSide === 'challenger' ? 'bar-dominant' : ''}" 
                                     style="width: ${powerPercentage}%">
                                     ${dominantSide === 'challenger' ? '<div class="absolute inset-0 bg-white/20 animate-pulse rounded-full"></div>' : ''}
                                </div>
                                <!-- Power Fill (Red) -->
                                <div class="absolute inset-y-0 right-0 bg-gradient-to-l from-rose-600 via-rose-400 to-rose-500 power-bar-fill shadow-[0_0_20px_rgba(244,63,94,0.6)] transition-all duration-1000 rounded-r-full ${dominantSide === 'opponent' ? 'bar-dominant' : ''}" 
                                     style="width: ${100 - powerPercentage}%">
                                     ${dominantSide === 'opponent' ? '<div class="absolute inset-0 bg-white/20 animate-pulse rounded-full"></div>' : ''}
                                </div>
                                
                                <!-- Central Bolt with Struggle -->
                                <div class="absolute top-1/2 z-30 transition-all duration-1000 ${isChallengerConfirmed && isOpponentConfirmed ? 'bolt-moving' : 'lightning-bolt-vfx'}"
                                     style="left: ${powerPercentage}%">
                                    <span class="material-symbols-outlined text-yellow-400 text-2xl filter drop-shadow-[0_0_8px_white] -translate-x-1/2 -translate-y-1/2">bolt</span>
                                </div>
                            </div>
                            
                            <div class="mt-5 text-center">
                                <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-slate-100 dark:bg-white/5 rounded-full border border-slate-200 dark:border-white/10">
                                    <span class="w-2 h-2 rounded-full bg-arena-orange animate-ping"></span>
                                    <p class="text-[10px] font-black text-slate-500 dark:text-slate-300 uppercase tracking-[0.2em]">
                                        TH·∫æ TR·∫¨N: <span class="text-arena-orange dark:text-yellow-400 italic">${powerComment}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Area -->
                        <div class="flex justify-center min-h-[80px] items-center" onclick="event.stopPropagation()">
                            ${actionArea}
                        </div>

                        <!-- NEW: Journey Logs Section -->
                        <div class="mt-8 pt-4 border-t border-slate-100 dark:border-white/5">
                            <div class="flex items-center justify-between mb-3 px-1">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm bg-slate-100 dark:bg-white/5 p-1 rounded-md">timeline</span> Nh·∫≠t k√Ω h√†nh tr√¨nh
                                </span>
                                <button onclick="addLogPrompt('${c.id}')" class="text-[9px] font-black text-primary bg-primary/10 px-3 py-1.5 rounded-full hover:bg-primary/20 transition-all flex items-center gap-1 active:scale-90">
                                    <span class="material-symbols-outlined text-xs">add_circle</span> C·∫¨P NH·∫¨T
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${logs.slice(-2).map(log => `
                                    <div class="flex gap-3 items-center bg-slate-50 dark:bg-black/20 p-2.5 rounded-2xl border border-slate-100 dark:border-white/5">
                                        <span class="text-[9px] bg-primary/10 text-primary px-2 py-0.5 rounded-lg font-black flex-shrink-0 shadow-sm">${log.authorName ? log.authorName.split(' ')[0] : 'B·∫°n'}</span>
                                        <p class="text-[11px] text-slate-700 dark:text-slate-200 font-bold leading-tight line-clamp-2">${log.text}</p>
                                    </div>
                                `).join('') || '<p class="text-[10px] text-slate-400 font-bold italic text-center py-2 opacity-60">Ch∆∞a c√≥ c·∫≠p nh·∫≠t n√†o...</p>'}
                            </div>
                        </div>
                </div>
                </div>
            </div>`;
        }

        function renderCompletedCard(c, data) {
            const leaderboard = data.leaderboard || [];
            const currentUserId = data.user ? data.user.id : null;
            const challenger = leaderboard.find(p => p.id === c.challengerId);
            const opponent = leaderboard.find(p => p.id === c.opponentId);
            if (!challenger || !opponent || !currentUserId) return '';

            const iWon = c.winnerId === currentUserId;
            const isDraw = c.winnerId === null;
            const cleanTaskName = c.taskType.split('||BET:')[0].split(' | ')[0];
            const taskEmoji = TASK_EMOJI[cleanTaskName] || '‚öîÔ∏è';

            let cardBg = "bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700";
            let textColor = "text-slate-700 dark:text-slate-200";
            let subTextColor = "text-slate-500 dark:text-slate-400";
            let statusBadge = '';

            if (isDraw) {
                statusBadge = '<span class="text-[10px] font-black text-slate-500 bg-slate-100 dark:bg-white/10 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700">HO√Ä</span>';
            } else if (iWon) {
                cardBg = "bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800/50";
                textColor = "text-green-800 dark:text-green-100";
                subTextColor = "text-green-600/70 dark:text-green-400/70";
                statusBadge = '<span class="text-[10px] font-black text-green-600 dark:text-green-400 bg-green-500/10 px-3 py-1 rounded-full border border-green-200 dark:border-green-800">üèÜ TH·∫ÆNG (+3 üéüÔ∏è)</span>';
            } else {
                cardBg = "bg-rose-50 dark:bg-rose-900/20 border-rose-200 dark:border-rose-800/50";
                textColor = "text-rose-800 dark:text-rose-100";
                subTextColor = "text-rose-600/70 dark:text-rose-400/70";
                statusBadge = '<span class="text-[10px] font-black text-rose-600 dark:text-rose-400 bg-rose-500/10 px-3 py-1 rounded-full border border-rose-200 dark:border-rose-800">THUA (-20 ü™ô)</span>';
            }

            return `
                <div class="relative rounded-3xl border-2 ${cardBg} p-5 flex flex-col gap-4 overflow-hidden hover:scale-[1.03] transition-all shadow-sm">
                    <div class="flex items-center justify-between relative z-10">
                        <div class="flex items-center gap-3 min-w-0">
                            <span class="text-2xl">${taskEmoji}</span>
                            <p class="font-black text-xs ${textColor} uppercase truncate tracking-tight">${cleanTaskName}</p>
                        </div>
                        <span class="text-[9px] font-bold ${subTextColor} shrink-0 bg-white/50 dark:bg-black/20 px-2 py-1 rounded-lg">${c.date}</span>
                    </div>

                    <div class="flex items-center justify-between gap-2 py-1 relative z-10">
                        <div class="flex flex-col items-center gap-2 flex-1 min-w-0">
                            <div class="relative">
                                <img src="${challenger.avatar}" class="w-12 h-12 rounded-full border-2 ${c.winnerId === c.challengerId ? 'border-yellow-400 shadow-lg scale-110 z-10' : 'border-white/50 dark:border-white/10'}">
                                ${c.winnerId === c.challengerId ? '<span class="absolute -top-2 -right-2 text-sm drop-shadow-md">üëë</span>' : ''}
                            </div>
                            <span class="text-[10px] font-black w-full text-center ${c.winnerId === c.challengerId ? textColor : subTextColor}">${challenger.name.replace(' (Bot)', '')}</span>
                        </div>

                        <div class="text-[10px] font-black text-slate-300 dark:text-slate-600 italic px-2">VS</div>

                        <div class="flex flex-col items-center gap-2 flex-1 min-w-0">
                            <div class="relative">
                                <img src="${opponent.avatar}" class="w-12 h-12 rounded-full border-2 ${c.winnerId === c.opponentId ? 'border-yellow-400 shadow-lg scale-110 z-10' : 'border-white/50 dark:border-white/10'}">
                                ${c.winnerId === c.opponentId ? '<span class="absolute -top-2 -left-2 text-sm drop-shadow-md">üëë</span>' : ''}
                            </div>
                            <span class="text-[10px] font-black truncate w-full text-center ${c.winnerId === c.opponentId ? textColor : subTextColor}">${opponent.name.replace(' (Bot)', '')}</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-center pt-3 border-t border-black/5 dark:border-white/5 relative z-10">
                        ${statusBadge}
                    </div>
                </div>`;
        }

        function renderNewsCard(c, data) {
            const leaderboard = data.leaderboard || [];
            const challenger = leaderboard.find(p => p.id === c.challengerId);
            const opponent = leaderboard.find(p => p.id === c.opponentId);
            if (!challenger || !opponent) return '';

            const cleanTaskName = c.taskType.split('||BET:')[0];
            const taskEmoji = TASK_EMOJI[cleanTaskName.split(' | ')[0]] || '‚öîÔ∏è';

            const createdAt = c.createdAt || new Date().toISOString();
            const relTime = getRelativeTime(createdAt);

            const isVeryRecent = (new Date() - new Date(createdAt)) < 1800000; // 30 mins

            let statusText = c.status === 'completed' ? 'K·∫æT TH√öC' : 'LIVE';
            let statusClass = c.status === 'completed' ? 'bg-slate-100 text-slate-500' : 'bg-rose-500 text-white animate-pulse shadow-[0_0_15px_rgba(244,63,94,0.4)]';

            if (c.status === 'completed' && isVeryRecent) {
                statusText = 'V·ª™A XONG';
                statusClass = 'bg-emerald-500 text-white shadow-[0_0_15px_rgba(16,185,129,0.4)]';
            }

            return `
                <div class="bg-white dark:bg-[#2c2215] border-2 border-slate-50 dark:border-slate-800/50 rounded-2xl p-4 flex items-center justify-between hover:border-primary/30 hover:shadow-lg transition-all duration-300 group">
                    <div class="flex items-center gap-4">
                        <div class="relative shrink-0 flex -space-x-3 group-hover:-space-x-1 transition-all duration-500">
                            <img src="${challenger.avatar}" class="w-11 h-11 rounded-full border-2 border-white dark:border-slate-800 shadow-md z-10">
                            <img src="${opponent.avatar}" class="w-11 h-11 rounded-full border-2 border-white dark:border-slate-800 shadow-md">
                            ${c.status !== 'completed' ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-rose-500 border-2 border-white dark:border-[#2c2215] rounded-full animate-pulse"></div>' : ''}
                        </div>
                        <div class="min-w-0">
                            <p class="text-[12px] font-black text-slate-800 dark:text-white leading-tight mb-1">
                                <span class="text-primary">${challenger.name.replace(' (Bot)', '')}</span>
                                <span class="text-slate-400 font-medium italic opacity-80">v·ª´a ra tay th√°ch ƒë·∫•u</span>
                                <span class="text-primary">${opponent.name.replace(' (Bot)', '')}</span>
                            </p>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest bg-slate-100 dark:bg-white/5 px-2 py-0.5 rounded flex items-center gap-1">
                                    ${taskEmoji} ${cleanTaskName.split(' | ')[0]}
                                </span>
                                <span class="text-[9px] font-bold text-slate-300 dark:text-slate-500">‚Ä¢ ${relTime}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1 shrink-0">
                        <span class="px-3 py-1.5 rounded-xl text-[9px] font-black tracking-widest flex items-center gap-1.5 ${statusClass}">
                            ${c.status !== 'completed' ? '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span></span>' : ''}
                            ${statusText}
                        </span>
                    </div>
                </div>`;
        }

        // --- NEW MODAL CONTROLS ---
        function openReportModal(challengeId, taskType) {
            playSound('snd-click');
            reportingChallengeId = challengeId;
            document.getElementById('report-task-emoji').textContent = TASK_EMOJI[taskType] || '‚öîÔ∏è';

            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-modal-content');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-90'), 10);
        }

        function closeReportModal() {
            const modal = document.getElementById('report-modal');
            const content = document.getElementById('report-modal-content');
            content.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                reportingChallengeId = null;
            }, 200);
        }

        // ================ CHALLENGE DETAILS MODAL LOGIC (NEW) ================
        function startChallenge(id) {
            playSound('snd-click');
            localStorage.setItem(`started_challenge_${id}`, 'true');
            if (window.AppState) renderArena(window.AppState.data);

            // Removed alert to avoid inflation
            // window.showLevelUpAlert && window.showLevelUpAlert("Xung tr·∫≠n! ‚öîÔ∏è", "Th·ª≠ th√°ch ƒë√£ b·∫Øt ƒë·∫ßu. H√£y n·ªó l·ª±c h·∫øt m√¨nh ƒë·ªÉ gi√†nh chi·∫øn th·∫Øng nh√©!", "success");
        }

        function openChallengeDetails(challengeId) {
            if (!window.AppState) return;
            const chall = window.AppState.data.challenges.find(c => String(c.id) === String(challengeId));
            if (!chall) return;

            let rawTaskType = chall.taskType || chall.task_type;
            let taskName = rawTaskType;
            let betAmount = 0;
            if (rawTaskType && rawTaskType.includes('||BET:')) {
                const parts = rawTaskType.split('||BET:');
                taskName = parts[0];
                betAmount = parseInt(parts[1]) || 0;
            }

            const currentUserId = String(window.AppState.data.user.id);
            const challengerId = String(chall.challengerId || chall.challenger_id);
            const opponentId = String(chall.opponentId || chall.opponent_id);
            const targetOpponentId = challengerId === currentUserId ? opponentId : challengerId;
            const opponent = window.AppState.data.leaderboard.find(p => String(p.id) === String(targetOpponentId));

            document.getElementById('details-task-emoji').textContent = TASK_EMOJI[taskName] || '‚öîÔ∏è';
            document.getElementById('details-task-name').textContent = taskName.toUpperCase();
            document.getElementById('details-task-desc').textContent = TASK_CONDITIONS[taskName] || "H√£y c·ªë g·∫Øng ho√†n th√†nh!";
            document.getElementById('details-opponent').textContent = opponent ? opponent.name.replace(' (Bot)', '') : 'ƒê·ªëi th·ªß';
            document.getElementById('details-bet').textContent = betAmount > 0 ? `${betAmount} V√†ng` : '0 V√†ng';

            // Logs Rendering
            const logsList = document.getElementById('details-logs-list');
            const logs = chall.logs || [];
            if (logs.length === 0) {
                logsList.innerHTML = `<p class="text-[10px] text-slate-400 italic text-center py-4">Ch∆∞a c√≥ c·∫≠p nh·∫≠t n√†o.<br>Con h√£y ghi l·∫°i nh·ªØng vi·ªác t·ªët ƒë·∫ßu ti√™n nh√©!</p>`;
            } else {
                logsList.innerHTML = logs.map(log => `
                <div class="flex gap-3 text-left items-start bg-slate-50 dark:bg-black/20 p-2.5 rounded-2xl border border-slate-100 dark:border-white/5">
                         <span class="text-[10px] bg-primary/10 text-primary px-1.5 py-0.5 rounded font-black flex-shrink-0">${log.authorName ? log.authorName.split(' ')[0] : 'B√©'}</span>
                         <div class="min-w-0 flex-1">
                            <p class="text-[11px] text-slate-700 dark:text-slate-200 font-bold leading-tight">${log.text}</p>
                            <span class="text-[8px] text-slate-400 font-bold mt-1 block uppercase tracking-tighter">${new Date(log.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                         </div>
                </div>
                `).join('');
                setTimeout(() => logsList.scrollTop = logsList.scrollHeight, 100);
            }

            const btnAdd = document.getElementById('btn-add-log');
            const input = document.getElementById('details-log-input');
            btnAdd.onclick = async () => {
                const text = input.value.trim();
                if (!text) return;
                btnAdd.disabled = true;
                const ok = await window.AppState.addChallengeLog(chall.id, text);
                if (ok) {
                    input.value = '';
                    await window.AppState.syncFromDatabase();
                    openChallengeDetails(chall.id);
                }
                btnAdd.disabled = false;
            };

            const modal = document.getElementById('challenge-details-modal');
            const content = document.getElementById('challenge-details-content');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-95'), 10);
            playSound('snd-click');
        }

        function closeChallengeDetails() {
            const modal = document.getElementById('challenge-details-modal');
            const content = document.getElementById('challenge-details-content');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 200);
        }

        async function confirmReport(isSuccess) {
            if (!reportingChallengeId) {
                console.warn('[Arena] No reportingChallengeId set');
                return;
            }
            playSound('snd-click');

            const now = new Date();
            if (now.getHours() >= 19 && isSuccess) {
                if (window.showFamilyQuestAlert) {
                    window.showFamilyQuestAlert("Qu√° mu·ªôn r·ªìi!", "ƒê√£ qu√° 19:00 n√™n v√°n n√†y con b·ªã t√≠nh l√† ch∆∞a ho√†n th√†nh r·ªìi. Ph·∫£i b√°o c√°o s·ªõm h∆°n nh√©!", "warning");
                }
                isSuccess = false;
            }

            // Validate state
            if (!window.AppState || !window.AppState.data.user) {
                window.showLevelUpAlert && window.showLevelUpAlert("Ch∆∞a s·∫µn s√†ng", "D·ªØ li·ªáu ƒëang t·∫£i, h√£y ch·ªù ch√∫t r·ªìi th·ª≠ l·∫°i nh√©!", "warning");
                return;
            }

            const chall = window.AppState.data.challenges.find(c => c.id === reportingChallengeId);
            if (!chall) {
                console.warn('[Arena] Challenge not found:', reportingChallengeId);
                closeReportModal();
                window.showLevelUpAlert && window.showLevelUpAlert("K√®o ƒë·∫•u kh√¥ng t√¨m th·∫•y", "K√®o ƒë·∫•u n√†y c√≥ th·ªÉ ƒë√£ k·∫øt th√∫c. H√£y t·∫£i l·∫°i trang!", "warning");
                return;
            }

            if (chall.status === 'completed') {
                closeReportModal();
                window.showLevelUpAlert && window.showLevelUpAlert("K√®o ƒë√£ k·∫øt th√∫c", "K√®o ƒë·∫•u n√†y ƒë√£ c√≥ k·∫øt qu·∫£ r·ªìi!", "info");
                return;
            }

            const buttons = document.querySelectorAll('#report-modal-content button');
            const submitBtn = isSuccess ? buttons[0] : buttons[1];

            if (submitBtn) {
                submitBtn.disabled = true;
                const originalContent = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-lg">sync</span> ƒêANG L∆ØU...';

                try {
                    const myId = String(window.AppState.data.user.id);
                    const isChallenger = String(chall.challengerId) === myId;
                    const updateField = isChallenger ? 'challenger_confirmed' : 'opponent_confirmed';

                    console.log(`[Arena] Confirming report: challenge = ${reportingChallengeId}, field = ${updateField}, value = ${isSuccess} `);

                    // Update directly to avoid potential issues in selfCompleteChallenge
                    const { error } = await window.AppState.client.from('challenges')
                        .update({ [updateField]: isSuccess })
                        .eq('id', reportingChallengeId);

                    if (error) {
                        console.error("[Arena] DB update error:", error);
                        throw error;
                    }

                    console.log('[Arena] Report saved successfully');
                    closeReportModal();

                    // Sync to refresh UI
                    await window.AppState.syncFromDatabase();

                    // Removed alert to avoid inflation
                    /*
                    window.showLevelUpAlert && window.showLevelUpAlert(
                        isSuccess ? "ƒê√£ ghi nh·∫≠n! üéâ" : "ƒê√£ ghi nh·∫≠n",
                        isSuccess ? "B·∫°n ƒë√£ b√°o c√°o ho√†n th√†nh. H√£y ch·ªù k·∫øt qu·∫£ t·ªëi nay nh√©!" : "K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n. C·ªë g·∫Øng h∆°n l·∫ßn sau nh√©!",
                        isSuccess ? "success" : "info"
                    );
                    */
                } catch (err) {
                    console.error("[Arena] confirmReport error:", err);
                    if (window.showLevelUpAlert) {
                        window.showLevelUpAlert("L·ªói h·ªá th·ªëng", "Kh√¥ng th·ªÉ g·ª≠i b√°o c√°o l√∫c n√†y. B√© h√£y th·ª≠ l·∫°i sau nh√©!", "error");
                    }
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalContent;
                }
            }
        }

        // ================ JOURNEY LOG MODAL LOGIC ================
        let activeChallengeIdForLog = null;

        function addLogPrompt(challengeId) {
            event.stopPropagation();
            activeChallengeIdForLog = challengeId;

            const modal = document.getElementById('journey-log-modal');
            const content = document.getElementById('journey-log-modal-content');
            const input = document.getElementById('journey-log-input');

            input.value = "";
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-90'), 10);
            setTimeout(() => input.focus(), 300);
        }

        function closeJourneyLogModal() {
            const modal = document.getElementById('journey-log-modal');
            const content = document.getElementById('journey-log-modal-content');

            content.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                activeChallengeIdForLog = null;
            }, 200);
        }

        async function submitJourneyLog() {
            const input = document.getElementById('journey-log-input');
            const text = input.value.trim();
            if (!text) return;

            const btn = document.getElementById('btn-submit-journey');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span>';

            try {
                if (!window.AppState) return;
                const ok = await window.AppState.addChallengeLog(activeChallengeIdForLog, text);

                if (ok) {
                    playSound('snd-click');
                    closeJourneyLogModal();
                    // Sync immediately to show new log
                    await window.AppState.syncFromDatabase();
                } else {
                    window.showLevelUpAlert && window.showLevelUpAlert('L·ªói', 'Kh√¥ng th·ªÉ l∆∞u nh·∫≠t k√Ω. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
                }
            } catch (err) {
                console.error('[Arena] submitLog error:', err);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function dramaReveal(challengeId) {
            playSound('snd-click');
            const modal = document.getElementById('reveal-modal');
            const progress = document.getElementById('reveal-progress');

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                progress.style.width = '100%';
                playSound('snd-chest');
            }, 100);

            // Fetch the challenge to know our role BEFORE showing results
            const chall = window.AppState.data.challenges.find(c => c.id === challengeId);
            const myId = window.AppState.data.user.id;
            const amIChallenger = chall.challengerId === myId;

            setTimeout(async () => {
                try {
                    const result = await window.AppState.revealChallenge(challengeId);
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    progress.style.width = '0%';
                    if (result) {
                        showResultModal(result, amIChallenger);
                    } else {
                        // Fallback: sync and refresh the page UI
                        await window.AppState.syncFromDatabase();
                        window.showLevelUpAlert('K·∫øt qu·∫£ kh√¥ng t·∫£i ƒë∆∞·ª£c', 'H√£y t·∫£i l·∫°i trang ƒë·ªÉ xem k·∫øt qu·∫£ nh√©!', 'warning');
                    }
                } catch (err) {
                    console.error('[Arena] dramaReveal error:', err);
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    progress.style.width = '0%';
                    window.showLevelUpAlert('L·ªói t·∫£i k·∫øt qu·∫£', 'ƒê√£ c√≥ l·ªói x·∫£y ra. H√£y t·∫£i l·∫°i trang!', 'error');
                }
            }, 2700);
        }

        function showResultModal(result, amIChallenger) {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            const emoji = document.getElementById('result-emoji');
            const title = document.getElementById('result-title');
            const desc = document.getElementById('result-desc');
            const gText = document.getElementById('res-gold');
            const xText = document.getElementById('res-xp');
            const sText = document.getElementById('res-stickers');

            const myId = window.AppState.data.user.id;
            const iWon = result.winnerId === myId;
            const isDraw = result.draw;

            // L·∫•y ƒëi·ªÉm t∆∞∆°ng ·ª©ng v·ªõi vai tr√≤ c·ªßa m√¨nh
            const myG = amIChallenger ? result.pointsG_C : result.pointsG_O;
            const myXP = amIChallenger ? result.pointsXP_C : result.pointsXP_O;
            const myS = amIChallenger ? result.spins_C : result.spins_O;

            sText.textContent = (myS >= 0 ? '+' : '') + myS;
            gText.textContent = (myG >= 0 ? '+' : '') + myG;
            xText.textContent = (myXP >= 0 ? '+' : '') + myXP;

            // Reset lints
            gText.className = "text-3xl font-black text-white";
            xText.className = "text-3xl font-black text-white";

            if (iWon) {
                // let celebrate handle win sound (thang.mp3)
                emoji.textContent = 'üèÜ';
                title.textContent = 'TH·∫ÆNG R·ªíI!';
                desc.textContent = result.flavor || `Ch√∫c m·ª´ng ${window.AppState.data.user.name} !B·∫°n ƒë√£ chi·∫øn th·∫Øng k√®o ƒë·∫•u n√†y!`;
                content.className = "result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl text-white relative bg-gradient-to-br from-green-600 to-emerald-900";
                if (window.celebrate) {
                    window.celebrate({
                        type: 'challenge',
                        title: 'CHI·∫æN TH·∫ÆNG!',
                        subtitle: result.flavor || `Ch√∫c m·ª´ng ${window.AppState.data.user.name} !B·∫°n ƒë√£ v∆∞·ª£t qua ƒë·ªëi th·ªß xu·∫•t s·∫Øc!`,
                        icon: 'military_tech'
                    });
                }
            } else if (isDraw) {
                playSound('snd-draw');
                emoji.textContent = 'ü§ù';
                title.textContent = 'H√íA CU·ªòC!';
                desc.textContent = result.flavor || 'B·∫•t ph√¢n th·∫Øng b·∫°i! C·∫£ hai ƒë·ªÅu r·∫•t xu·∫•t s·∫Øc.';
                content.className = "result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl text-white relative bg-gradient-to-br from-blue-600 to-indigo-900";
            } else {
                // Ng·∫´u nhi√™n ch·ªçn 1 trong 2 √¢m thanh thua
                const loseSnd = Math.random() < 0.5 ? 'snd-lose' : 'snd-lose2';
                playSound(loseSnd);
                emoji.textContent = 'üí™';
                title.textContent = 'C·ªê G·∫ÆNG L√äN!';
                desc.textContent = result.flavor || `D√π k·∫øt qu·∫£ th·∫ø n√†o, n·ªó l·ª±c c·ªßa ${window.AppState.data.user.name} v·∫´n r·∫•t ƒë√°ng khen!`;
                content.className = "result-overlay w-full max-w-md rounded-[2.5rem] p-8 text-center shadow-2xl text-white relative bg-gradient-to-br from-rose-600 to-rose-900";
                gText.className = "text-3xl font-black text-rose-300";
                xText.className = "text-3xl font-black text-rose-300";
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-75'), 10);
        }

        function closeResultModal() {
            const modal = document.getElementById('result-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('result-content').classList.add('scale-75');
        }

        function openChallengeModal() {
            playSound('snd-click');
            const data = window.AppState.data;
            if (!data || !data.user) return;

            const activeUsed = window.AppState.getDailyChallengeCount(data.user.id, 'active');

            const modal = document.getElementById('challenge-modal');
            const content = document.getElementById('challenge-modal-content');

            // Reset placeholders & hidden states for new design
            const placeholder = document.getElementById('task-setup-placeholder');
            const setupContainer = document.getElementById('task-setup-container');
            if (placeholder) placeholder.classList.remove('hidden');
            if (setupContainer) setupContainer.classList.add('hidden');

            // Reset selection globals
            selectedOpponentId = null;
            selectedTaskType = null;
            document.querySelectorAll('.opponent-btn').forEach(b => b.classList.remove('border-primary', 'bg-primary/5', 'scale-105', 'z-10'));
            document.querySelectorAll('.task-btn').forEach(b => b.classList.remove('border-primary', 'bg-primary/10', 'ring-2', 'ring-primary/20'));

            if (activeUsed >= 3) {
                // You might want a different UI for over-limit in the new design
                // but for now let's keep the existing logic or just hide the submit button
            }

            renderOpponentList(data);

            // Reset bet input
            const betInput = document.getElementById('bet-input');
            if (betInput) betInput.value = 10;

            const goldBal = document.getElementById('user-gold-balance');
            if (goldBal) goldBal.textContent = data.user.gold || 0;

            updateSubmitBtn();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-95'), 10);
        }

        function closeChallengeModal() {
            const modal = document.getElementById('challenge-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('challenge-modal-content').classList.add('scale-95');
        }

        function openDeclineModal(avatar, name) {
            document.getElementById('decline-opponent-avatar').src = avatar;
            document.getElementById('decline-opponent-name').textContent = name.replace(' (Bot)', '');

            const modal = document.getElementById('decline-modal');
            const content = document.getElementById('decline-modal-content');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => content.classList.remove('scale-90'), 10);
        }

        function closeDeclineModal() {
            const modal = document.getElementById('decline-modal');
            const content = document.getElementById('decline-modal-content');
            content.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 200);
        }

        function selectOpponent(id, btn) {
            playSound('snd-click');
            selectedOpponentId = id;
            document.querySelectorAll('.opponent-btn').forEach(b => {
                b.classList.remove('border-primary', 'bg-primary/5', 'scale-105', 'z-10');
            });
            btn.classList.add('border-primary', 'bg-primary/5', 'scale-105', 'z-10');
            updateSubmitBtn();
        }

        function selectTask(btn, type) {
            playSound('snd-click');
            selectedTaskType = type;
            document.querySelectorAll('.task-btn').forEach(b => b.classList.remove('border-primary', 'bg-primary/10', 'ring-2', 'ring-primary/20'));
            btn.classList.add('border-primary', 'bg-primary/10', 'ring-2', 'ring-primary/20');

            const placeholder = document.getElementById('task-setup-placeholder');
            const setupContainer = document.getElementById('task-setup-container');
            const titleInput = document.getElementById('task-title-input');
            const descInput = document.getElementById('task-desc-input');
            const sourceTag = document.getElementById('task-source-tag');

            if (placeholder) placeholder.classList.add('hidden');
            setupContainer.classList.remove('hidden');

            sourceTag.textContent = "C√ì S·∫¥N";
            sourceTag.className = "text-[8px] font-black bg-emerald-500/10 text-emerald-500 px-2 py-0.5 rounded-full uppercase";

            titleInput.value = type;
            descInput.value = TASK_CONDITIONS[type] || 'H√£y ho√†n th√†nh th·ª≠ th√°ch n√†y th·∫≠t t·ªët nh√©!';

            updateSubmitBtn();
        }

        function showCustomTaskInput(btn) {
            playSound('snd-click');
            selectedTaskType = 'CUSTOM';
            document.querySelectorAll('.task-btn').forEach(b => b.classList.remove('border-primary', 'bg-primary/10', 'ring-2', 'ring-primary/20'));
            btn.classList.add('border-primary', 'bg-primary/10', 'ring-2', 'ring-primary/20');

            const placeholder = document.getElementById('task-setup-placeholder');
            const setupContainer = document.getElementById('task-setup-container');
            const titleInput = document.getElementById('task-title-input');
            const descInput = document.getElementById('task-desc-input');
            const sourceTag = document.getElementById('task-source-tag');

            if (placeholder) placeholder.classList.add('hidden');
            setupContainer.classList.remove('hidden');

            sourceTag.textContent = "B√â T·ª∞ T·∫†O";
            sourceTag.className = "text-[8px] font-black bg-primary/10 text-primary px-2 py-0.5 rounded-full uppercase";

            titleInput.value = '';
            descInput.value = '';
            titleInput.focus();

            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('btn-submit-challenge');
            const titleInput = document.getElementById('task-title-input');
            const isTitleFilled = titleInput.value.trim().length > 0;
            const ready = selectedOpponentId && selectedTaskType && isTitleFilled;

            btn.disabled = !ready;
            btn.classList.toggle('opacity-40', !ready);
            btn.classList.toggle('cursor-not-allowed', !ready);
        }

        function addToBet(amount) {
            playSound('snd-click');
            const input = document.getElementById('bet-input');
            const gold = window.AppState.data.user.gold || 0;
            let current = parseInt(input.value) || 0;
            let newVal = current + amount;
            if (newVal > gold) newVal = gold;
            input.value = newVal;
            updateSubmitBtn();
        }

        function betAll() {
            playSound('snd-click');
            const input = document.getElementById('bet-input');
            const gold = window.AppState.data.user.gold || 0;
            input.value = gold;
            updateSubmitBtn();
        }

        async function submitChallenge() {
            if (!selectedOpponentId || !selectedTaskType) return;

            const betInput = document.getElementById('bet-input');
            const betAmount = parseInt(betInput.value) || 0;
            const gold = window.AppState.data.user.gold || 0;

            if (betAmount > gold) {
                window.showFamilyQuestAlert("H·∫øt v√†ng r·ªìi!", "B√© kh√¥ng ƒë·ªß v√†ng ƒë·ªÉ ƒë·∫∑t c∆∞·ª£c m·ª©c n√†y. H√£y t√≠ch l≈©y th√™m nh√©!", "error");
                return;
            }

            const titleInput = document.getElementById('task-title-input');
            const descInput = document.getElementById('task-desc-input');
            const titleValue = titleInput.value.trim();
            const descValue = descInput.value.trim();
            const finalTaskType = descValue ? `${titleValue} | M√¥ t·∫£: ${descValue} ` : titleValue;

            const opponent = window.AppState.data.leaderboard.find(p => p.id === selectedOpponentId);
            const waitModal = document.getElementById('waiting-modal');
            const countdownEl = document.getElementById('countdown-timer');
            const avatarEl = document.getElementById('waiting-opponent-avatar');
            const nameEl = document.getElementById('waiting-opponent-name');

            avatarEl.src = opponent.avatar;
            nameEl.textContent = opponent.name.replace(' (Bot)', '');

            // 1. Close input modal
            closeChallengeModal();

            // 2. Show waiting modal
            waitModal.classList.remove('opacity-0', 'pointer-events-none');

            // 3. Start Visual Countdown (6-10s)
            const dramaticWaitTime = 6000 + Math.floor(Math.random() * 4000);
            let displayCount = Math.ceil(dramaticWaitTime / 1000);
            countdownEl.textContent = displayCount;

            const countdownPromise = new Promise(resolve => {
                const interval = setInterval(() => {
                    displayCount--;
                    countdownEl.textContent = Math.max(0, displayCount);
                    if (displayCount <= 0) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 1000);
            });

            // Wait for the countdown to finish FIRST
            await countdownPromise;

            // 4. Decide REJECTION (20% chance as requested)
            const isDeclined = Math.random() < 0.20;

            try {
                if (isDeclined) {
                    openDeclineModal(opponent.avatar, opponent.name);
                } else {
                    // 5. Only now we call the API to "officially" start
                    const result = await window.AppState.createChallenge(selectedOpponentId, finalTaskType, betAmount);

                    if (result && result.error) {
                        if (result.error === 'LIMIT_REACHED') {
                            window.showFamilyQuestAlert("H·∫øt l∆∞·ª£t r·ªìi!", "Con ƒë√£ h·∫øt 3 l∆∞·ª£t ch·ªß ƒë·ªông th√°ch ƒë·∫•u h√¥m nay r·ªìi.", "warning");
                        } else if (result.error === 'OPPONENT_LIMIT_REACHED') {
                            window.showFamilyQuestAlert("Chi·∫øn binh b·∫≠n!", "B·∫°n n√†y h√¥m nay ƒë√£ nh·∫≠n ƒë·ªß l·ªùi th√°ch ƒë·∫•u r·ªìi, h√£y ch·ªçn b·∫°n kh√°c nh√©!", "info");
                        }
                    } else {
                        // Success!
                        playSound('snd-click');
                    }
                }
            } catch (err) {
                console.error("L·ªói k·ªãch b·∫£n th√°ch ƒë·∫•u:", err);
            } finally {
                waitModal.classList.add('opacity-0', 'pointer-events-none');

                // Clear state
                titleInput.value = '';
                descInput.value = '';
                document.getElementById('task-setup-container').classList.add('hidden');
                selectedOpponentId = null;
                selectedTaskType = null;
            }
        }

        async function selfComplete(challengeId) {
            playSound('snd-click');
            await window.AppState.selfCompleteChallenge(challengeId);
        }

        let lastOpponentHash = "";
        async function renderOpponentList(inputData) {
            try {
                const list = document.getElementById('opponent-list');
                if (!list) return;

                const data = (inputData && inputData.leaderboard && inputData.leaderboard.length > 1) ? inputData : window.AppState.data;
                const currentUserId = data.user && String(data.user.id);
                const leaderboard = data.leaderboard || [];
                const challenges = data.challenges || [];

                // Simple hash based on users and challenge counts to avoid excessive re-renders
                const currentHash = `${leaderboard.length}-${challenges.length}`;
                if (currentHash === lastOpponentHash) return;
                lastOpponentHash = currentHash;

                // L·∫•y t·∫•t c·∫£ tr·ª´ ba m·∫π v√† ch√≠nh m√¨nh
                const others = leaderboard.filter(p => {
                    if (!p || !p.id) return false;
                    const pid = String(p.id);
                    // L·ªçc: Kh√¥ng ph·∫£i ch√≠nh m√¨nh v√† kh√¥ng ph·∫£i ph·ª• huynh
                    return pid !== currentUserId && p.role !== 'parent';
                });

                if (others.length === 0) {
                    // N·∫øu v·∫´n tr·ªëng, th·ª≠ y√™u c·∫ßu sync m·ªôt l·∫ßn n·ªØa (silent sync)
                    if (!this._lastSyncAttempt || Date.now() - this._lastSyncAttempt > 5000) {
                        this._lastSyncAttempt = Date.now();
                        window.AppState.syncFromDatabase().then(() => {
                            if (window.AppState.data.leaderboard && window.AppState.data.leaderboard.length > 1) {
                                renderOpponentList(window.AppState.data);
                            }
                        });
                    }

                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center w-full py-6 opacity-40 animate-pulse">
                            <span class="material-symbols-outlined text-4xl mb-2 text-primary">search</span>
                            <p class="text-[9px] font-black uppercase tracking-widest text-center">ƒêang n·∫°p danh s√°ch v√µ sƒ©...</p>
                        </div>
                    `;
                    return;
                }

                const now = new Date();
                const startOfWeek = new Date(now.setDate(now.getDate() - (now.getDay() + 6) % 7));
                startOfWeek.setHours(0, 0, 0, 0);

                list.innerHTML = others.map(p => {
                    const pid = String(p.id);
                    const matches = challenges.filter(c =>
                        c.status === 'completed' &&
                        (String(c.challengerId) === pid || String(c.opponentId) === pid) &&
                        c.date && new Date(c.date) >= startOfWeek
                    );
                    const wins = matches.filter(c => c.winnerId && String(c.winnerId) === pid).length;
                    const draws = matches.filter(c => c.winnerId === null).length;
                    const losses = matches.length - wins - draws;

                    const name = (p.name || "V√µ sƒ©").replace(' (Bot)', '');
                    const avatar = p.avatar || "../shared/assets/generated_avatars/avatar_1.png";

                    return `
                    <button onclick="selectOpponent('${p.id}', this)" class="opponent-btn flex flex-col items-center gap-3 p-4 rounded-[2rem] border-2 border-slate-100 dark:border-white/5 transition-all hover:border-primary relative overflow-hidden group shrink-0 w-28 snap-center bg-white dark:bg-slate-900/50 shadow-sm">
                        <div class="relative">
                            <img src="${avatar}" class="w-14 h-14 rounded-full border-2 border-slate-100 dark:border-white/10 shadow-sm group-hover:scale-110 transition-transform">
                            <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-primary/10 border-2 border-white dark:border-slate-800 rounded-full flex items-center justify-center">
                                <span class="text-[8px] font-black text-primary">Lv.${p.level || 1}</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-center min-w-0 w-full">
                            <span class="text-[10px] font-black text-center truncate w-full text-slate-800 dark:text-white uppercase tracking-tighter">${name}</span>
                            <div class="flex gap-2 mt-1.5 opacity-60">
                                <span class="text-[7px] font-black text-emerald-500">${wins}W</span>
                                <span class="text-[7px] font-black text-blue-400">${draws}D</span>
                                <span class="text-[7px] font-black text-rose-400">${losses}L</span>
                            </div>
                        </div>
                    </button>`;
                }).join('');

            } catch (err) {
                console.error("Render error:", err);
                const list = document.getElementById('opponent-list');
                if (list) list.innerHTML = `<div class="p-4 text-rose-500 text-[10px] font-bold">L·ªói n·∫°p d·ªØ li·ªáu: ${err.message}</div>`;
            }
        }
    </script>
</body>

</html>